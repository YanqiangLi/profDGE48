<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>generic_wrapper &mdash; Profiling DGE with 48 replicates 3.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Profiling DGE with 48 replicates 3.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Profiling DGE with 48 replicates 3.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for generic_wrapper</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">***************************************************************************</span>
<span class="sd">The Great RNA-Seq Experiment Differential Expression Tool Bootstrap Wrapper</span>
<span class="sd">***************************************************************************</span>

<span class="sd">This file is a generic wrapper for running multiple bootstraps of</span>
<span class="sd">`R &lt;https://www.r-project.org/&gt;`_ Differential Expression (DE) algorithms.</span>
<span class="sd">Its written for</span>
<span class="sd">`python 2.6.4 &lt;https://www.python.org/download/releases/2.6.4/&gt;`_,</span>
<span class="sd">`R 2.15.1 &lt;https://cran.r-project.org/src/base/R-2/R-2.15.1.tar.gz&gt;`_ and</span>
<span class="sd">`bioconductor 2.11 &lt;http://www.bioconductor.org/news/bioc_2_11_release/&gt;`_.</span>

<span class="sd">This script interfaces with a suite of</span>
<span class="sd">`Rscript &lt;https://stat.ethz.ch/R-manual/R-devel/library/utils/html/Rscript.html&gt;`_</span>
<span class="sd">scripts - :ref:`one for each tool &lt;DEtools&gt;` - through a set of common input</span>
<span class="sd">parameters. This allows it to run each tool in a well-defined, consistent,</span>
<span class="sd">fashion for multiple random selections of the biological replicates in the</span>
<span class="sd">experiment. The script exposes the results through a standard `sqlite</span>
<span class="sd">&lt;https://www.sqlite.org/&gt;`_ database structure.</span>

<span class="sd">The idea of having a general wrapper for all the algorithms is to allow</span>
<span class="sd">us to run each of the DE algorithms in a consistent fashion, directly from the</span>
<span class="sd">the command line, and keep a careful track of exactly what tools were used at</span>
<span class="sd">every stage to get from the read data to the DE results.</span>

<span class="sd">The wrapper takes in a directory structure containing either:</span>

<span class="sd">  * bam files that are the result of aligning raw fastq&#39;s to a genome.</span>
<span class="sd">  * pre-generated (possibly from a previous run of this script!) `htseq-count</span>
<span class="sd">    &lt;http://www-huber.embl.de/users/anders/HTSeq/doc/count.html&gt;`_ output files.</span>

<span class="sd">This structure also defines the experimental conditions. If the input is a set</span>
<span class="sd">of bam files, it also requires a gtf/gff annotation file. It also requires</span>
<span class="sd">an output filename and log filename. The script is SGE cluster aware through the</span>
<span class="sd">`python drmaa library &lt;http://code.google.com/p/drmaa-python/&gt;`_ but can also</span>
<span class="sd">be run stand-alone. It takes a significant amount of time to process lots of</span>
<span class="sd">files and bootstraps though, so a cluster is recommended.</span>

<span class="sd">.. moduleauthor:: Nick Schurch &lt;nschurch@dundee.ac.uk&gt;</span>

<span class="sd">:version: 3.0</span>

<span class="sd">========</span>
<span class="sd">Overview</span>
<span class="sd">========</span>

<span class="sd">This section provides a gross overview of the operation of the</span>
<span class="sd">*generic_wrapper.py* script.</span>

<span class="sd">    1.  Parse command line arguments.</span>
<span class="sd">    2.  Gather script and program version information and relevant environmental</span>
<span class="sd">        variables and write these to the log file.</span>
<span class="sd">    3.  Parse experiment structure and get replicate file information.</span>
<span class="sd">    4.  Calculate or read in the gene readcounts. If the counts need to be</span>
<span class="sd">        generated from the bam files, the script uses the *perl* script</span>
<span class="sd">        :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;` which uses `htseq-count</span>
<span class="sd">        &lt;http://www-huber.embl.de/users/anders/HTSeq/doc/count.html&gt;`_ to</span>
<span class="sd">        aggregate the readcounts for each gene. If pre-generated counts are</span>
<span class="sd">        being used they are just read directly from the files.</span>
<span class="sd">    5.  Aggregate all the replicate gene expression data into a single matrix</span>
<span class="sd">        and begin the bootstrapping process.</span>
<span class="sd">    6.  For each bootstrap, if required, calculate total count normalization</span>
<span class="sd">        factors and normalize the data. This total read count for the</span>
<span class="sd">        replicates selected in the bootstrap iteration is calculated by a</span>
<span class="sd">        cluster-aware routine that calls `samtools</span>
<span class="sd">        &lt;http://samtools.sourceforge.net/&gt;`_ with the *flagstat* option, and</span>
<span class="sd">        parses the output. **Note:** we don&#39;t use this for the, calculations</span>
<span class="sd">        in :ref:`Schurch et. al. (2015) &lt;paper2&gt;`. There we use the default</span>
<span class="sd">        normalization method for each tool to run the DE analysis. These</span>
<span class="sd">        normalizations are aplied individually as part of :ref:`each tools</span>
<span class="sd">        Rscript &lt;DEtools&gt;`.</span>
<span class="sd">    7.  Write the (normalized) data to a file that is straightforward for R to</span>
<span class="sd">        read, and write the experiment structure to a file for R too!</span>
<span class="sd">    8.  Run the specified R script that loads the expression data, performs</span>
<span class="sd">        internal tool-specific normalization (if required), then runs the</span>
<span class="sd">        DE tools on the data and finally the writes the results to a sensible</span>
<span class="sd">        format file. Help for each of R scripts, including some background for</span>
<span class="sd">        each DE algorithm (should) be accessible in the `Differential</span>
<span class="sd">        Expression Algorithms &lt;DEtools&gt;`_ section.</span>
<span class="sd">    9.  Read and annotate the DE expression results with gene information from</span>
<span class="sd">        `ensembl &lt;http://www.ensembl.org/index.html&gt;`_ using the *perl* script</span>
<span class="sd">        :ref:`add_gene_name_column.pl &lt;add_gene_name_column_perldoc&gt;` to get</span>
<span class="sd">        the relevant annotation information via the *ensembl perl* API.</span>
<span class="sd">    10. Store the results in a `sqlite &lt;https://www.sqlite.org/&gt;`_ database</span>
<span class="sd">        file with a standardized structure and cleanup the temporary directory</span>
<span class="sd">        specified with *--tmpdir*.</span>

<span class="sd">======================</span>
<span class="sd">Command-line Arguments</span>
<span class="sd">======================</span>

<span class="sd">**usage\:**</span>
<span class="sd">    generic_wrapper.pl</span>
<span class="sd">    :option:`-d|--datapath` *&lt;path&gt;*</span>
<span class="sd">    :option:`-a|--annotation` *&lt;file&gt;*</span>
<span class="sd">    :option:`-r|--scriptfile` *&lt;file&gt;*</span>
<span class="sd">    :option:`-o|--outfile` *&lt;file&gt;*</span>
<span class="sd">    :option:`-l|--logfile` *&lt;file&gt;*</span>
<span class="sd">    [:option:`-s|species` *&lt;str&gt;*]</span>
<span class="sd">    [:option: `--precounts`</span>
<span class="sd">    [:option:`-f|--feature` *&lt;str&gt;*]</span>
<span class="sd">    [:option:`-c|--count-method` *&lt;str&gt;*]</span>
<span class="sd">    [:option:`-n|--norm` *&lt;str&gt;*]</span>
<span class="sd">    [:option:`--gbgfile` *&lt;path&gt;&lt;filename&gt;*]</span>
<span class="sd">    [:option:`--agncfile` *&lt;path&gt;&lt;filename&gt;*]</span>
<span class="sd">    [:option:`--Rpath` *&lt;path&gt;*]</span>
<span class="sd">    [:option:`--tmpdir` *&lt;path&gt;*]</span>
<span class="sd">    [:option:`--keep-tmpdir`]</span>
<span class="sd">    [:option:`--nocluster`]</span>
<span class="sd">    [:option:`--clustq` *&lt;str&gt;*]</span>
<span class="sd">    [:option:`--samtoolspath` *&lt;path&gt;*]</span>
<span class="sd">    [:option:`--restart`]</span>
<span class="sd">    [:option:`--verbose`]</span>
<span class="sd">    [:option:`--version`]</span>
<span class="sd">    [:option:`--help`]</span>

<span class="sd">.. gw_required:</span>

<span class="sd">.. _gw_required:</span>

<span class="sd">-------------------</span>
<span class="sd">Required Parameters</span>
<span class="sd">-------------------</span>

<span class="sd">.. option:: -d &lt;path&gt;, --datapath &lt;path&gt;</span>

<span class="sd">    Path to the data directory of the experiment. Each sub-directory in this</span>
<span class="sd">    will be treated as a separate condition in the experiment (with the name</span>
<span class="sd">    of the condition matching the name of the directory). Each .bam file or</span>
<span class="sd">    pre-calculated gene count file (defined by :option:`--precounts`)</span>
<span class="sd">    in each directory is treated as a replicate for that condition. BAM file</span>
<span class="sd">    indexes for each file should have the same filename, with .bai post-pended.</span>

<span class="sd">.. option:: -a &lt;file&gt;, --annotation &lt;file&gt;</span>

<span class="sd">    Path to the `GFF &lt;https://www.sanger.ac.uk/resources/software/gff/&gt;`_</span>
<span class="sd">    feature annotation file for the data. This file should</span>
<span class="sd">    match the features you are counting the RNA-Seq expression for. This is</span>
<span class="sd">    required even if you are using pre-calculated gene count files.</span>

<span class="sd">.. option:: -r &lt;file&gt;, --scriptfile &lt;file&gt;</span>

<span class="sd">    Name and path of Rscript file to execute in order to perform differential</span>
<span class="sd">    gene expression analysis. See :ref:`Differential Expression Algorithms</span>
<span class="sd">    &lt;DEtools&gt;` section for more details and help with each tool.</span>

<span class="sd">.. option:: -o &lt;filename&gt;, --outfile &lt;filename&gt;</span>

<span class="sd">    The name (inc. path if different fromt he current direstory) of the output</span>
<span class="sd">    sqlite file from the wrapper.</span>

<span class="sd">.. option:: -l &lt;filename&gt;, --logfile &lt;filename&gt;</span>

<span class="sd">    The name (inc. path) of the log file from the wrapper.</span>

<span class="sd">------------------</span>
<span class="sd">Annotation options</span>
<span class="sd">------------------</span>

<span class="sd">.. option:: -s &lt;str&gt;, --species &lt;str&gt; (Default: &quot;Saccharomyces cerevisiae&quot;)</span>

<span class="sd">    The species used to generate the RNA-Seq data. This is used by the</span>
<span class="sd">    `ensembl &lt;http://www.ensembl.org/index.html&gt;`_ API to annotate the features</span>
<span class="sd">    found, so it must be a recognizable name format for `ensembl</span>
<span class="sd">    &lt;http://www.ensembl.org/index.html&gt;`_ (`this list</span>
<span class="sd">    &lt;http://www.ensembl.org/info/about/species.html&gt;`_ is probably a good place</span>
<span class="sd">    to start). Strings with spaces in must be in quotes.</span>

<span class="sd">----------------------------</span>
<span class="sd">reads-to-gene-counts options</span>
<span class="sd">----------------------------</span>

<span class="sd">.. option:: --precounts</span>

<span class="sd">    If this option is given the script looks for pre-generated gene count</span>
<span class="sd">    files in :option:`--datapath` The files to look for are defined by the</span>
<span class="sd">    :option:`--precount_fileext` options. If found, the gene counts from these</span>
<span class="sd">    files are used and gene count summarization from .bam files is skipped. If</span>
<span class="sd">    no files of the type are found, the script will look for bam files and</span>
<span class="sd">    will do gene count summarization if they are found.</span>

<span class="sd">    If this option and :option:`--savecounts` are set, and no gene count files</span>
<span class="sd">    are found, gene count summarization from the bam files will be done and the</span>
<span class="sd">    resulting gene count files saved to the path specified by</span>
<span class="sd">    :option:`--datapath`.</span>

<span class="sd">.. option:: --precount_fileext &lt;str&gt; (Default: gbgout)</span>

<span class="sd">    The file extension of pre-generated gene count data to look for.</span>

<span class="sd">.. option:: --savecounts</span>

<span class="sd">    If this option is given and the code summarises gene count information from</span>
<span class="sd">    bam file alignments, the resulting gene count files from running the gene</span>
<span class="sd">    count summarization will be saved to the path specified with</span>
<span class="sd">    :option:`--datapath`.</span>

<span class="sd">.. option:: -f &lt;str&gt;, --feature &lt;str&gt; (Default: gene_id)</span>

<span class="sd">    Sets the level at which you count the RNA-Seq signal. Options are:</span>

<span class="sd">        1. gene_id</span>
<span class="sd">        2. transcript_id</span>

<span class="sd">.. option:: -c &lt;str&gt;, --count-method &lt;str&gt; (Default: union)</span>

<span class="sd">    Choose the method used by `htseq-count</span>
<span class="sd">    &lt;http://www-huber.embl.de/users/anders/HTSeq/doc/count.html&gt;`_ for counting</span>
<span class="sd">    the reads for each feature. Options are:</span>

<span class="sd">        1. union</span>
<span class="sd">        2. istrict</span>
<span class="sd">        3. inoempty</span>

<span class="sd">---------------------</span>
<span class="sd">Normalization options</span>
<span class="sd">---------------------</span>

<span class="sd">.. option:: -n &lt;str&gt;, --norm &lt;str&gt; (Default: none)</span>

<span class="sd">    Normalization method for the tool being wrapped. Options are:</span>

<span class="sd">        1. none</span>
<span class="sd">        2. package:*normtype* - pass normalization control to the Rscript.</span>
<span class="sd">           *normtype* can be any of the possible normalization methods available</span>
<span class="sd">           from the Rscript for the tool.</span>
<span class="sd">        3. pmrm - Force Per Million Reads Mapped normalization.</span>
<span class="sd">        4. deseq - Force deseq-style normalisation.</span>


<span class="sd">-----------------</span>
<span class="sd">Bootstrap options</span>
<span class="sd">-----------------</span>

<span class="sd">.. option:: -k &lt;int&gt;, --kreps &lt;int&gt; (Default: None)</span>

<span class="sd">    The number of replicates to randomly select for each bootstrap. Replicates</span>
<span class="sd">    listed with :option:`--excludelist` are excluded from selection. Replicates</span>
<span class="sd">    listed with :option:`--includelist` are always included in the selection.</span>
<span class="sd">    If this option is *None*, or is a number greater than remaining number of</span>
<span class="sd">    replicates after excluding those specified with :option:`--excludelist`,</span>
<span class="sd">    then all the replicates are used. If this option is a number less than the</span>
<span class="sd">    remaining number of replicates fter excluding those specified with</span>
<span class="sd">    :option:`--excludelist`, then this number of replicates are selected at</span>
<span class="sd">    random for each bootstrap iteration.</span>

<span class="sd">.. option:: -b &lt;int&gt;, --nbootstrap &lt;int&gt; (Default: None)</span>

<span class="sd">    The number of bootstrap iterations to run.</span>

<span class="sd">.. option:: -i &lt;file&gt;, --includelist &lt;file&gt; (Default: None)</span>

<span class="sd">    A filename (including path is different from the current directory) for a</span>
<span class="sd">    text file listing (one per line) the full names of the replicate files</span>
<span class="sd">    to be explicitely included in every bootstrap selection.</span>

<span class="sd">.. option:: -e &lt;file&gt;, --excludelist &lt;file&gt; (Default: None)</span>

<span class="sd">    A filename (including path is different from the current directory) for a</span>
<span class="sd">    text file listing (one per line) the full names of the replicate files</span>
<span class="sd">    to be explicitely excluded from every bootstrap selection. This can be</span>
<span class="sd">    used to specify bad replicates to exclude. An example file is given in</span>
<span class="sd">    :ref:`exclude_badreps.tsv &lt;exclude_badreps_tsvdoc&gt;`.</span>

<span class="sd">-------------------------------------</span>
<span class="sd">External Dependancies and Environment</span>
<span class="sd">-------------------------------------</span>

<span class="sd">.. option:: --gbgfile (Default: ./group_by_gene.pl)</span>

<span class="sd">    The full path to the :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;` script.</span>
<span class="sd">    Called run `htseq-count</span>
<span class="sd">    &lt;http://www-huber.embl.de/users/anders/HTSeq/doc/count.html&gt;`_.</span>

<span class="sd">.. option:: --agncfile (Default: ./add_gene_name_column.pl)</span>

<span class="sd">    The full path to the :ref:`add_gene_name_column.pl</span>
<span class="sd">    &lt;add_gene_name_column_perldoc&gt;` script. Called to annotate the output from</span>
<span class="sd">    :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;`.</span>

<span class="sd">.. option:: --Rpath ((Default: /sw/opt/R/2.15.1/bin/Rscript)</span>

<span class="sd">    Specify the path to the Rscript executable for the R installation to use.</span>

<span class="sd">.. option:: --perlpath (Default: /user/bin/perl)</span>

<span class="sd">    Specify the path to the *perl* executable for the perl installation to use.</span>

<span class="sd">.. option:: --samtoolspath (Default: /local/bin/samtools)</span>

<span class="sd">    Specify the path to the `samtools &lt;http://samtools.sourceforge.net/&gt;`_</span>
<span class="sd">    executable to use.</span>

<span class="sd">---------------</span>
<span class="sd">Cluster options</span>
<span class="sd">---------------</span>

<span class="sd">.. option:: -j &lt;int&gt;, --njobs &lt;int&gt; (Default: 400)</span>

<span class="sd">    The max number of parallel cluster jobs to spawn if :option:`--nocluster`</span>
<span class="sd">    is not set.</span>

<span class="sd">.. option:: --clustq &lt;str&gt; (Default: 64bit-pri.q)</span>

<span class="sd">    Define a specific cluster queue to use to run cluster jobs.</span>

<span class="sd">.. option:: --nocluster</span>

<span class="sd">    If this option is given, the cluster support within the script will be</span>
<span class="sd">    diabled and everything will be run sequentially on the current machine.</span>

<span class="sd">-------------</span>
<span class="sd">Other options</span>
<span class="sd">-------------</span>

<span class="sd">.. option:: --tmpdir &lt;path&gt; (Default: ./.DEtemp)</span>

<span class="sd">    The path of the temporary directory you with to use for storing</span>
<span class="sd">    intermediate files.</span>

<span class="sd">.. option:: --keep-tmpdir</span>

<span class="sd">    If the entire script executes sucessfully the path defined with</span>
<span class="sd">    :option:`--tmpdir` is usually cleaned up. With this option set the</span>
<span class="sd">    cleanup is disabled and the temp directory and files are retained.</span>

<span class="sd">.. option:: --restart</span>

<span class="sd">    Restart a previously failed run. With this option set, this script will</span>
<span class="sd">    attempt to load the previous run settings and any parts of the run that</span>
<span class="sd">    were completed successfully from the *restart.pkl* file storred in</span>
<span class="sd">    the path provided with :option:`--tmpdir`.</span>

<span class="sd">.. option:: --version</span>

<span class="sd">    Show program&#39;s version number and exit.</span>

<span class="sd">.. option:: -v, --verbose</span>

<span class="sd">    Turn on verbose logging.</span>

<span class="sd">.. option:: -h, --help</span>

<span class="sd">    Print a basic description of the tool and its options to STDOUT.</span>

<span class="sd">----------------------------------------------------------</span>
<span class="sd">Internally-Passed options - **DO NOT SET THESE MANUALLY**</span>
<span class="sd">----------------------------------------------------------</span>

<span class="sd">.. option:: --bootstrapmaster</span>

<span class="sd">    Defines this as a master script that initiates bootstrap runs. This option</span>
<span class="sd">    should never be set manually. It is set internally to control spawned</span>
<span class="sd">    bootstrap cluster runs of this script.</span>

<span class="sd">.. option:: --bootstrapslave</span>

<span class="sd">    Defines this as a slave bootstrap run belonging to a set initiated by a</span>
<span class="sd">    :option:`--bootstrapmaster`. This option should never be set manually. It</span>
<span class="sd">    is set internally to control spawned bootstrap cluster runs of this script.</span>

<span class="sd">.. genwrapout:</span>

<span class="sd">.. _genwrapout:</span>

<span class="sd">======</span>
<span class="sd">Output</span>
<span class="sd">======</span>

<span class="sd">The output from a sucessful run of this script is a single `sqlite</span>
<span class="sd">&lt;https://www.sqlite.org/&gt;`_ database file with the following structure:</span>

<span class="sd">    * **Table:** *features* - features the DE is calculated for.</span>

<span class="sd">        Col: *id*</span>

<span class="sd">        Col: *featureID*</span>

<span class="sd">        Col: *name*</span>

<span class="sd">        Col: *desc*</span>

<span class="sd">    * **Table:** *bslogs* - the output logs from each of the bootstrap runs.</span>

<span class="sd">        Col: *id*</span>

<span class="sd">        Col: *log*</span>

<span class="sd">    * **Table:** *bootstraps* - details of the bootstraps performed.</span>

<span class="sd">        Col: *id*</span>

<span class="sd">        Col: *bsinlogid*</span>

<span class="sd">        Col: *comments*</span>

<span class="sd">        Col: *deruntime_sec*</span>

<span class="sd">        Col: *logid* - Foreign Key to *bslogs.id*</span>

<span class="sd">    * **Table:** *DEresults* - this table contains a column for each column of</span>
<span class="sd">      data output by the tool. To the best of our ability these results are</span>
<span class="sd">      output from the tools Rscript with a defined, consistent, set of columns.</span>
<span class="sd">      For the data presented in :ref:`Schurch et. al. (2015) &lt;paper2&gt;` this</span>
<span class="sd">      results in the columns described here:</span>

<span class="sd">        Col: *id*</span>

<span class="sd">        Col: *featureid* - Foreign Key to *features.id*</span>

<span class="sd">        Col: *bsid* - Foreign Key to *bootstraps.id*</span>

<span class="sd">        Col: *log2foldchange*</span>

<span class="sd">        Col: *significance*</span>

<span class="sd">        Col: *Snf2*</span>

<span class="sd">        Col: *WT*</span>

<span class="sd">These database files are then used by other scripts here to analyse and plot</span>
<span class="sd">the bootstrap results.</span>

<span class="sd">====================</span>
<span class="sd">Example Command-line</span>
<span class="sd">====================</span>

<span class="sd">This is an example command line used for testing. It runs :ref:`limma</span>
<span class="sd">&lt;limma_Rdoc&gt;` on a set of data for the ensembl 68 Saccharomyces cerevisiae</span>
<span class="sd">annotation, keeping all temp files, in verbose mode without using a cluster</span>
<span class="sd">looking for pre-generateded counts (saving them if they are have to be</span>
<span class="sd">calculated by the script from .bam files)::</span>

<span class="sd">    ./generic_wrapper.py -d testdata -a ../Annotations/Saccharomyces_cerevisiae.EF4.68.gtf</span>
<span class="sd">    -r limma.R --keep-tmpdir -v --gbgfile group_by_gene.pl --agncfile add_gene_name_column.pl</span>
<span class="sd">    -o test01.db -l test01.log --tmpdir testTMP --samtoolspath /sw/opt/samtools-0.1.18/samtools</span>
<span class="sd">    --precounts --nocluster --savecounts</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="c"># IF YOU ADD AN IMPORT HERE, MAKE SURE YOU ADD IT TO THE &#39;imported_modules&#39;</span>
<span class="c">#LIST OR IT WON&#39;T GET INCLUDED IN VERBOSE LOGGING OUTPUT!</span>
<span class="n">imported_modules</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;os&quot;</span><span class="p">,</span> <span class="s">&quot;sys&quot;</span><span class="p">,</span> <span class="s">&quot;re&quot;</span><span class="p">,</span> <span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="s">&quot;warnings&quot;</span><span class="p">,</span> <span class="s">&quot;cPickle&quot;</span><span class="p">,</span>
                    <span class="s">&quot;gzip&quot;</span><span class="p">,</span> <span class="s">&quot;numpy&quot;</span><span class="p">,</span> <span class="s">&quot;scipy&quot;</span><span class="p">,</span> <span class="s">&quot;textwrap&quot;</span><span class="p">,</span> <span class="s">&quot;optparse&quot;</span><span class="p">,</span>
                    <span class="s">&quot;subprocess&quot;</span><span class="p">,</span> <span class="s">&quot;drmaa&quot;</span><span class="p">,</span> <span class="s">&quot;math&quot;</span><span class="p">,</span> <span class="s">&quot;sqlite3&quot;</span><span class="p">,</span> <span class="s">&quot;shutil&quot;</span><span class="p">]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">cPickle</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">scipy</span>
    <span class="kn">import</span> <span class="nn">textwrap</span><span class="o">,</span> <span class="nn">optparse</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">drmaa</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">tempfile</span>
    <span class="kn">from</span> <span class="nn">numpy.lib.recfunctions</span> <span class="kn">import</span> <span class="n">append_fields</span><span class="p">,</span> <span class="n">rename_fields</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span><span class="p">,</span> <span class="n">OptionGroup</span>
    <span class="kn">from</span> <span class="nn">pysqlite2</span> <span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">sqlite3</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mstats</span> <span class="k">as</span> <span class="n">mst</span>
    <span class="kn">from</span> <span class="nn">Modules.housekeeping</span> <span class="kn">import</span> <span class="n">custom_formatwarning</span>
    <span class="kn">from</span> <span class="nn">Modules.housekeeping</span> <span class="kn">import</span> <span class="n">parse_required_options</span>
    <span class="kn">from</span> <span class="nn">Modules.housekeeping</span> <span class="kn">import</span> <span class="n">parse_allowed_values</span>
    <span class="kn">from</span> <span class="nn">Modules.housekeeping</span> <span class="kn">import</span> <span class="n">parse_option_type</span>
    <span class="kn">from</span> <span class="nn">Modules.housekeeping</span> <span class="kn">import</span> <span class="n">timeStr</span><span class="p">,</span> <span class="n">createNewTempdir</span>
    <span class="kn">from</span> <span class="nn">Modules.housekeeping</span> <span class="kn">import</span> <span class="n">write_log_header</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Generic Wrapper.py: Something went wrong when importing the &quot;</span> \
          <span class="s">&quot;required modules. It&#39;s probably something to do with you not &quot;</span> \
          <span class="s">&quot;having the right bits in your PYTHONPATH environmental variable.</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">print</span> <span class="s">&quot;Please make sure the path to the root of the checkout of in your &quot;</span> \
          <span class="s">&quot;PYTHONPATH environmental variable.</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">print</span> <span class="s">&quot;If you&#39;re in Dundee, make sure you have path to the Modules &quot;</span> \
          <span class="s">&quot;directory and /sw/lib/python2.6/site-packages in your PYTHONPATH. &quot;</span> \
          <span class="s">&quot;Otherwise, please make sure your PYTHONPATH includes locations&quot;</span> \
          <span class="s">&quot;for the following modules:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imported_modules</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Your PYTHONPATH is:&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">raise</span>

<span class="n">version_string</span><span class="o">=</span><span class="s">&quot;3.0&quot;</span>

<span class="c"># force sequential output to the screen, rather than buffered output.</span>
<span class="k">def</span> <span class="nf">printf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c"># override warning messages with a custom format</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span> <span class="o">=</span> <span class="n">custom_formatwarning</span>

<div class="viewcode-block" id="rep_subselect"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.rep_subselect">[docs]</a><span class="k">def</span> <span class="nf">rep_subselect</span><span class="p">(</span><span class="n">experiment_structure</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; subselects replicates from the full filename list</span>

<span class="sd">    :param dict experiment_structure: dictionary describing the directory, and</span>
<span class="sd">                                      hence the experiment, structure.</span>

<span class="sd">    :param list include: list of files to include in the subselection</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :param data: a :py:class:`numpy.ndarray` structured array instance output</span>
<span class="sd">                 from :func:`read_expression_data`.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * a new experiemnt structure with just the selected replicates in</span>
<span class="sd">        * a new replicate file list</span>
<span class="sd">        * either *None* or, if data has been provided, a new subset of data for</span>
<span class="sd">          just the selected replicates.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *kreps* - number of replicates to select for each botostrap iteration.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>

<span class="sd">    Forces the inclusion of replicate filenames given in *include*. Called by</span>
<span class="sd">    :func:`parse_experiment_data`.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: subselecting replicates...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

    <span class="n">sub_experiment_structure</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">sub_replicate_file_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sub_replicate_filename_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">experiment_structure</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiment_structure</span><span class="p">[</span><span class="n">condition</span><span class="p">])</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kreps</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Warning: Fewer replicates available in &quot;</span> \
                      <span class="s">&quot;condition </span><span class="si">%s</span><span class="s"> than requested in the --kreps option &quot;</span> \
                      <span class="s">&quot;(</span><span class="si">%i</span><span class="s">). Returning all possible replicates.&quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                            <span class="n">condition</span><span class="p">,</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kreps</span><span class="p">)</span>
                            <span class="p">)</span>
                      <span class="p">)</span>
            <span class="n">sub_experiment_structure</span> <span class="o">=</span> <span class="n">experiment_structure</span>
            <span class="n">sub_replicate_file_list</span> <span class="o">=</span> <span class="n">experiment_structure</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># first include all possible replicates that are in the include</span>
            <span class="c"># list for this replicate</span>
            <span class="n">these_increps</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">other_reps</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">experiment_structure</span><span class="p">[</span><span class="n">condition</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">include</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
                    <span class="n">these_increps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_reps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>

            <span class="c"># check to see if we need to add more reps to this list</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">these_increps</span><span class="p">)</span><span class="o">&gt;</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kreps</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Warning: condition </span><span class="si">%s</span><span class="s"> contains more &quot;</span> \
                          <span class="s">&quot;replicates specified in the include list &quot;</span> \
                          <span class="s">&quot;than the number requested in --kreps (</span><span class="si">%i</span><span class="s">). &quot;</span> \
                          <span class="s">&quot;Using all include replicates.&quot;</span> \
                          <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                <span class="n">condition</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kreps</span><span class="p">)</span>
                                <span class="p">)</span>
                          <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">these_increps</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kreps</span><span class="p">):</span>
                <span class="c"># randomly select additional repplicates</span>
                <span class="n">other_reps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">other_reps</span><span class="p">)</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">other_reps</span><span class="p">)</span>
                <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">imax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kreps</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">these_increps</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">imax</span><span class="p">:</span>
                    <span class="n">thisfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">other_reps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">thisfile</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_replicate_filename_list</span><span class="p">:</span>
                        <span class="n">these_increps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other_reps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">sub_replicate_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other_reps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">sub_replicate_filename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisfile</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">imax</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">imax</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">other_reps</span><span class="p">):</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Warning: conditions contain &quot;</span> \
                                  <span class="s">&quot;the same replicates (or, at least, &quot;</span> \
                                  <span class="s">&quot;replicates with identical filenames) and &quot;</span> \
                                  <span class="s">&quot;there are not enough unique replicates to &quot;</span> \
                                  <span class="s">&quot;fill both conditions requested with &quot;</span> \
                                  <span class="s">&quot;--kreps (</span><span class="si">%i</span><span class="s">)&quot;</span> \
                                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kreps</span><span class="p">))</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

            <span class="n">sub_experiment_structure</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">=</span><span class="n">these_increps</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sub_experiment_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="si">%s</span><span class="s">: selected </span><span class="si">%i</span><span class="s"> replicates...&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_experiment_structure</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sub_experiment_structure</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">)))</span>

    <span class="c"># subselect the expression data if provided</span>
    <span class="n">sub_data</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: subselecting data...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">()))</span>
        <span class="n">replicate_index</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">data_replicate</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">data_replicate_bam</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;\.gbgout_rawReads&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">data_replicate</span><span class="p">)</span>
            <span class="n">matched</span><span class="o">=</span><span class="bp">False</span>
            <span class="k">for</span> <span class="n">file_replicate</span> <span class="ow">in</span> <span class="n">sub_replicate_file_list</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.+</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">data_replicate_bam</span><span class="p">,</span> <span class="n">file_replicate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">matched</span><span class="o">=</span><span class="bp">True</span>
                    <span class="k">break</span>
            <span class="n">replicate_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span>

        <span class="n">sub_exprs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">replicate_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">sub_colids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">replicate_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">sub_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_exprs</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sub_colids</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sub_experiment_structure</span><span class="p">,</span> <span class="n">sub_replicate_file_list</span><span class="p">,</span> <span class="n">sub_data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="runStructure"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.runStructure">[docs]</a><span class="k">def</span> <span class="nf">runStructure</span><span class="p">(</span><span class="n">fileext</span><span class="p">,</span> <span class="n">included</span><span class="p">,</span> <span class="n">excluded</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Parse the path for files &amp; directory structure</span>

<span class="sd">    :param str fileext: extension of the files to look for</span>

<span class="sd">    :param list excluded: list of filenames to exclude</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * the experiment structure</span>
<span class="sd">        * a replicate file list</span>
<span class="sd">        * the list of forced included replicates</span>

<span class="sd">    The *options* instance must contain the *datapath* keyword giving the</span>
<span class="sd">    path to parse for data files to parse. The script walks the path</span>
<span class="sd">    characterising the directory structure and identifying files with a</span>
<span class="sd">    matching extension. It automatically excludes any files it finds that</span>
<span class="sd">    are on the *excluded* list. Called by :func:`parse_experiment_data`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">datapath_contents</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">)</span>

    <span class="n">experiment_structure</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">replicate_file_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">included_reps</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">excluded_reps</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">datapath_contents</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span><span class="n">thing</span><span class="p">)):</span>
            <span class="n">condition_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span><span class="n">thing</span><span class="p">))</span>
            <span class="n">replicates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">condition_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.+\.</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">fileext</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
                    <span class="n">file_fullpath</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span><span class="n">thing</span><span class="p">,</span><span class="nb">file</span><span class="p">)</span>
                    <span class="n">poss_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">file</span><span class="p">,</span> <span class="n">file_fullpath</span><span class="p">,</span>
                                      <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;.gbgout&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="nb">file</span><span class="p">),</span>
                                      <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;.gbgout&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">file_fullpath</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">poss_filenames</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">excluded</span><span class="p">)))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">replicates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span>
                                                        <span class="n">thing</span><span class="p">,</span>
                                                        <span class="nb">file</span>
                                                        <span class="p">)</span>
                                          <span class="p">)</span>
                        <span class="n">replicate_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> \
                                                   <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span>
                                                         <span class="n">thing</span><span class="p">,</span>
                                                         <span class="nb">file</span>
                                                         <span class="p">)</span>
                                                   <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">excluded_reps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_fullpath</span><span class="p">)</span>

            <span class="c"># mark files if they are in the includelist</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">included</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">replicates</span><span class="p">:</span>
                    <span class="n">base_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">base_file</span> <span class="ow">in</span> <span class="n">included</span><span class="p">:</span>
                        <span class="n">included_reps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_file</span><span class="p">)</span>

            <span class="n">experiment_structure</span><span class="p">[</span><span class="n">thing</span><span class="p">]</span><span class="o">=</span><span class="n">replicates</span>

    <span class="k">return</span><span class="p">(</span><span class="n">experiment_structure</span><span class="p">,</span> <span class="n">replicate_file_list</span><span class="p">,</span> <span class="n">included_reps</span><span class="p">,</span> <span class="n">excluded_reps</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="parse_experiment_data"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.parse_experiment_data">[docs]</a><span class="k">def</span> <span class="nf">parse_experiment_data</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Gets condition and replicate information from the directory structure</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * a dictionary describing the experiment structure.</span>
<span class="sd">        * a list of all the replicates int eh experiemnt.</span>
<span class="sd">        * the list of forced included replicates.</span>
<span class="sd">        * a flag indicating whether or not to run gene count summarization</span>
<span class="sd">          on the files.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *datapath* - path of the data files to parse</span>
<span class="sd">        * *precounts* - toggle whether to look for pre-generated gene count</span>
<span class="sd">          files or use bam files.</span>
<span class="sd">        * *precount_fileext* - extension of pre-generated gene count files to</span>
<span class="sd">          look for.</span>
<span class="sd">        * *kreps* - number of replicates to select for each botostrap iteration.</span>
<span class="sd">        * *nbootstrap* - the number of bootstrap iterations to run.</span>
<span class="sd">        * *inc_reps* - text file containing a list (one per line) of the</span>
<span class="sd">          replicates that must be included in every bootstrap iteration.</span>
<span class="sd">        * *exc_reps* - text file containing a list (one per line) of the</span>
<span class="sd">          replicates that must be excluded from all bootstrap iterations.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    This subroutine forces the inclusion of files in the *options.inc_reps*</span>
<span class="sd">    file and excludes replicates on the *options.exc_reps*. If</span>
<span class="sd">    *options.nbootstrap* is none, but *options.kreps* is an integer,</span>
<span class="sd">    it will select *options.kreps* replicates once from the full list returned</span>
<span class="sd">    as *all_replicates*.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">include</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">exclude</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">inc_reps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Parsing include list </span><span class="si">%s</span><span class="s">... &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                          <span class="n">options</span><span class="o">.</span><span class="n">inc_reps</span><span class="p">))</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">inc_reps</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">filedata</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filedata</span><span class="p">:</span>
            <span class="n">include</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">exc_reps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Parsing exclude list </span><span class="si">%s</span><span class="s">... &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                          <span class="n">options</span><span class="o">.</span><span class="n">exc_reps</span><span class="p">))</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">exc_reps</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">filedata</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filedata</span><span class="p">:</span>
            <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="n">do_genecounts</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">datafile_ext</span> <span class="o">=</span> <span class="s">&quot;bam&quot;</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">precounts</span><span class="p">:</span>
        <span class="n">do_genecounts</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">datafile_ext</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">precount_fileext</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Parsing </span><span class="si">%s</span><span class="s"> structure looking for .</span><span class="si">%s</span><span class="s"> files... &quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">datafile_ext</span><span class="p">))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">runStructure</span><span class="p">(</span><span class="n">datafile_ext</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="n">experiment_structure</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">replicate_file_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">included_reps</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">excluded_reps</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c"># default to bam files if no matching pre-generated files are found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">replicate_file_list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">datafile_ext</span><span class="o">==</span><span class="s">&quot;bam&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;No appropriate datafiles found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: No .</span><span class="si">%s</span><span class="s"> files found, trying .bam files... &quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">datafile_ext</span><span class="p">))</span>
            <span class="n">do_genecounts</span><span class="o">=</span><span class="bp">True</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">runStructure</span><span class="p">(</span><span class="s">&quot;bam&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="n">experiment_structure</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">replicate_file_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">included_reps</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">excluded_reps</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">replicate_file_list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;No appropriate datafiles found.&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;found </span><span class="si">%i</span><span class="s"> conditions:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiment_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="n">all_files</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">experiment_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s">: found </span><span class="si">%i</span><span class="s"> replicates...</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiment_structure</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">experiment_structure</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
                <span class="n">all_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Warning: the specified conditions contain &quot;</span> \
                      <span class="s">&quot;replicates with identical filenames. Unless you are &quot;</span> \
                      <span class="s">&quot;explicitely testing tool false positive rates (FPRs), &quot;</span> \
                      <span class="s">&quot;this is not a good thing!! Unless you are testing &quot;</span> \
                      <span class="s">&quot;FPRs, please rename the files in your conditions and &quot;</span> \
                      <span class="s">&quot;ensure that the filenames are totally unique.&quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c"># check all include files are found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">include</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">included_reps</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">include</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Error: Not all the replicates specified in the &quot;</span> \
                      <span class="s">&quot;include list can be found in the directory structure.&quot;</span> \
                      <span class="s">&quot;Either one or more of the specified files don&#39;t exist,&quot;</span> \
                      <span class="s">&quot; or one or more files occur in both the exclude and &quot;</span> \
                      <span class="s">&quot;include lists.</span><span class="se">\n\t</span><span class="s">File</span><span class="se">\t</span><span class="s">Found?</span><span class="se">\n\t</span><span class="s">====</span><span class="se">\t</span><span class="s">======</span><span class="se">\n</span><span class="s">&quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="s">&quot;no&quot;</span>
                <span class="k">if</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">included_reps</span><span class="p">:</span>
                    <span class="n">found</span><span class="o">=</span><span class="s">&quot;yes&quot;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">found</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Excluded reps:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exrep</span> <span class="ow">in</span> <span class="n">excluded_reps</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">exrep</span><span class="p">)</span>
    
    <span class="c"># subselect kreps from each condition, if nbootstrap is None</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">kreps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">rep_subselect</span><span class="p">(</span><span class="n">experiment_structure</span><span class="p">,</span>
                                  <span class="n">include</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">experiment_structure</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">replicate_file_list</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">experiment_structure</span><span class="p">,</span> <span class="n">replicate_file_list</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">do_genecounts</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="run_gbg_cluster"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.run_gbg_cluster">[docs]</a><span class="k">def</span> <span class="nf">run_gbg_cluster</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Instance a cluster run of gene count summarization for a bam file</span>

<span class="sd">    :param c_session: a :py:class:drmaa.Session: instance for interacting with</span>
<span class="sd">                      the cluster.</span>

<span class="sd">    :param str bam_file: the filename of the bam to summarise</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * the job ID number of the cluster job</span>
<span class="sd">        * the name of the file containing the resulting gene count summarization</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *feature_annot* - the path to the `gff</span>
<span class="sd">          &lt;https://www.sanger.ac.uk/resources/software/gff/&gt;`_ file to use for</span>
<span class="sd">          gene summarization.</span>
<span class="sd">        * *cmeth* - the method for `htseq-count</span>
<span class="sd">          &lt;http://www-huber.embl.de/users/anders/HTSeq/doc/count.html&gt;`_ to use</span>
<span class="sd">          to summarize the read coutn data.</span>
<span class="sd">        * *feature* - the feature type in the annotation to summarise the read</span>
<span class="sd">          count data for.</span>
<span class="sd">        * *gbgpath* - the path to the :ref:`group_by_gene.pl</span>
<span class="sd">          &lt;group_by_gene_perldoc&gt;` script.</span>
<span class="sd">        * *perlpath* - the path to the perl executable to use to run</span>
<span class="sd">          :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;`.</span>
<span class="sd">        * *clustq* - the name of the cluster queue to submit jobs to.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    Instances a cluster run of :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;`</span>
<span class="sd">    for the given bamfile. Note that this function includes SGE-specific</span>
<span class="sd">    job submission parameters (in fact, they&#39;re quite possibly specific to our</span>
<span class="sd">    individual cluster!). Briefly, they are:</span>

<span class="sd">        * *-cwd* - specify running the job in the current working directory</span>
<span class="sd">        * *-l local_free=20G* - require at least 20GB of free disk local to the</span>
<span class="sd">          cluster node</span>
<span class="sd">        * *-l ram=3G* - require at least 3GB of RAM on the node.</span>
<span class="sd">        * *-clear* - clear any existing cluster queue settings.</span>
<span class="sd">        * *-q &#39;options.clustq&#39;* - specify the queue to submit the job to.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Processing file </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">bam_file</span><span class="p">)</span>

    <span class="n">outfile</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.gbgout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bam_file</span><span class="p">))</span>

    <span class="n">c_job</span> <span class="o">=</span> <span class="n">c_session</span><span class="o">.</span><span class="n">createJobTemplate</span><span class="p">()</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">remoteCommand</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">perlpath</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">gbgpath</span><span class="p">,</span> <span class="s">&quot;--bam&quot;</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span> <span class="s">&quot;--gtf&quot;</span><span class="p">,</span>
                  <span class="n">options</span><span class="o">.</span><span class="n">feature_annot</span><span class="p">,</span> <span class="s">&quot;--method&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">cmeth</span><span class="p">,</span>
                  <span class="s">&quot;--feature&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="s">&quot;--out&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">c_job</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--debug&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">drmaa command line:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_job</span><span class="o">.</span><span class="n">args</span><span class="p">)))</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">outputPath</span> <span class="o">=</span> <span class="s">&quot;:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">errorPath</span> <span class="o">=</span> <span class="s">&quot;:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>

    <span class="c"># pass current working directory (not that this is needed really, but hey!)</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="s">&quot;-cwd&quot;</span>

    <span class="c"># check for local disk space on the target node</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> -l local_free=20G -l ram=3G&quot;</span> \
                                <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span>

    <span class="c"># add support for different cluster queue specifications</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="s">&quot;-clear -q &#39;</span><span class="si">%s</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">&quot;</span> \
                                <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">clustq</span><span class="p">,</span> <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">drmaa output intermediates written to: </span><span class="si">%s</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">jobEnvironment</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">c_session</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">c_job</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Job submitted with id: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">jobid</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="run_gbg"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.run_gbg">[docs]</a><span class="k">def</span> <span class="nf">run_gbg</span><span class="p">(</span><span class="n">bam_file</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Instance a non-cluster run of gene count summarization for a bam file</span>

<span class="sd">    :param str bam_file: the filename of the bam to summarise</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * *None*</span>
<span class="sd">        * the name of the file containing the resulting gene count summarization</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *feature_annot* - the path to the `gff</span>
<span class="sd">          &lt;https://www.sanger.ac.uk/resources/software/gff/&gt;`_ file to use for</span>
<span class="sd">          gene summarization.</span>
<span class="sd">        * *cmeth* - the method for `htseq-count</span>
<span class="sd">          &lt;http://www-huber.embl.de/users/anders/HTSeq/doc/count.html&gt;`_ to use</span>
<span class="sd">          to summarize the read coutn data.</span>
<span class="sd">        * *feature* - the feature type in the annotation to summarise the read</span>
<span class="sd">          count data for.</span>
<span class="sd">        * *gbgpath* - the path to the :ref:`group_by_gene.pl</span>
<span class="sd">          &lt;group_by_gene_perldoc&gt;` script.</span>
<span class="sd">        * *perlpath* - the path to the perl executable to use to run</span>
<span class="sd">          :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;`.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    The script uses :py:class:`subprocess.Popen` to call an external</span>
<span class="sd">    run of :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;`.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Processing file </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">bam_file</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">gbgpath</span><span class="p">,</span> <span class="s">&quot;--bam&quot;</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span> <span class="s">&quot;--gtf&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">.</span><span class="n">feature_annot</span><span class="p">,</span> <span class="s">&quot;--method&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">cmeth</span><span class="p">,</span> <span class="s">&quot;--feature&quot;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="s">&quot;--out&quot;</span><span class="p">,</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.gbgout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bam_file</span><span class="p">))]</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">command line:</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Job executing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="n">gbg_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">gbg_out</span> <span class="o">=</span> <span class="n">gbg_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">completed:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">gbg_out</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.gbgout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bam_file</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="run_agnc"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.run_agnc">[docs]</a><span class="k">def</span> <span class="nf">run_agnc</span><span class="p">(</span><span class="n">agnc_file</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Instance a non-cluster run of gene count summarization annotation</span>

<span class="sd">    :param str agnc_file: the filename of the gene count summarization file to</span>
<span class="sd">                          annotate</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * *None*</span>
<span class="sd">        * the name of the file containing the resulting annotated gene count</span>
<span class="sd">          summarization</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *species* - the ensembl species name.</span>
<span class="sd">        * *agncpath* - the path to the :ref:`add_gene_name_column.pl</span>
<span class="sd">          &lt;add_gene_name_column_perldoc&gt;` script.</span>
<span class="sd">        * *perlpath* - the path to the perl executable to use to run</span>
<span class="sd">          :ref:`add_gene_name_column.pl &lt;add_gene_name_column_perldoc&gt;`.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    The script uses :py:class:`subprocess.Popen` to call an external</span>
<span class="sd">    run of :ref:`add_gene_name_column.pl &lt;add_gene_name_column_perldoc&gt;`.</span>
<span class="sd">    :ref:`add_gene_name_column.pl &lt;add_gene_name_column_perldoc&gt;` uses the</span>
<span class="sd">    `perl ensembl API &lt;http://www.ensembl.org/info/docs/api/index.html&gt;`_</span>
<span class="sd">    to pull species annotation information directly from ensembl. *species*</span>
<span class="sd">    must be a name recognised by ensembl (`this list</span>
<span class="sd">    &lt;http://www.ensembl.org/info/about/species.html&gt;`_ is probably a good place</span>
<span class="sd">    to start). Strings with spaces in must be in quotes.</span>

<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Processing file </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">agnc_file</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">agncpath</span><span class="p">,</span> <span class="s">&quot;--in&quot;</span><span class="p">,</span> <span class="n">agnc_file</span><span class="p">,</span>
            <span class="s">&quot;--species&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">species</span><span class="p">,</span>
            <span class="s">&quot;--out&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.agncout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">agnc_file</span><span class="p">))</span>
            <span class="p">]</span>

    <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--coords&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--desc&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">command line:</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s">&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Job executing...&quot;</span><span class="p">)</span>

    <span class="n">agnc_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">agnc_out</span> <span class="o">=</span> <span class="n">agnc_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;completed.&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.agncout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">agnc_file</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="monitorDrmaaJobs"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.monitorDrmaaJobs">[docs]</a><span class="k">def</span> <span class="nf">monitorDrmaaJobs</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span> <span class="n">joblist</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">delo</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">dele</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; monitor a list of cluster jobs that have been submitted via drmaa</span>

<span class="sd">    :param c_session: a :py:class:drmaa.Session: instance for interacting with</span>
<span class="sd">                      the cluster.</span>

<span class="sd">    :param list joblist: a list of cluster job IDs to monitor.</span>

<span class="sd">    :param list filelist: a list of the files to expect from sucessful</span>
<span class="sd">                          completion of each monitored job.</span>

<span class="sd">    :param str prefix: the cluster output and error file prefix to look for.</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :param bool delo: toggle deletion of the cluster output file on job</span>
<span class="sd">                      completion.</span>

<span class="sd">    :param bool dele: toggle deletion of the cluster error file on job</span>
<span class="sd">                      completion.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * A dictionary keyed on the job ID giving the completion status of each</span>
<span class="sd">          monitored job.</span>
<span class="sd">        * the number of jobs that completed successfully</span>
<span class="sd">        * the number of jobs that failed to complete successfully.</span>
<span class="sd">        * the input (possibly modified) :py:class:`optparse.Values` instance.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *keep_tmpdir* - flag to keep or delete the tmpdir at the end of the</span>
<span class="sd">          script run.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    At the moment *filelist* si limited to one file per job and so this list</span>
<span class="sd">    must have the same length and be in the same order as *joblist*. As well as</span>
<span class="sd">    monitoring the jobs as they run, and looking for the expected output files,</span>
<span class="sd">    the script also looks for the cluster output files. They are expected to</span>
<span class="sd">    have the forms:</span>

<span class="sd">        * *&lt;prefix&gt;.o&lt;jobid&gt;* - cluster output log.</span>
<span class="sd">        * *&lt;prefix&gt;.e&lt;jobid&gt;* - cluster error log.</span>

<span class="sd">    If any of the runs fail, *options.keep_tmpdir* will be overwritten to</span>
<span class="sd">    **True** to ensure all failing cluster log files are kept.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">monitoring jobs...&quot;</span><span class="p">)</span>

    <span class="n">jobs_remaining</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">jobs_to_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">joblist</span><span class="p">):</span>
        <span class="n">jobs_remaining</span><span class="p">[</span><span class="n">joblist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">jobs_to_files</span><span class="p">[</span><span class="n">joblist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">finished</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">exit_status</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">jobs_remaining</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exit_status</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">c_session</span><span class="o">.</span><span class="n">jobStatus</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">jobs_remaining</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">jobs_remaining</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span><span class="o">!=</span><span class="n">status</span><span class="p">:</span>

                    <span class="n">ofilename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.o</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">))</span>
                    <span class="n">efilename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.e</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">))</span>

                    <span class="c"># cluster job status checking...</span>
                    <span class="c"># Job has finished normally</span>
                    <span class="k">if</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span><span class="p">:</span>

                        <span class="n">exit_status</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span><span class="o">=</span><span class="n">status</span>
                        <span class="n">success</span><span class="o">+=</span><span class="mi">1</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sizecheck</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">jobs_to_files</span><span class="p">[</span><span class="n">jid</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">sizecheck</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">delo</span> <span class="ow">and</span> <span class="n">dele</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - completed sucessfully.&quot;</span> \
                                                      <span class="s">&quot;</span><span class="se">\n\t</span><span class="s"> removing file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                                                  <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">),</span>
                                                                                  <span class="n">ofilename</span><span class="p">)</span>
                                                      <span class="p">)</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ofilename</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s"> removing file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">efilename</span><span class="p">)</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">efilename</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="n">delo</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dele</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - completed sucessfully.&quot;</span> \
                                                      <span class="s">&quot;</span><span class="se">\n\t</span><span class="s"> removing file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                                                  <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">),</span>
                                                                                  <span class="n">ofilename</span><span class="p">)</span>
                                                      <span class="p">)</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ofilename</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="n">dele</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delo</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - completed sucessfully.&quot;</span> \
                                                      <span class="s">&quot;</span><span class="se">\n\t</span><span class="s"> removing file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                                                  <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">),</span>
                                                                                  <span class="n">efilename</span><span class="p">)</span>
                                                      <span class="p">)</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">efilename</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">removing files for sucessful job </span><span class="si">%s</span><span class="s"> &quot;</span> \
                                              <span class="s">&quot;failed.&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                              <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c"># keep all tmpfiles regardless of settings and report error</span>
                                <span class="n">options</span><span class="o">.</span><span class="n">keep_tmpdir</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="n">exit_status</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;emptyfile&quot;</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">: Output file </span><span class="si">%s</span><span class="s"> is empty.&quot;</span> \
                                          <span class="s">&quot; It might just be taking a while to &quot;</span> \
                                          <span class="s">&quot;write the file but, I&#39;ll keep all &quot;</span> \
                                          <span class="s">&quot;the temp files incase something went &quot;</span> \
                                          <span class="s">&quot;wrong.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">),</span> <span class="n">jobs_to_files</span><span class="p">[</span><span class="n">jid</span><span class="p">])</span>
                                          <span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="c"># keep all tmpfiles regardless of settings and report error</span>
                            <span class="n">options</span><span class="o">.</span><span class="n">keep_tmpdir</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">exit_status</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;nofile&quot;</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Output file </span><span class="si">%s</span><span class="s"> does not exist! Keeping all &quot;</span> \
                                      <span class="s">&quot;temp files incase something went wrong.&quot;</span> \
                                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jobs_to_files</span><span class="p">[</span><span class="n">jid</span><span class="p">])</span>
                                      <span class="p">)</span>
                    <span class="c"># Job finished, but terminated abnormally</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                        <span class="c"># keep all tmpfiles regardless of settings and report error</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">keep_tmpdir</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">fail</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">exit_status</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span><span class="o">=</span><span class="n">status</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job failed. Files for this &quot;</span> \
                                  <span class="s">&quot;job are: </span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">jid</span><span class="p">,</span>
                                                    <span class="n">ofilename</span><span class="p">,</span> <span class="n">efilename</span><span class="p">)</span>
                                  <span class="p">)</span>
                    <span class="c"># Job is queued and active</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">QUEUED_ACTIVE</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job queued and active...&quot;</span> \
                                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jid</span><span class="p">)</span>
                                      <span class="p">)</span>
                    <span class="c"># job is running</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job running...&quot;</span> \
                                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jid</span><span class="p">)</span>
                                      <span class="p">)</span>
                    <span class="c"># job is queued and in system hold</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">SYSTEM_ON_HOLD</span><span class="p">:</span> <span class="c">#</span>
                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job on hold (by system)...&quot;</span> \
                                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jid</span><span class="p">)</span>
                                      <span class="p">)</span>
                    <span class="c"># job is queued and in user hold</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">USER_ON_HOLD</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job on hold (by user - &quot;</span> \
                                      <span class="s">&quot;why??)...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jid</span><span class="p">)</span>
                                      <span class="p">)</span>
                    <span class="c"># job is system suspended</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">SYSTEM_SUSPENDED</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job suspended (by system)&quot;</span> \
                                      <span class="s">&quot;...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jid</span><span class="p">)</span>
                                      <span class="p">)</span>
                    <span class="c"># job is user suspended</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">USER_SUSPENDED</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job suspended (by user - &quot;</span> \
                                      <span class="s">&quot;why??)...&quot;</span> \
                                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jid</span><span class="p">)</span>
                                      <span class="p">)</span>
                    <span class="c"># job is queued and in user and system hold</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">USER_SYSTEM_ON_HOLD</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job on hold (by system &amp; &quot;</span> \
                                      <span class="s">&quot;user - wtf?? seriously??)...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">jid</span><span class="p">)</span>
                                      <span class="p">)</span>
                    <span class="c"># process status cannot be determined,</span>
                    <span class="k">elif</span> <span class="n">status</span><span class="o">==</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">UNDETERMINED</span><span class="p">:</span>
                        <span class="c"># keep all tmpfiles regardless of settings and report error</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">keep_tmpdir</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">fail</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">exit_status</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span><span class="o">=</span><span class="n">status</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> - job state undetermined, &quot;</span> \
                                  <span class="s">&quot;assumed success, but keeping files just &quot;</span> \
                                  <span class="s">&quot;in case! Files for this job are: &quot;</span> \
                                  <span class="s">&quot;</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                    <span class="n">jid</span><span class="p">,</span>
                                                    <span class="n">ofilename</span><span class="p">,</span>
                                                    <span class="n">efilename</span><span class="p">)</span>
                                  <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;Something went wrong with the drmaa/cluster &quot;</span> \
                                 <span class="s">&quot;monitoring. Get help!&quot;</span><span class="p">)</span>

                    <span class="n">jobs_remaining</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span><span class="o">=</span><span class="n">status</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exit_status</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">jobs_remaining</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs_remaining</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">finished</span><span class="o">=</span><span class="bp">True</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">exit_status</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_gene_counts"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.get_gene_counts">[docs]</a><span class="k">def</span> <span class="nf">get_gene_counts</span><span class="p">(</span><span class="n">all_replicates</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Get gene count summarization for all bam files in the experiemnt</span>

<span class="sd">    :param list all_replicates: a list of all the replicates in the experiment</span>
<span class="sd">                                (2nd element in the tuple output from</span>
<span class="sd">                                :func:`parse_experiment_data`).</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a list of the resulting file containing the gene count</span>
<span class="sd">             summarisation from each bam file</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *feature_annot* - the path to the `gff</span>
<span class="sd">          &lt;https://www.sanger.ac.uk/resources/software/gff/&gt;`_ file to use for</span>
<span class="sd">          gene summarization.</span>
<span class="sd">        * *cmeth* - the method for `htseq-count</span>
<span class="sd">          &lt;http://www-huber.embl.de/users/anders/HTSeq/doc/count.html&gt;`_ to use</span>
<span class="sd">          to summarize the read coutn data.</span>
<span class="sd">        * *feature* - the feature type in the annotation to summarise the read</span>
<span class="sd">          count data for.</span>
<span class="sd">        * *gbgpath* - the path to the :ref:`group_by_gene.pl</span>
<span class="sd">          &lt;group_by_gene_perldoc&gt;` script.</span>
<span class="sd">        * *perlpath* - the path to the perl executable to use to run</span>
<span class="sd">          :ref:`group_by_gene.pl &lt;group_by_gene_perldoc&gt;`.</span>
<span class="sd">        * *savecounts* - toggle saving the gene count summarization files.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>
<span class="sd">        * *nocluster* - toggle running the summarization on the cluster, or</span>
<span class="sd">          locally.</span>


<span class="sd">    Calls either :func:`run_gbg` or :func:`run_gbg_cluster` depending on</span>
<span class="sd">    whether *options.nocluster* is *True* or *False*. If *options.nocluster* is</span>
<span class="sd">    *False* then then *options* must also contain the keyword:</span>

<span class="sd">        * *clustq* - the name of the cluster queue to submit jobs to.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># run group_by_gene.pl on each of the bam files. Use cluster is available</span>
    <span class="n">gbg_files</span><span class="o">=</span><span class="p">{}</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nocluster</span><span class="p">:</span>
        <span class="c"># open log</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Cluster not enabled: Running group_by_gene.pl and &quot;</span> \
                  <span class="s">&quot;add_gene_name_column.pl on each bam file in the &quot;</span> \
                  <span class="s">&quot;experiment...</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">bam_file</span> <span class="ow">in</span> <span class="n">all_replicates</span><span class="p">:</span>
            <span class="n">job</span><span class="p">,</span> <span class="n">gbg_outfile</span> <span class="o">=</span> <span class="n">run_gbg</span><span class="p">(</span><span class="n">bam_file</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="n">gbg_files</span><span class="p">[</span><span class="n">gbg_outfile</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># open log</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Cluster enabled: Running group_by_gene.pl and &quot;</span> \
                  <span class="s">&quot;add_gene_name_column.pl on a cluster node in the </span><span class="si">%s</span><span class="s"> &quot;</span> \
                  <span class="s">&quot;queue for each bam file in the experiment...</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">options</span><span class="o">.</span><span class="n">clustq</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># use drmaa to spread multiple group_by_gene.pl jobs across the</span>
        <span class="c"># cluster.</span>
        <span class="c"># open a drmaa</span>
        <span class="n">c_session</span> <span class="o">=</span> <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">c_session</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="c"># OK, so samtools seems to have an issue with our cluster and</span>
        <span class="c"># occasionally, randomly dies producing no error, just a core dump</span>
        <span class="c"># we hypothesis this is due to OOM problems when the cluster is busy</span>
        <span class="c"># so we&#39;re going to check for any failed jobs here and force a resubmit.</span>
        <span class="n">resub_trys</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">resub_count</span><span class="o">=</span><span class="mi">0</span>

        <span class="n">all_replicate_save</span> <span class="o">=</span> <span class="n">all_replicates</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_replicates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">resub_count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: resubmitting </span><span class="si">%i</span><span class="s"> </span><span class="si">%s</span><span class="s"> jobs that failed &quot;</span> \
                          <span class="s">&quot;inexplicably...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                               <span class="nb">len</span><span class="p">(</span><span class="n">all_replicates</span><span class="p">),</span>
                                               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">gbgpath</span><span class="p">)</span>
                                               <span class="p">)</span>
                          <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c"># loop through all the replicates and save only those ones with</span>
            <span class="c"># unique filenames. Here we are assuming that if two files in</span>
            <span class="c"># different conditions have the same filename, they are the same!</span>
            <span class="c"># So don&#39;t do this if they are not.</span>

            <span class="n">baselist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">process_files</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">bam_file</span> <span class="ow">in</span> <span class="n">all_replicates</span><span class="p">:</span>
                <span class="n">base_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bam_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base_filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">baselist</span><span class="p">:</span>
                    <span class="n">baselist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_filename</span><span class="p">)</span>
                    <span class="n">process_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bam_file</span><span class="p">)</span>

            <span class="c"># loop throught he files calling a new cluster job for each</span>
            <span class="n">joblist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">job_bamfile</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">for</span> <span class="n">bam_file</span> <span class="ow">in</span> <span class="n">process_files</span><span class="p">:</span>
                <span class="n">jobid</span><span class="p">,</span> <span class="n">gbg_outfile</span> <span class="o">=</span> <span class="n">run_gbg_cluster</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span>
                                                     <span class="n">options</span><span class="p">)</span>
                <span class="n">joblist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
                <span class="n">job_bamfile</span><span class="p">[</span><span class="n">jobid</span><span class="p">]</span><span class="o">=</span><span class="n">bam_file</span>
                <span class="n">gbg_files</span><span class="p">[</span><span class="n">gbg_outfile</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>

            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> jobs launched...&quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">gbgpath</span><span class="p">)))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">))</span>
            <span class="n">filelist</span> <span class="o">=</span> <span class="n">gbg_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">exit_status</span><span class="p">,</span> <span class="n">sucess</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">monitorDrmaaJobs</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span>
                                                                  <span class="n">joblist</span><span class="p">,</span>
                                                                  <span class="n">filelist</span><span class="p">,</span>
                                                                  <span class="n">prefix</span><span class="p">,</span>
                                                                  <span class="n">options</span><span class="p">)</span>

            <span class="c"># clearup job metadat and information</span>
            <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">joblist</span><span class="p">:</span>
                <span class="n">c_session</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span>
                                      <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">TIMEOUT_WAIT_FOREVER</span><span class="p">,</span>
                                      <span class="bp">True</span><span class="p">)</span>

            <span class="c"># reset all_replicates list</span>
            <span class="n">all_replicates</span><span class="o">=</span><span class="p">[]</span>

            <span class="c"># only resubmit a fixed number of times...</span>
            <span class="k">if</span> <span class="n">resub_count</span><span class="o">&lt;</span><span class="n">resub_trys</span><span class="p">:</span>
                <span class="c"># check for any jobs that died without</span>
                <span class="c"># producing a file or producing an empty file</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">exit_status</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">exit_status</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">status</span><span class="o">==</span><span class="s">&quot;emptyfile&quot;</span> <span class="ow">or</span> <span class="n">status</span><span class="o">==</span><span class="s">&quot;nofile&quot;</span><span class="p">:</span>
                        <span class="c"># recheck, just in case it took a while to write the</span>
                        <span class="c"># file:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sizecheck</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">job_bamfile</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">sizecheck</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">all_replicates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_bamfile</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">all_replicates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_bamfile</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span>

            <span class="n">resub_count</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">c_session</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="n">all_replicates</span> <span class="o">=</span> <span class="n">all_replicate_save</span>

    <span class="c"># copy the gene counts to the source directory if specified.</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">savecounts</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Saving gene read counds to source datafile &quot;</span> \
                  <span class="s">&quot;directory...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">gbg_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Searching for match for file </span><span class="si">%s</span><span class="s">.&quot;</span> \
                          <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">origin_file</span> <span class="ow">in</span> <span class="n">all_replicates</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: matching against </span><span class="si">%s</span><span class="s">...&quot;</span> \
                          <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">origin_file</span><span class="p">)))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^</span><span class="si">%s</span><span class="s">.gbgout$&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">origin_file</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Saving file </span><span class="si">%s</span><span class="s"> to &quot;</span> \
                                  <span class="s">&quot;locations </span><span class="si">%s</span><span class="s">.&quot;</span> \
                                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                        <span class="n">filename</span><span class="p">,</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">origin_file</span><span class="p">)))</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">origin_file</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Problem copying file </span><span class="si">%s</span><span class="s"> to &quot;</span> \
                                  <span class="s">&quot;locations </span><span class="si">%s</span><span class="s">. Its probably a write &quot;</span> \
                                  <span class="s">&quot;permissionas issue!&quot;</span> \
                                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                        <span class="n">filename</span><span class="p">,</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">origin_file</span><span class="p">)))</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">raise</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">gbg_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="read_expression_data"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.read_expression_data">[docs]</a><span class="k">def</span> <span class="nf">read_expression_data</span><span class="p">(</span><span class="n">replicate_files</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;unstruct&quot;</span><span class="p">,</span>
                         <span class="n">delimiter</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; reads the gene count summarization data &amp; concatenates to a numpy array</span>

<span class="sd">    :param list replicate_files: a list of file containing replicate gene count</span>
<span class="sd">                                 data (output from :func:`get_gene_counts`).</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :param str format: the format of the output data from this function.</span>
<span class="sd">                       Options are:</span>

<span class="sd">                       * unstruct - return a tuple of information</span>
<span class="sd">                       * struct - return a :py:class:`numpy.ndarray` structured</span>
<span class="sd">                         array</span>

<span class="sd">    :param str delimiter: The delimiter to use for separating fields in the</span>
<span class="sd">                          read count summarization files.</span>

<span class="sd">    :return: The functions returns either a :py:class:`numpy.ndarray` structured</span>
<span class="sd">             array with feature, coordinate and description columns that</span>
<span class="sd">             contains the gene count summarization data for the</span>
<span class="sd">             replicates, or a tuple containing:</span>

<span class="sd">               * a :py:class:`numpy.ndarray` with the read count summarization</span>
<span class="sd">                 data.</span>
<span class="sd">               * a :py:class:`numpy.ndarray` containing the feature names the</span>
<span class="sd">                 read count summarization applies to (in the same order as the</span>
<span class="sd">                 rows of the data array).</span>
<span class="sd">               * *None* (don&#39;t ask).</span>
<span class="sd">               * a list of the samples the read counts were summarized for (in</span>
<span class="sd">                 the same order as the columns of the data array).</span>

<span class="sd">             The default is *unstruct*.</span>

<span class="sd">    The *options* instance must contain the *log* keyword providing the</span>
<span class="sd">    filename of the the log file to write to.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Concatenating data in all files...</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

    <span class="n">expressiondata</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">file_structure</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;names&#39;</span><span class="p">:(</span><span class="s">&#39;featureID&#39;</span><span class="p">,</span> <span class="s">&#39;rawReads&#39;</span><span class="p">),</span>
                      <span class="s">&#39;formats&#39;</span><span class="p">:(</span><span class="s">&#39;S50&#39;</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)}</span>

    <span class="n">datacolumns</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">replicate_files</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">processing </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">filedata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">,</span>
                                    <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span>
                                    <span class="n">comments</span><span class="o">=</span><span class="s">&quot;$(*&amp;$(*&amp;$(*&quot;</span> <span class="c"># allow strings w. #</span>
                                    <span class="p">)</span>

        <span class="c"># trim off last 4 entries; these summarize unaligned features in</span>
        <span class="c"># htseqcounts</span>
        <span class="n">filedata</span> <span class="o">=</span> <span class="n">filedata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">filedata</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">sorted_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">])</span>

        <span class="c"># check if the featurelists are the same:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">expressiondata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]</span> <span class="o">==</span>
                         <span class="n">sorted_data</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]):</span>
                <span class="n">expressiondata</span> <span class="o">=</span> <span class="n">append_fields</span><span class="p">(</span><span class="n">expressiondata</span><span class="p">,</span>
                                               <span class="s">&quot;</span><span class="si">%s</span><span class="s">_rawReads&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                                               <span class="n">sorted_data</span><span class="p">[</span><span class="s">&quot;rawReads&quot;</span><span class="p">],</span>
                                               <span class="n">dtypes</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">,</span>
                                               <span class="n">asrecarray</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                               <span class="n">usemask</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mismatches</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expressiondata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]</span> <span class="o">!=</span>
                                         <span class="n">sorted_filedata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ERR: </span><span class="si">%s</span><span class="s"> contains a different set of feature IDs &quot;</span> \
                          <span class="s">&quot;than in the previously processed files.</span><span class="se">\n</span><span class="s"> number &quot;</span> \
                          <span class="s">&quot;of IDs in </span><span class="si">%s</span><span class="s">: </span><span class="si">%i</span><span class="se">\n</span><span class="s"> number of IDs in previous &quot;</span> \
                          <span class="s">&quot;files: </span><span class="si">%i</span><span class="se">\n</span><span class="s"> mismatching line IDs: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                          <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                <span class="n">filename</span><span class="p">,</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">sorted_filedata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]),</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">expressiondata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]),</span>
                                <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mismatches</span><span class="p">)</span>
                                <span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;ERR: </span><span class="si">%s</span><span class="s"> contains a different set of feature IDs &quot;</span> \
                          <span class="s">&quot;than in the previously processed files.</span><span class="se">\n</span><span class="s"> number &quot;</span> \
                          <span class="s">&quot;of IDs in </span><span class="si">%s</span><span class="s">: </span><span class="si">%i</span><span class="se">\n</span><span class="s"> number of IDs in previous &quot;</span> \
                          <span class="s">&quot;files: </span><span class="si">%i</span><span class="se">\n</span><span class="s"> mismatching line IDs: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                          <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                <span class="n">filename</span><span class="p">,</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">sorted_filedata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]),</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">expressiondata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]),</span>
                                <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mismatches</span><span class="p">)</span>
                                <span class="p">))</span>
            <span class="n">datacolumns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_rawReads&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">expressiondata</span> <span class="o">=</span> <span class="n">rename_fields</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">,</span>
                                           <span class="p">{</span><span class="s">&quot;rawReads&quot;</span><span class="p">:</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_rawReads&quot;</span> \
                                            <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">filename</span>
                                            <span class="p">}</span>
                                           <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">: Done concatenating data</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">format</span><span class="o">==</span><span class="s">&quot;unstruct&quot;</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">expressiondata</span><span class="p">[</span><span class="s">&quot;featureID&quot;</span><span class="p">]</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">datacolumns</span>
        <span class="c"># after removing the agnc call for each individual gbg_file, the</span>
        <span class="c"># annotations variable is no longer required. The values in the</span>
        <span class="c"># tuple are used in a hardcoded way later (which I can&#39;t be bothtered</span>
        <span class="c"># to rewrite) so I&#39;m including an empty variable here for simplicity.</span>
        <span class="c"># sue me.</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">expressiondata</span><span class="p">[</span><span class="n">datacolumns</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">expressiondata</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="run_flagstat"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.run_flagstat">[docs]</a><span class="k">def</span> <span class="nf">run_flagstat</span><span class="p">(</span><span class="n">bam_file</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Instance local run of samtools flagstat for a bam file</span>

<span class="sd">    :param str bam_file: the filename of the bam to summarise</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * the job ID number of the cluster job</span>
<span class="sd">        * the name of the file containing the resulting flagstat output</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *samtoolspath* - the path to the samtools executable.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    The script uses :py:class:`subprocess.Popen` to call an external</span>
<span class="sd">    run of samtools flagstat.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Counting mapped reads in file </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">bam_file</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">samtoolspath</span><span class="p">,</span> <span class="s">&quot;flagstat&quot;</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.flagstatout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bam_file</span><span class="p">))]</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">command line:</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Job executing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="n">samtools_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">samtools_out</span> <span class="o">=</span> <span class="n">samtools_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">completed:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">samtools_out</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.flagstatout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bam_file</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="run_flagstat_cluster"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.run_flagstat_cluster">[docs]</a><span class="k">def</span> <span class="nf">run_flagstat_cluster</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Instance a cluster run of samtools flagstat for a bam file</span>

<span class="sd">    :param c_session: a :py:class:drmaa.Session: instance for interacting with</span>
<span class="sd">                      the cluster.</span>

<span class="sd">    :param str bam_file: the filename of the bam to summarise</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * the job ID number of the cluster job</span>
<span class="sd">        * the name of the file containing the resulting flagstat output</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *samtoolspath* - the path to the samtools executable.</span>
<span class="sd">        * *clustq* - the name of the cluster queue to submit jobs to.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    Note that this function includes a SGE-specific job submission parameter</span>
<span class="sd">    (in fact, they&#39;re quite possibly specific to our individual cluster!).</span>
<span class="sd">    Briefly, they are:</span>

<span class="sd">        * *-cwd* - specify running the job in the current working directory</span>
<span class="sd">        * *-clear* - clear any existing cluster queue settings.</span>
<span class="sd">        * *-q &#39;options.clustq&#39;* - specify the queue to submit the job to.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Counting mapped reads in file </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">bam_file</span><span class="p">)</span>

    <span class="n">c_job</span> <span class="o">=</span> <span class="n">c_session</span><span class="o">.</span><span class="n">createJobTemplate</span><span class="p">()</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">remoteCommand</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">samtoolspath</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;flagstat&quot;</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">]</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">drmaa command line:</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">samtoolspath</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_job</span><span class="o">.</span><span class="n">args</span><span class="p">)))</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">outputPath</span> <span class="o">=</span> <span class="s">&quot;:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">errorPath</span> <span class="o">=</span> <span class="s">&quot;:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>

    <span class="c"># pass current working directory (not that this is needed really, but hey!)</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="s">&quot;-cwd&quot;</span>

    <span class="c"># add support for different cluster queue specifications</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="s">&quot;-clear -q &#39;</span><span class="si">%s</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">&quot;</span> \
                                <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">clustq</span><span class="p">,</span> <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">drmaa output intermediates written to: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">jobEnvironment</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">c_session</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">c_job</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Job submitted with id: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">jobid</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/samtools.o</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                      <span class="n">jobid</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="deseq_normalization"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.deseq_normalization">[docs]</a><span class="k">def</span> <span class="nf">deseq_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Normalize the raw read counts using DESeq normalisation</span>

<span class="sd">    :param data: a :py:class:`numpy.ndarray` containing the raw read count</span>
<span class="sd">                 summarization data.</span>

<span class="sd">    :param list samples: a list of samples (in the order of the columns of the</span>
<span class="sd">                         *data* array).</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * a :py:class:`numpy.ndarray` containing the normalized read count</span>
<span class="sd">          summarization data.</span>
<span class="sd">        * a dictionary keyed on the sample names containing the sample</span>
<span class="sd">          normalization factors.</span>

<span class="sd">    The form of the normalization is taken from the `DEseq</span>
<span class="sd">    &lt;https://bioconductor.org/packages/release/bioc/vignettes/DESeq/inst/doc/DESeq.pdf&gt;`_</span>
<span class="sd">    tool implemented in `bioconductor &lt;https://bioconductor.org/&gt;`_. The *data*</span>
<span class="sd">    :py:class:`numpy.ndarray` should have columns corresponding to each sample</span>
<span class="sd">    in *samples*.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Running deseq normalization...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

    <span class="c"># calculate per gene geometric mean across replicates</span>
    <span class="n">gm</span><span class="o">=</span><span class="n">mst</span><span class="o">.</span><span class="n">gmean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gm</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">nomask</span>

    <span class="c"># only interested in those with finite geometric mean</span>
    <span class="n">gvs</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gm</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># adjust counts by geometric exclude those genes with zero counts</span>
    <span class="c"># This is what DESeq does but is not true representation of the equation</span>
    <span class="c"># it quotes</span>
    <span class="n">dat</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">gm</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gvs</span> <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">nm</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c"># calculate normalised count</span>
    <span class="n">norm</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">nm</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> \
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nm</span><span class="p">))],</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="n">norms</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">sample_no</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)):</span>
        <span class="n">norms</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="n">sample_no</span><span class="p">]]</span><span class="o">=</span><span class="n">nm</span><span class="p">[</span><span class="n">sample_no</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">norms</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="parseFlagstatOut"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.parseFlagstatOut">[docs]</a><span class="k">def</span> <span class="nf">parseFlagstatOut</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; parse the samtools flagstat output for the total number of reads</span>

<span class="sd">    :param str filename: the filename of the output from samtools flagstat</span>

<span class="sd">    :return: the number of million reads counted by samtools flagstat</span>
<span class="sd">    :rtype: float</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">thisdata</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">thisdata</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nreads</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^([0-9]+).*mapped.+$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nreads</span><span class="p">)</span><span class="o">/</span><span class="mf">1E6</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">pmrm_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">all_bams</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Normalize the raw read counts by &#39;per million mapped reads&#39;</span>

<span class="sd">    :param data: a :py:class:`numpy.ndarray` containing the raw read count</span>
<span class="sd">                 summarization data.</span>

<span class="sd">    :param list all_bams: a list of bam files to extract the total read count</span>
<span class="sd">                          from. Should match in length and order the samples</span>
<span class="sd">                          listed in *samples*.</span>

<span class="sd">    :param list samples: a list of samples (in the order of the columns of the</span>
<span class="sd">                         *data* array).</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * a :py:class:`numpy.ndarray` containing the normalized read count</span>
<span class="sd">          summarization data.</span>
<span class="sd">        * a dictionary keyed on the sample names containing the sample</span>
<span class="sd">          normalization factors.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *samtoolspath* - the path to the samtools executable.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>
<span class="sd">        * *nocluster* - toggle running the summarization on the cluster, or</span>
<span class="sd">          locally.</span>

<span class="sd">    Calls either :func:`run_flagstat` or :func:`run_flagstat_cluster` depending</span>
<span class="sd">    on whether *options.nocluster* is *True* or *False*. If *options.nocluster*</span>
<span class="sd">    is *False* then then *options* must also contain the keyword:</span>

<span class="sd">        * *clustq* - the name of the cluster queue to submit jobs to.</span>

<span class="sd">    The output from these runs is then parsed with :func:`parseFlagstatOut`.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Running per-million-reads-mapped normalization...&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

    <span class="c"># run samtools on each file to get the total number of mapped reads in</span>
    <span class="c"># the ban file. Use the cluster if it is available.</span>
    <span class="n">readcount_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nocluster</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Cluster not enabled: Running samtools flagstat &quot;</span> \
                  <span class="s">&quot;on each bam file in the experiment...</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">bam_file</span> <span class="ow">in</span> <span class="n">all_bams</span><span class="p">:</span>
            <span class="n">job</span><span class="p">,</span> <span class="n">flagstat_outfile</span> <span class="o">=</span> <span class="n">run_flagstat</span><span class="p">(</span><span class="n">bam_file</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="n">readcount_files</span><span class="p">[</span><span class="n">bam_file</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flagstat_outfile</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Cluster enabled: Running samtools flagstat on a &quot;</span> \
                  <span class="s">&quot;cluster node in the </span><span class="si">%s</span><span class="s"> queue for each bam file in the &quot;</span> \
                  <span class="s">&quot;experiment...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">options</span><span class="o">.</span><span class="n">clustq</span><span class="p">))</span>

        <span class="c"># use drmaa to spread multiple samtools jobs across the cluster.</span>
        <span class="c"># open a drmaa</span>
        <span class="n">c_session</span> <span class="o">=</span> <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">c_session</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="c"># loop throught he files calling a new cluster job for each</span>
        <span class="n">joblist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filelist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">bam_file</span> <span class="ow">in</span> <span class="n">all_bams</span><span class="p">:</span>
            <span class="n">jobid</span><span class="p">,</span> <span class="n">flagstat_outfile</span> <span class="o">=</span> <span class="n">run_flagstat_cluster</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span>
                                                           <span class="n">bam_file</span><span class="p">,</span>
                                                           <span class="n">options</span><span class="p">)</span>
            <span class="n">joblist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
            <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flagstat_outfile</span><span class="p">)</span>
            <span class="n">readcount_files</span><span class="p">[</span><span class="n">bam_file</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flagstat_outfile</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> jobs launched...&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">samtoolspath</span><span class="p">)))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">samtoolspath</span><span class="p">))</span>
        <span class="n">exit_status</span><span class="p">,</span> <span class="n">sucess</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">monitorDrmaaJobs</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span>
                                                              <span class="n">joblist</span><span class="p">,</span> <span class="n">filelist</span><span class="p">,</span>
                                                              <span class="n">prefix</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                                              <span class="n">delo</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># clearup job metadat and information</span>
        <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">joblist</span><span class="p">:</span>
            <span class="n">c_session</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span>
                                  <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">TIMEOUT_WAIT_FOREVER</span><span class="p">,</span>
                                  <span class="bp">True</span><span class="p">)</span>

        <span class="n">c_session</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c"># read files to get readcounts</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">readcount_files</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">readcount_files</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="n">readcount_files</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">thissample</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">sampleid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;.+\/&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="nb">file</span><span class="p">),</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">thissample</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">sampleid</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Reading file </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="nb">file</span><span class="p">)</span>
                      <span class="p">)</span>
        <span class="n">total_Mreads</span> <span class="o">=</span> <span class="n">parseFlagstatOut</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[:,</span><span class="n">sampleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">sampleid</span><span class="p">]</span><span class="o">/</span><span class="n">total_Mreads</span>
        <span class="n">norms</span><span class="p">[</span><span class="nb">file</span><span class="p">]</span><span class="o">=</span><span class="n">total_Mreads</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">exit_status</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">!=</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">UNDETERMINED</span> <span class="ow">and</span> <span class="n">status</span><span class="o">!=</span><span class="n">drmaa</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: File </span><span class="si">%s</span><span class="s"> read. Removing file.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="nb">file</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norms</span><span class="p">)</span>

<div class="viewcode-block" id="normalize_data"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.normalize_data">[docs]</a><span class="k">def</span> <span class="nf">normalize_data</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">all_replicates</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Wrapper function to run the various normalization routines</span>

<span class="sd">    :param results: a tuple containing:</span>

<span class="sd">        * a :py:class:`numpy.ndarray` with the read count summarization</span>
<span class="sd">          data.</span>
<span class="sd">        * a :py:class:`numpy.ndarray` containing the feature names the</span>
<span class="sd">          read count summarization applies to (in the same order as the</span>
<span class="sd">          rows of the data array).</span>
<span class="sd">        * a list of the samples the read counts were summarized for (in</span>
<span class="sd">          the same order as the columns of the data array).</span>

<span class="sd">                    These are output as the 0th, 1st and 3rd elements of the</span>
<span class="sd">                    tuple from running :func:`read_expression_data` with</span>
<span class="sd">                    *format=&quot;unstruct&quot;*.</span>

<span class="sd">    :param dict experiment: the experiment structure. This is the 1st element</span>
<span class="sd">                            of the output tuple from</span>
<span class="sd">                            :func:`parse_experiment_data`.</span>

<span class="sd">    :param list all_replicates: a list of all the replicates in the experiment</span>
<span class="sd">                                (2nd element in the tuple output from</span>
<span class="sd">                                :func:`parse_experiment_data`).</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * a :py:class:`numpy.ndarray` containing the normalized read count</span>
<span class="sd">          summarization data.</span>
<span class="sd">        * a dictionary keyed on the sample names containing the sample</span>
<span class="sd">          normalization factors.</span>

<span class="sd">    The *options* instance must contain the keyword *norm*. If</span>
<span class="sd">    *options.norm=&#39;pmrm&#39;* this function calls :func:`pmrm_normalization`, if</span>
<span class="sd">    *options.norm=&#39;deseq&#39;* this function calls :func:`deseq_normalization`, if</span>
<span class="sd">    *options.norm=&#39;none&#39;* no normalization is performed, if</span>
<span class="sd">    *options.norm=&#39;package:&lt;detoolname&gt;&#39;* then no normalization is performed</span>
<span class="sd">    here but the DE tool Rscript normalization will be applied further in the</span>
<span class="sd">    processing. The *options* instance must contain the keywords appropriate</span>
<span class="sd">    for the function being called.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float&quot;</span><span class="p">)</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">norm</span> <span class="o">==</span> <span class="s">&quot;pmrm&quot;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">norms</span> <span class="o">=</span> <span class="n">pmrm_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">all_replicates</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">norm</span> <span class="o">==</span> <span class="s">&quot;deseq&quot;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">norms</span> <span class="o">=</span> <span class="n">deseq_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">norm</span> <span class="o">==</span> <span class="s">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: performing no normalisation...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;package&quot;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: performing package </span><span class="si">%s</span><span class="s"> normalisation...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">options</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Sorry. &#39;</span><span class="si">%s</span><span class="s">&#39; normalisation has yet to be implement. &quot;</span> \
                  <span class="s">&quot;Please try again once you&#39;ve written it.</span><span class="se">\n\t\t</span><span class="s">Performing no &quot;</span> \
                  <span class="s">&quot;normalisation...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">norm</span><span class="p">))</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norms</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="write_R_data_file"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.write_R_data_file">[docs]</a><span class="k">def</span> <span class="nf">write_R_data_file</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; writes text files with data for the tool Rscript routines</span>

<span class="sd">    :param results: a tuple containing:</span>

<span class="sd">        * a :py:class:`numpy.ndarray` with the read count summarization</span>
<span class="sd">          data.</span>
<span class="sd">        * a :py:class:`numpy.ndarray` containing the feature names the</span>
<span class="sd">          read count summarization applies to (in the same order as the</span>
<span class="sd">          rows of the data array).</span>
<span class="sd">        * a list of the samples the read counts were summarized for (in</span>
<span class="sd">          the same order as the columns of the data array).</span>

<span class="sd">                    These are output as the 0th, 1st and 3rd elements of the</span>
<span class="sd">                    tuple from running :func:`read_expression_data` with</span>
<span class="sd">                    *format=&quot;unstruct&quot;*.</span>

<span class="sd">    :param dict experiment: the experiment structure. This is the 1st element</span>
<span class="sd">                            of the output tuple from</span>
<span class="sd">                            :func:`parse_experiment_data`.</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * the filename of the tsv format text data file that the Rscripts</span>
<span class="sd">          read as the expression data for differential expression.</span>
<span class="sd">        * the filename of the tsv format text data file that the Rscripts</span>
<span class="sd">          read as the phenoData for differential expression.</span>

<span class="sd">    This data is used by R to contruct expressionSet objects. For details on</span>
<span class="sd">    the file format see:</span>

<span class="sd">        * http://rss.acs.unt.edu/Rdoc/library/Biobase/html/readExpressionSet.html</span>
<span class="sd">        * http://stat.ethz.ch/R-manual/R-devel/library/utils/html/read.table.html</span>

<span class="sd">    Basically, we need first need a file with the first column as the feature</span>
<span class="sd">    names, then columns for each sample. A header line can contain the column</span>
<span class="sd">    names. The input &#39;results&#39; is a tuple of</span>

<span class="sd">       results = (data, features, [samples])</span>

<span class="sd">    samples here is optional.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">R_matrix_filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/R_exprsFile.txt&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>
    <span class="n">R_pheno_filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/R_phenoFile.txt&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Writing the matrix file for R (</span><span class="si">%s</span><span class="s">, </span><span class="si">%i</span><span class="s"> columns, </span><span class="si">%i</span><span class="s"> &quot;</span> \
              <span class="s">&quot;features)...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                  <span class="n">R_matrix_filename</span><span class="p">,</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                  <span class="p">)</span>
              <span class="p">)</span>

    <span class="n">exprs_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">R_matrix_filename</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">exprs_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">line_data_string</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">exprsFile_line_string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">line_data_string</span><span class="p">)</span>
        <span class="n">exprs_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exprsFile_line_string</span><span class="p">)</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">exprs_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Writing the sample information file for R (</span><span class="si">%s</span><span class="s">)...</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">R_pheno_filename</span><span class="p">))</span>

    <span class="n">pheno_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">R_pheno_filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sample_name</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">experiment</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">replicate_file</span> <span class="ow">in</span> <span class="n">experiment</span><span class="p">[</span><span class="n">condition</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">replicate_file</span><span class="p">),</span>
                            <span class="n">sample_name</span><span class="p">):</span>
                    <span class="n">pheno_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">))</span>

    <span class="n">pheno_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">R_matrix_filename</span><span class="p">,</span> <span class="n">R_pheno_filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="runRDE"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.runRDE">[docs]</a><span class="k">def</span> <span class="nf">runRDE</span><span class="p">(</span><span class="n">rexpfile</span><span class="p">,</span> <span class="n">rphefile</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">fileout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">runAGNC</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; runs an R-based differential expression analysis for a set of input data</span>

<span class="sd">    :param str rexpfile: the filename of the tsv-format text file for the R</span>
<span class="sd">                         tool to read. This is the first element of the tuple</span>
<span class="sd">                         output from :func:`write_R_data_file`.</span>

<span class="sd">    :param str rphefile: the filename of the tsv-format text file for the R</span>
<span class="sd">                         tool to read. This is the second element of the tuple</span>
<span class="sd">                         output from :func:`write_R_data_file`.</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :param bool fileout: optional output filename to give to the R tool. If not</span>
<span class="sd">                         specified this defaults to the value storred in</span>
<span class="sd">                         *options.outfile*.</span>

<span class="sd">    :param bool runAGNC: toggle running :func:`run_agnc` on the output data.</span>

<span class="sd">    :return: the filename of the output DE calls from the R tool.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *script_file* - the filename of the Rscript to run on the data.</span>
<span class="sd">        * *norm* - the normalization toggle for the data.</span>
<span class="sd">        * *rpath* - the path to the Rscript executable to use to run</span>
<span class="sd">          *script_file*.</span>
<span class="sd">        * *outfile* - filename for the Rscript to write its output to.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir* - the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *keep_tmpdir* - toggle whether to keep or clean-up the temp dir.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    The script uses :py:class:`subprocess.Popen` to call an external</span>
<span class="sd">    run of `Rscript</span>
<span class="sd">    &lt;https://stat.ethz.ch/R-manual/R-devel/library/utils/html/Rscript.html&gt;`_</span>
<span class="sd">    that runs a DE tool on the data. This will get executed ont he cluster.</span>
<span class="sd">    Optionally, this function calls :func:`run_agnc` to annotate the returned</span>
<span class="sd">    output data.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Running R script </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                 <span class="n">options</span><span class="o">.</span><span class="n">script_file</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">fileout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fileout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span>

    <span class="c">#fileout_tmp = &quot;%s/%s&quot; % (options.tmpdir, os.path.basename(fileout))</span>
    <span class="n">R_tempfile</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">_rtemp&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fileout</span><span class="p">))</span>
    <span class="n">fileout</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">_rout&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fileout</span><span class="p">))</span>
    
    <span class="n">cmdlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">rpath</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">script_file</span><span class="p">,</span><span class="n">rexpfile</span><span class="p">,</span> <span class="n">rphefile</span><span class="p">,</span> 
               <span class="n">R_tempfile</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">norm</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">\commandline: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">results stored in temp file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">R_tempfile</span><span class="p">)</span>

    <span class="c"># run R script and capture stderr and stdout. If fails report stderror</span>
    <span class="c"># and exit else only report stdout</span>
    <span class="n">r_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> 
                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="n">r_out</span> <span class="o">=</span> <span class="n">r_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">r_call</span><span class="o">.</span><span class="n">returncode</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Failed! stdout and stderr are below:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;R script failed! Can&#39;t continue. Halting.&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r_out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">runAGNC</span><span class="p">:</span>
        <span class="c"># add gene descriptions</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Adding gene name and description information to &quot;</span> \
                  <span class="s">&quot;</span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">R_tempfile</span><span class="p">))</span>

        <span class="n">job</span><span class="p">,</span> <span class="n">R_tempfile</span> <span class="o">=</span> <span class="n">run_agnc</span><span class="p">(</span><span class="n">R_tempfile</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="c"># check output file from run_agns() exists and is non-empty</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sizecheck</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">R_tempfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sizecheck</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># keep all tmpfiles regardless of settings and report error</span>
            <span class="n">options</span><span class="o">.</span><span class="n">keep_tmpdir</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Failed. Output annotated file is empty. &quot;</span> \
                      <span class="s">&quot;Keeping all temp files, available in </span><span class="si">%s</span><span class="s">... &quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
                      <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Failed. Output annotated file is empty. &quot;</span> \
                      <span class="s">&quot;Keeping all temp files, available in </span><span class="si">%s</span><span class="s">... &quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
                      <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># keep all tmpfiles regardless of settings and report error</span>
        <span class="n">options</span><span class="o">.</span><span class="n">keep_tmpdir</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Failed. Output annotated file doesn&#39;t exist. &quot;</span> \
                  <span class="s">&quot;Keeping all temp files, available in </span><span class="si">%s</span><span class="s">... &quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
                  <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Failed. Output annotated file doesn&#39;t exist. &quot;</span> \
                  <span class="s">&quot;Keeping all temp files, available in </span><span class="si">%s</span><span class="s">... &quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
                  <span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: writing final output file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">fileout</span><span class="p">))</span>

    <span class="n">out_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">R_tempfile</span><span class="p">)</span>

    <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">R_tempfile</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">filedata</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileout</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#</span><span class="se">\n</span><span class="s"># This file created with command: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> &quot; </span><span class="se">\</span>
<span class="s">                     &quot;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">rpath</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">script_file</span><span class="p">,</span> <span class="n">rexpfile</span><span class="p">,</span>
                               <span class="n">rphefile</span><span class="p">,</span> <span class="n">fileout</span><span class="p">)</span>
                     <span class="p">)</span>
    <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># Output created at: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> \
                     <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">()</span>
                     <span class="p">)</span>
<span class="c">#                     timeAndDateStr()</span>
<span class="c">#                     )</span>

    <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filedata</span><span class="p">)</span>
    <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">fileout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="writeCheckpoint"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.writeCheckpoint">[docs]</a><span class="k">def</span> <span class="nf">writeCheckpoint</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">checkpointdata</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; record restart/checkpointing information</span>

<span class="sd">    :param dict update: dictionary of run data and results to update/store in a</span>
<span class="sd">                        cPickle file.</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :param dict checkpointdata: a pre-existing dictionary of results to update</span>
<span class="sd">                                with the unformation in *update*.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    uses :py:class:`cPickle.dump`  to write a file called *restart.pkl* to</span>
<span class="sd">    *options.tmpdir*. This is used by the script to restart a failed or halted</span>
<span class="sd">    run if the :option:`--restart` option is provided to the script.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: writing checkpointing information...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">checkpointdata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">checkpointdata</span><span class="o">=</span><span class="p">{}</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">update</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Error: checkpoint update data is not in dictionary format!&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">checkpointdata</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Duplicate checkpoint key detected: </span><span class="si">%s</span><span class="s"> &quot;</span> \
                              <span class="s">&quot;(overwritting...)&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">checkpointdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">checkpointdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/restart.pkl&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">checkpointdata</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">checkpointdata</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="runClusterBootstrap"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.runClusterBootstrap">[docs]</a><span class="k">def</span> <span class="nf">runClusterBootstrap</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">boot_restart_file</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Instances a new run of *generic_wrapper.py* script on the cluster</span>

<span class="sd">    :param c_session: a :py:class:`drmaa.Session` instance for interacting with</span>
<span class="sd">                      the cluster.</span>

<span class="sd">    :param int i: index of spawned cluster job cluster. Max value is defined by</span>
<span class="sd">                  :option:`--nbootstrap` of the master *generic_wrapper.py*</span>
<span class="sd">                  run and is used to define cluster output log filenames.</span>

<span class="sd">    :param int b: the number of bootstrap iterations to run in this spawned</span>
<span class="sd">                  job. This option is passed as :option:`--nbootstrap`</span>
<span class="sd">                  to the spawned slave *generic_wrapper.py* run.</span>

<span class="sd">    :param str boot_restart_file: filename of the current restart file.</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * the cluster job ID</span>
<span class="sd">        * the filename of the cluster output log</span>
<span class="sd">        * the filename of the Rscript output results file</span>
<span class="sd">        * the filename of the spawned *generic_wrapper.py* logfile</span>

<span class="sd">    This function is called by :func:`clusterBootstrap`. The script uses</span>
<span class="sd">    :py:class:`subprocess.Popen` to call an external run of</span>
<span class="sd">    *generic_wrapper.py* but with the :option:`--bootstrapslave` set</span>
<span class="sd">    to slave it to the master run. The restart file specified</span>
<span class="sd">    with *boot_restart_file* is loaded by the spawned job and passes the script</span>
<span class="sd">    parameters tot he run. This ensures all bootstrap run use the correct</span>
<span class="sd">    parameters and, as a bonus, we don&#39;t need to calcualte things twice!</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *datapath* - path of the data files to parse.</span>
<span class="sd">        * *feature_annot* - the path to the `gff</span>
<span class="sd">          &lt;https://www.sanger.ac.uk/resources/software/gff/&gt;`_ file to use for</span>
<span class="sd">          gene summarization.</span>
<span class="sd">        * *outfile* - the output filename for the spawned cluster run. This is</span>
<span class="sd">          passed as :option:`--outfile` to the spawned *generic_wrapper.py* run.</span>
<span class="sd">        * *script_file* - the filename of the Rscript to run on the data. This</span>
<span class="sd">          is passed as :option:`--scriptfile` to the spawned</span>
<span class="sd">          *generic_wrapper.py* run.</span>
<span class="sd">        * *clustq* - the name of the cluster queue to submit jobs to.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    Note that this function includes a SGE-specific job submission parameter</span>
<span class="sd">    (in fact, they&#39;re quite possibly specific to our individual cluster!).</span>
<span class="sd">    Briefly, they are:</span>

<span class="sd">        * *-cwd* - specify running the job in the current working directory</span>
<span class="sd">        * *-clear* - clear any existing cluster queue settings.</span>
<span class="sd">        * *-q &#39;options.clustq&#39;* - specify the queue to submit the job to.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Cluster bootstrapping enabled. Running job &quot;</span>\
              <span class="s">&quot;</span><span class="si">%05i</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
              <span class="p">)</span>

    <span class="n">c_job</span> <span class="o">=</span> <span class="n">c_session</span><span class="o">.</span><span class="n">createJobTemplate</span><span class="p">()</span>

    <span class="c"># run itself!</span>
    <span class="c">#c_job.remoteCommand = &quot;%s %s&quot; % (sys.executable, sys.argv[0])</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">remoteCommand</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>

    <span class="n">fileout_details</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">))</span>
    <span class="n">thisjob_fileout</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">_</span><span class="si">%04i%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                        <span class="n">fileout_details</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">fileout_details</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">log_details</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">))</span>
    <span class="n">thisjob_log</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">_</span><span class="si">%04i%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
                                    <span class="n">fileout_details</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">log_details</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span>
            <span class="s">&quot;-a&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">feature_annot</span><span class="p">,</span>
            <span class="s">&quot;-o&quot;</span><span class="p">,</span> <span class="n">thisjob_fileout</span><span class="p">,</span>
            <span class="s">&quot;-l&quot;</span><span class="p">,</span> <span class="n">thisjob_log</span><span class="p">,</span>
            <span class="s">&quot;-r&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">script_file</span><span class="p">,</span>
            <span class="s">&quot;-b&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
            <span class="s">&quot;--tmpdir&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span>
            <span class="s">&quot;--bootstrapslave&quot;</span><span class="p">]</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">drmaa command line:</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c_job</span><span class="o">.</span><span class="n">remoteCommand</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_job</span><span class="o">.</span><span class="n">args</span><span class="p">)))</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">outputPath</span> <span class="o">=</span> <span class="s">&quot;:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">errorPath</span> <span class="o">=</span> <span class="s">&quot;:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>

    <span class="c"># pass current working directory (not that this is needed really, but hey!)</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="s">&quot;-cwd&quot;</span>

    <span class="c"># add support for different cluster queue specifications</span>
    <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="s">&quot;-clear -q &#39;</span><span class="si">%s</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">&quot;</span> \
                                <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">clustq</span><span class="p">,</span> <span class="n">c_job</span><span class="o">.</span><span class="n">nativeSpecification</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">drmaa output intermediates written to: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="n">c_job</span><span class="o">.</span><span class="n">jobEnvironment</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">c_session</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">c_job</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Job submitted with id: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">jobid</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/generic_wrapper.py.o</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">jobid</span><span class="p">),</span>
           <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">thisjob_fileout</span><span class="p">),</span> <span class="n">thisjob_log</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="clusterDistribute"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.clusterDistribute">[docs]</a><span class="k">def</span> <span class="nf">clusterDistribute</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nj</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; calculates optimum bootstrap dist over the specified cluster nodes</span>

<span class="sd">    :param int nb: total number of bootstraps</span>

<span class="sd">    :param int nj: total number of cluster nodes to use</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a list of tuples each containing:</span>

<span class="sd">        * the running total job count</span>
<span class="sd">        * the number of of bootstraps to run in that job</span>

<span class="sd">    The *options* instance must contain the *log* keywords containing the</span>
<span class="sd">    filename of the the log file to write to. This function is called by</span>
<span class="sd">    :func:`clusterBootstrap`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Calculating the optimum way of spreading </span><span class="si">%i</span><span class="s"> bootstrap &quot;</span> \
              <span class="s">&quot;runs over </span><span class="si">%i</span><span class="s"> nodes...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nj</span><span class="p">))</span>

    <span class="n">remaining_nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
    <span class="n">remaining_nj</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nj</span><span class="p">)</span>

    <span class="n">bootstrapout</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">total_nb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">remaining_nb</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>

        <span class="n">max_nb_job</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">remaining_nb</span><span class="o">/</span><span class="n">remaining_nj</span><span class="p">)</span>
        <span class="n">nj_max_nb_job</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">remaining_nb</span><span class="o">/</span><span class="n">max_nb_job</span><span class="p">)</span>
        <span class="n">total_nb</span> <span class="o">=</span> <span class="n">total_nb</span><span class="o">+</span><span class="p">(</span><span class="n">nj_max_nb_job</span><span class="o">*</span><span class="n">max_nb_job</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Allocating </span><span class="si">%.0f</span><span class="s"> runs to </span><span class="si">%.0f</span><span class="s"> nodes (</span><span class="si">%.0f</span><span class="s"> runs &quot;</span> \
                  <span class="s">&quot;assigned).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_nb_job</span><span class="p">,</span> <span class="n">nj_max_nb_job</span><span class="p">,</span> <span class="n">total_nb</span><span class="p">))</span>

        <span class="n">bootstrapout</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nj_max_nb_job</span><span class="p">,</span> <span class="n">max_nb_job</span><span class="p">))</span>
        <span class="n">remaining_nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">remaining_nb</span><span class="o">-</span><span class="p">(</span><span class="n">nj_max_nb_job</span><span class="o">*</span><span class="n">max_nb_job</span><span class="p">))</span>
        <span class="n">remaining_nj</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">remaining_nj</span><span class="o">-</span><span class="n">nj_max_nb_job</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">bootstrapout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="clusterBootstrap"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.clusterBootstrap">[docs]</a><span class="k">def</span> <span class="nf">clusterBootstrap</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; setup and run bootstrap iterations on the cluster</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: a tuple containing:</span>

<span class="sd">        * a list of cluster logfiles - one for each spawned job</span>
<span class="sd">        * a list of output sqlite databases containing DE results - one foe</span>
<span class="sd">          each spawned job</span>

<span class="sd">    This scrips takes in input options for the bootstrap runs and uses them to</span>
<span class="sd">    spawn a series of cluster runs of *generic_wrapper.py* (in slave mode) to</span>
<span class="sd">    actually do the DE calculations.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *nbootstrap* - number of bootstraps to run.</span>
<span class="sd">        * *njobs* - the max number of cluster jobs to spawn.</span>
<span class="sd">        * *restart* - toggle whether to use the *restart.pkl* file to start a</span>
<span class="sd">          run - this is used by the runs spawned by this function.</span>
<span class="sd">        * *nocluster* - toggle runnign the bootstraps on the cluster.</span>
<span class="sd">        * *bootmaster* - internally set variable denoting the input as the</span>
<span class="sd">          master script.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to write *restart.pkl* to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    The *options* instance must also contain all the keywords required by</span>
<span class="sd">    :func:`runClusterBootstrap`, :func:`clusterDistribute` and</span>
<span class="sd">    :func:`monitorDrmaaJobs`, all of which are called by this function and are</span>
<span class="sd">    passed the input :py:class:`optparse.Values` instance.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: running in cluster-bootstrap mode with </span><span class="si">%i</span><span class="s"> &quot;</span> \
              <span class="s">&quot;iterations&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span><span class="p">)))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: writing bootstrap data pickle...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

    <span class="c"># read existing restart information</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/restart.pkl&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">bootstrap_restardic</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># modify bootstrap options; set bootstrap slave, --nocluster</span>
    <span class="c"># and get the load distributions</span>
    <span class="n">bootstrap_restardic</span><span class="p">[</span><span class="s">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bootmaster</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">bootstrap_restardic</span><span class="p">[</span><span class="s">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nocluster</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">bootstrap_restardic</span><span class="p">[</span><span class="s">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># write new restart pkl</span>
    <span class="n">boot_restart_file</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/bootruns_restart.pkl&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">boot_restart_file</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">bootstrap_restardic</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># use drmaa to spread multiple jobs across the cluster.</span>
    <span class="n">c_session</span> <span class="o">=</span> <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">c_session</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="n">jobloads</span> <span class="o">=</span> <span class="n">clusterDistribute</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span><span class="p">),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">njobs</span><span class="p">),</span>
                                <span class="n">options</span><span class="p">)</span>

    <span class="c"># loop through the jobloads:</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">joblist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">boostrap_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">boostrap_logs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">boostrap_dbs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">jobload</span> <span class="ow">in</span> <span class="n">jobloads</span><span class="p">:</span>
        <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">jobload</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">runClusterBootstrap</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">jobload</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                          <span class="n">boot_restart_file</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

            <span class="n">joblist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">boostrap_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">boostrap_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">boostrap_dbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> jobs launched...&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
              <span class="p">)</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">exit_status</span><span class="p">,</span> <span class="n">sucess</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">monitorDrmaaJobs</span><span class="p">(</span><span class="n">c_session</span><span class="p">,</span> <span class="n">joblist</span><span class="p">,</span>
                                                          <span class="n">boostrap_dbs</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                                                          <span class="n">options</span><span class="p">,</span> <span class="n">delo</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                          <span class="n">dele</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># clearup job metadata and information</span>
    <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">joblist</span><span class="p">:</span>
        <span class="n">c_session</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span>
                              <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">TIMEOUT_WAIT_FOREVER</span><span class="p">,</span>
                              <span class="bp">True</span><span class="p">)</span>

    <span class="n">c_session</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">boostrap_logs</span><span class="p">,</span> <span class="n">boostrap_dbs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="results2sqlite"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.results2sqlite">[docs]</a><span class="k">def</span> <span class="nf">results2sqlite</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">results_files</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; converts the text output from n bootstrap runs into one sqlite db</span>

<span class="sd">    :param list features: a list of feature identified the DE has been</span>
<span class="sd">                          calculated for.</span>

<span class="sd">    :param list results_files: a list of DE output text files with a common</span>
<span class="sd">                              format. Output from :func:`runRDE`.</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: the filename of the resulting sqlite database, containing the</span>
<span class="sd">             results from all the files listed in results_files.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    This function takes the results from multiple DE textfiles and concatenates</span>
<span class="sd">    them into a single sqlite database that is written to the same directory as</span>
<span class="sd">    the input file. In this case, this should be the path given by</span>
<span class="sd">    *options.tmpdir* passed to :func:`runRDE`. The database structure is</span>
<span class="sd">    described :ref:`here &lt;genwrapout&gt;`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">dbfile</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">results_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;_rout&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">results_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">removing pre-existing version of </span><span class="si">%s</span><span class="s">... </span><span class="se">\n</span><span class="s">&quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">dbfile</span>
                      <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: merging bootstrap results to sqlite database (</span><span class="si">%s</span><span class="s">)&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">dbfile</span><span class="p">))</span>

    <span class="c"># make an sqlite db to hold the results (with foreign key support)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">building schema...&quot;</span><span class="p">)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA foreign_keys=ON&quot;</span><span class="p">)</span>

    <span class="c"># create features table</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE features(&quot;</span> \
                <span class="s">&quot;id INTEGER PRIMARY KEY, &quot;</span>\
                <span class="s">&quot;featureID TEXT, &quot;</span> \
                <span class="s">&quot;name TEXT, &quot;</span> \
                <span class="s">&quot;desc BLOB)&quot;</span>
              <span class="p">)</span>

    <span class="c"># create bootstrap iteration table</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE bootstraps(&quot;</span> \
                <span class="s">&quot;id INTEGER PRIMARY KEY, &quot;</span> \
                <span class="s">&quot;comments BLOB, &quot;</span> \
                <span class="s">&quot;deruntime_sec REAL)&quot;</span>
              <span class="p">)</span>

    <span class="c"># define cols for foreign key links</span>
    <span class="n">col_str</span> <span class="o">=</span> <span class="s">&quot;id INTEGER PRIMARY KEY, &quot;</span> \
              <span class="s">&quot;featureid INTEGER, &quot;</span> \
              <span class="s">&quot;bsid INTEGER, &quot;</span>

    <span class="c"># define foreign key links</span>
    <span class="n">fkey_str</span> <span class="o">=</span> <span class="s">&quot;FOREIGN KEY(featureid) REFERENCES features(id), &quot;</span> \
               <span class="s">&quot;FOREIGN KEY(bsid) REFERENCES bootstraps(id)&quot;</span>

    <span class="c"># get column headers</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^#&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;\.&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())))</span>
            <span class="k">break</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="c"># construct create table columns</span>
    <span class="n">col_str</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s"> REAL, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_str</span><span class="p">,</span><span class="s">&quot; REAL, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">fkey_str</span><span class="p">)</span>
    
    <span class="c"># create DEresutls table - shouldn&#39;t realy use %s here, but screw it!</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE DEresults(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">col_str</span><span class="p">)</span>

    <span class="c"># first insert features</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">loading </span><span class="si">%i</span><span class="s"> features...&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>

    <span class="c"># features needs to be converted to a list of tuples first</span>
    <span class="n">feature_tups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">l</span><span class="p">,)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">features</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s">&#39;INSERT INTO features VALUES (NULL,?,&quot;&quot;,&quot;&quot;)&#39;</span><span class="p">,</span> <span class="n">feature_tups</span><span class="p">)</span>

    <span class="c"># get features primary-key dictionary</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT featureid, id FROM features&quot;</span><span class="p">)</span>
    <span class="n">feature_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span><span class="c">#</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">munging results from files...&quot;</span><span class="p">)</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">filedata</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">results_files</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">filelines</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t\t</span><span class="si">%s</span><span class="s"> (</span><span class="si">%i</span><span class="s"> lines)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                 <span class="nb">len</span><span class="p">(</span><span class="n">filelines</span><span class="p">))</span>
                      <span class="p">)</span>

        <span class="n">bsid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ncom</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ndat</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">comments</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^#&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">comments</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">ncom</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">j</span><span class="o">==</span><span class="n">ncom</span><span class="p">:</span>
                <span class="n">db_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">comments</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO bootstraps VALUES(NULL, ?, ?)&quot;</span><span class="p">,</span><span class="n">db_tup</span><span class="p">)</span>
                <span class="n">bsid</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastrowid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linedata</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

                <span class="n">k</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">datalist</span><span class="o">=</span><span class="p">[</span><span class="n">feature_dic</span><span class="p">[</span><span class="n">linedata</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">bsid</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">k</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">linedata</span><span class="p">):</span>
                    <span class="n">datalist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linedata</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>

                <span class="n">filedata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">datalist</span><span class="p">))</span>
                <span class="n">ndat</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">inserting data...&quot;</span><span class="p">)</span>

    <span class="n">de_insertstr</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO DEresults VALUES (NULL,</span><span class="si">%s</span><span class="s">)&quot;</span> \
                   <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;,$&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;?,&quot;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="k">print</span> <span class="n">de_insertstr</span>
    <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">de_insertstr</span><span class="p">,</span> <span class="n">filedata</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="concatSqliteFiles"><a class="viewcode-back" href="../bootstrapping.html#generic_wrapper.concatSqliteFiles">[docs]</a><span class="k">def</span> <span class="nf">concatSqliteFiles</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Concatenates many sqlite files with the same schema</span>

<span class="sd">    :param options: a valid :py:class:`optparse.Values` instance.</span>

<span class="sd">    :return: the output filename for the concatenated sqlite database.</span>

<span class="sd">    The *options* instance must contain the keywords:</span>

<span class="sd">        * *outfile* - the output filename for the final file.</span>
<span class="sd">        * *log* - filename of the the log file to write to.</span>
<span class="sd">        * *tmpdir*- the temporary directory to search for *.db* files in.</span>
<span class="sd">        * *verbose* - boolean toggle for verbose logging.</span>

<span class="sd">    This function takes in multiple sqlite database files with the same</span>
<span class="sd">    structure and concatenates them into a single output database. It assumes</span>
<span class="sd">    that the intermediaty database files are located in the path listed in</span>
<span class="sd">    *options.tmpdir* and also assumes they have the unique extension *.db*.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">alltmpfiles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="n">dbfiles</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">alltmpfiles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;.db&quot;</span><span class="p">:</span>
            <span class="n">dbfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="c">## TODO - check that dbfiles actually found some files. Otherwise crashes</span>
    <span class="c">##        later...</span>
    <span class="c">##      - in fact this should check that the number of dbfiles matches the</span>
    <span class="c">##        number of reps</span>

    <span class="n">dbfile</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: merging bootstrap results to final sqlite database (</span><span class="si">%s</span><span class="s">)&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">dbfile</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: sqlite database file (</span><span class="si">%s</span><span class="s">) already exists! &quot;</span> \
                  <span class="s">&quot;Overwriting... &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">dbfile</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">building schema...&quot;</span><span class="p">)</span>

    <span class="c"># make an sqlite db to hold the results (with foreign key support)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA foreign_keys=ON&quot;</span><span class="p">)</span>

    <span class="c"># create features table</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE features(&quot;</span> \
                <span class="s">&quot;id INTEGER PRIMARY KEY, &quot;</span>\
                <span class="s">&quot;featureID TEXT, &quot;</span> \
                <span class="s">&quot;name TEXT, &quot;</span> \
                <span class="s">&quot;desc BLOB)&quot;</span>
              <span class="p">)</span>

    <span class="c"># create logfile table</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE bslogs(&quot;</span> \
                <span class="s">&quot;id INTEGER PRIMARY KEY, &quot;</span> \
                <span class="s">&quot;log BLOB)&quot;</span>
              <span class="p">)</span>

    <span class="c"># create bootstrap iteration table</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE bootstraps(&quot;</span> \
                <span class="s">&quot;id INTEGER PRIMARY KEY, &quot;</span> \
                <span class="s">&quot;bsinlogid INTEGER, &quot;</span> \
                <span class="s">&quot;comments BLOB, &quot;</span> \
                <span class="s">&quot;deruntime_sec REAL, &quot;</span> \
                <span class="s">&quot;logid INTEGER, &quot;</span> \
                <span class="s">&quot;FOREIGN KEY(logid) REFERENCES bslogs(id))&quot;</span>
              <span class="p">)</span>

    <span class="c"># define cols for foreign key links</span>
    <span class="n">col_str</span> <span class="o">=</span> <span class="s">&quot;id INTEGER PRIMARY KEY, &quot;</span> \
              <span class="s">&quot;featureid INTEGER, &quot;</span> \
              <span class="s">&quot;bsid INTEGER, &quot;</span>

    <span class="c"># define foreign key links</span>
    <span class="n">fkey_str</span> <span class="o">=</span> <span class="s">&quot;FOREIGN KEY(featureid) REFERENCES features(id), &quot;</span> \
               <span class="s">&quot;FOREIGN KEY(bsid) REFERENCES bootstraps(id)&quot;</span> \
               <span class="s">&quot;&quot;</span>

    <span class="c"># connect to the first file</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;ATTACH &#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39; AS db2&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">dbfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c"># get columns</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA db2.table_info(DEresults)&quot;</span><span class="p">)</span>
    <span class="n">coldata</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">colids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">coldata</span><span class="p">):</span>
        <span class="n">colids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coldata</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">col_str</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s"> REAL, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_str</span><span class="p">,</span><span class="s">&quot; REAL, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colids</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span> <span class="n">fkey_str</span><span class="p">)</span>

    <span class="c"># create DEresutls table - shouldn&#39;t realy use %s here, but screw it!</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE DEresults(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">col_str</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">adding results and log information from &quot;</span>
                  <span class="s">&quot;itermiadary database files...&quot;</span><span class="p">)</span>

    <span class="n">gfeatures</span><span class="o">=</span><span class="bp">None</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">dbfiles</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">file</span><span class="p">)</span>

        <span class="c"># read the relevant logfile and put log into the database</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.log&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">logdata</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">dbtup</span> <span class="o">=</span> <span class="p">(</span><span class="n">logdata</span><span class="p">,)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO bslogs VALUES(NULL,?)&quot;</span><span class="p">,</span> <span class="n">dbtup</span><span class="p">)</span>
        <span class="n">logid</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastrowid</span>

        <span class="c"># connect to the relevant database</span>
        <span class="n">conn2</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">conn2</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA foreign_keys=ON&quot;</span><span class="p">)</span>

        <span class="c"># if its the first run, add feature information to the database</span>
        <span class="k">if</span> <span class="n">gfeatures</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT featureID, name, desc FROM features&quot;</span><span class="p">)</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s">&quot;INSERT INTO features VALUES(NULL,?,?,? )&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT * FROM features&quot;</span><span class="p">)</span>
            <span class="n">gfeatures</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c"># check that the features all appear int he same order.</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT * FROM features&quot;</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">features</span><span class="o">!=</span><span class="n">gfeatures</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;uh oh!&quot;</span>
            <span class="n">filehandle</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;featdump.pkl&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">gfeatures</span><span class="p">),</span><span class="n">filehandle</span><span class="p">)</span>
            <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># then get bs metadata and add the data that corresponds to that</span>
        <span class="c"># bootstrap</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT * FROM bootstraps&quot;</span><span class="p">)</span>
        <span class="n">bsinfo</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bsinfo</span><span class="p">:</span>
            <span class="c"># first insert bootstrap info</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO bootstraps VALUES(NULL,?,?,?,</span><span class="si">%s</span><span class="s">)&quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">logid</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">bsid</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastrowid</span>

            <span class="c"># get data corresponding to this bootstrap run</span>
            <span class="n">c2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT featureid, </span><span class="si">%s</span><span class="s"> FROM DEresults where bsid=?&quot;</span> \
                       <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colids</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span>
                       <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
                       <span class="p">)</span>
            <span class="n">c2data</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="n">insert_str</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO DEresults VALUES(NULL,?,</span><span class="si">%i</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> \
                         <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bsid</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;,$&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;?,&quot;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c2data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">insert_str</span><span class="p">,</span> <span class="n">c2data</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c"># parse command line options - note that because we&#39;re using python 2.6.4,</span>
    <span class="c"># and hence optparse rather than argparse, I&#39;m forcing everything to be an</span>
    <span class="c"># &#39;option&#39; even if it is required.</span>

    <span class="c"># define options</span>
    <span class="n">optslist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="s">&quot;-d&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--datapath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;datapath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;Path to the data directory of the &quot;</span> \
                                <span class="s">&quot;experiment. Each sub-directory in this path&quot;</span> \
                                <span class="s">&quot;will be treated as a separate condition in &quot;</span> \
                                <span class="s">&quot;the experiment (with the name of the &quot;</span> \
                                <span class="s">&quot;condition matching the name of the &quot;</span> \
                                <span class="s">&quot;directory), and each .bam file (or .gbgout &quot;</span> \
                                <span class="s">&quot;files if the --precounts flag is set) in &quot;</span> \
                                <span class="s">&quot;each directory is a replicate for that &quot;</span> \
                                <span class="s">&quot;condition (BAM file indexes for each file &quot;</span>\
                                <span class="s">&quot;should have the same filename, with .bai &quot;</span> \
                                <span class="s">&quot;post-pended).&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_path&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-a&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--annotation&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;feature_annot&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Path to the .gff feature annotation file &quot;</span> \
                                 <span class="s">&quot;for the data. This file should match the &quot;</span> \
                                 <span class="s">&quot;feature you are counting the RNA-Seq &quot;</span> \
                                 <span class="s">&quot;expression for.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_path&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-r&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--scriptfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;script_file&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Name and path of script file to execute &quot;</span> \
                                 <span class="s">&quot;in order to perform differential gene &quot;</span> \
                                 <span class="s">&quot;expression analysis.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_file&quot;</span>
                     <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-o&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--outfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;outfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The name (inc. path if different from the &quot;</span> \
                                 <span class="s">&quot;current working directory) of the output &quot;</span> \
                                 <span class="s">&quot;file containing the DE results.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;output_file&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-l&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--logfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;log&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The name (inc. path if different from the &quot;</span> \
                                 <span class="s">&quot;current working directory) of the log &quot;</span> \
                                 <span class="s">&quot;file from running this script.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;output_file&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="s">&quot;-s&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--species&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;species&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;The species used to generate the RNA-Seq &quot;</span> \
                                <span class="s">&quot;data. This is used by the ensembl API to &quot;</span> \
                                <span class="s">&quot;annotate the features found, so it must be &quot;</span> \
                                <span class="s">&quot;recognizable to ensembl. For convenience &quot;</span> \
                                <span class="s">&quot;the default is &#39;Saccharomyces cerevisiae&#39;.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>   <span class="s">&quot;None&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="s">&#39;s_cerevisiae&#39;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="s">&quot;-v&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--verbose&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;verbose&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;Turn on verbose logging.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">False</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--precounts&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;precounts&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;If this option is set, the script looks for pre-&quot;</span> \
                            <span class="s">&quot;generated gene count files in  the --datapath. &quot;</span> \
                            <span class="s">&quot;If found, these gene count files are used in &quot;</span> \
                            <span class="s">&quot;place of bam files and gene count summarization &quot;</span> \
                            <span class="s">&quot;is skipped. If this option is set and no gene &quot;</span> \
                            <span class="s">&quot;count files are found then the script will &quot;</span> \
                            <span class="s">&quot;default tot he bam files and will do gene count &quot;</span> \
                            <span class="s">&quot;summarization. If the --savecounts flag is set, &quot;</span> \
                            <span class="s">&quot;with this option and no gene count files are &quot;</span> \
                            <span class="s">&quot;found, summarization will be done and the files &quot;</span> \
                            <span class="s">&quot;saved to --datapath. Defaults to False.&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">False</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;counting&quot;</span>
                <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--precount_fileext&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;precount_fileext&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The file extension of pre-generated gene count &quot;</span> \
                            <span class="s">&quot;data. Defaults to &#39;gbgout&#39;.&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="s">&#39;gbgout&#39;</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;counting&quot;</span>
                <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--savecounts&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;savecounts&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;If this flag is set, the gene count files from &quot;</span> \
                            <span class="s">&quot;running the count summarization part of the &quot;</span> \
                            <span class="s">&quot;code  will be saved to --datapath&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">False</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;counting&quot;</span>
                <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>        <span class="s">&quot;-f&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>         <span class="s">&quot;--feature&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>         <span class="s">&quot;feature&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>       <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>         <span class="s">&quot;Sets the level at which you count the &quot;</span> \
                                     <span class="s">&quot; RNA-Seq signal. Options are: gene &quot;</span> \
                                     <span class="s">&quot;(default) &amp; transcript.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>        <span class="s">&quot;counting&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>      <span class="s">&quot;gene_id&quot;</span><span class="p">,</span>
                     <span class="s">&quot;allowed_vals&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;gene_id&quot;</span><span class="p">,</span><span class="s">&quot;transcript_id&quot;</span><span class="p">]</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>        <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>         <span class="s">&quot;--count-method&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>         <span class="s">&quot;cmeth&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>       <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>         <span class="s">&quot;Choose the method used for counting &quot;</span> \
                                     <span class="s">&quot; the reads for each feature. Options &quot;</span> \
                                     <span class="s">&quot;are: union (default), istrict, &quot;</span> \
                                     <span class="s">&quot;noempty &amp; cufflinks (not yet used)&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>        <span class="s">&quot;counting&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>      <span class="s">&quot;union&quot;</span><span class="p">,</span>
                     <span class="s">&quot;allowed_vals&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;union&quot;</span><span class="p">,</span> <span class="s">&quot;istrict&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;inoempty&quot;</span><span class="p">]</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>        <span class="s">&quot;-n&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>         <span class="s">&quot;--norm&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>         <span class="s">&quot;norm&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>       <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>         <span class="s">&quot;Normalization method for the tool &quot;</span> \
                                     <span class="s">&quot;being wrapped. Options are: &quot;</span> \
                                     <span class="s">&quot;package:normtype (uses a normtype &quot;</span> \
                                     <span class="s">&quot;method available in the package), &quot;</span>\
                                     <span class="s">&quot;none (default), pmrm (norm by Per &quot;</span> \
                                     <span class="s">&quot;Million Reads Mapped), fpkm (norm by &quot;</span> \
                                     <span class="s">&quot;Fragments Per Kilobase of exon per &quot;</span> \
                                     <span class="s">&quot;Million fragments mapped), rpkm norm &quot;</span> \
                                     <span class="s">&quot;by Reads Per Kilobase of exon per &quot;</span> \
                                     <span class="s">&quot;Million reads mapped), tmm (norm by &quot;</span> \
                                     <span class="s">&quot;Trimmed Mean of M component) &amp; quartile.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>        <span class="s">&quot;normalization&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>      <span class="s">&quot;package:normtype&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--gbgfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;gbgpath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The full path to the group_by_gene.pl &quot;</span> \
                                 <span class="s">&quot;script that this script will call to &quot;</span> \
                                 <span class="s">&quot;run htseq-count. The default location &quot;</span> \
                                 <span class="s">&quot;for group_by_gene.pl is in the same &quot;</span> \
                                 <span class="s">&quot;directory as this script.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="s">&quot;Bootstrapping/group_by_gene.pl&quot;</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_path&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--agncfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;agncpath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The full path to the &quot;</span> \
                                 <span class="s">&quot;add_gene_name_column.pl script that this &quot;</span> \
                                 <span class="s">&quot;script will call to annotate the output &quot;</span> \
                                 <span class="s">&quot;from group_by_gene.pl. The default &quot;</span> \
                                 <span class="s">&quot;location for add_gene_name_column.pl is &quot;</span> \
                                 <span class="s">&quot;in the same directory as this script.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="s">&quot;Bootstrapping/add_gene_name_column.pl&quot;</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_path&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--Rpath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;rpath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Specify path to &#39;Rscript&#39; executable. &quot;</span> \
                                 <span class="s">&quot;Defaults to /sw/opt/R/3.2.2/bin/Rscript&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="s">&quot;/usr/bin/Rscript&quot;</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_file&quot;</span>
                     <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--perlpath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;perlpath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Specify path to perl executable.&quot;</span> \
                                 <span class="s">&quot;Defaults too /usr/bin/perl&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="s">&quot;/usr/bin/perl&quot;</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_file&quot;</span>
                     <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--tmpdir&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;tmpdir&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;The full path of the temp dir you with to &quot;</span> \
                                <span class="s">&quot;use for storing intermediate files. The &quot;</span> \
                                <span class="s">&quot;default location for this is a dir called &quot;</span> \
                                <span class="s">&quot;&#39;.DEtemp&#39; in the current directory.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/.DEtemp&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--keep-tmpdir&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;keep_tmpdir&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;Toggle whether to keep tmpdir on &quot;</span> \
                                <span class="s">&quot;successful completion. Default is to not &quot;</span> \
                                <span class="s">&quot;keep tmpdir.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">False</span>
                     <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--nocluster&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;nocluster&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;Enable cluster support through &quot;</span> \
                                <span class="s">&quot;drmaa-python. The default is True&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--clustq&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;clustq&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;Set the q to use to run cluster jobs. &quot;</span> \
                                <span class="s">&quot;Default is 64bit-pri.q.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="s">&quot;64bit-pri.q&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--samtoolspath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;samtoolspath&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The full path to the samtools instalation &quot;</span> \
                                 <span class="s">&quot;you want to use to manipulate sam/bam &quot;</span> \
                                 <span class="s">&quot;files. The default location for samtools &quot;</span> \
                                 <span class="s">&quot;is /local/bin/samtools&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="s">&quot;/usr/bin/samtools&quot;</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_path&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>    <span class="s">&quot;--restart&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>    <span class="s">&quot;restart&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>  <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>    <span class="s">&quot;Restart a failed job. Will attempt to run &quot;</span> \
                                <span class="s">&quot;process after the last successfully &quot;</span> \
                                <span class="s">&quot;completed step.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>   <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">False</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-i&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--includelist&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;inc_reps&quot;</span><span class="p">,</span>
                     <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Filename with the filenames of specific &quot;</span> \
                                 <span class="s">&quot;replicates that must be included in the data&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;selection&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_file&quot;</span>
                     <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-e&quot;</span><span class="p">,</span>
                    <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--excludelist&quot;</span><span class="p">,</span>
                    <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;exc_reps&quot;</span><span class="p">,</span>
                    <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                    <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Filename with the filenames of specific&quot;</span> \
                                <span class="s">&quot;replicates that must be excluded from the data&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;selection&quot;</span><span class="p">,</span>
                    <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_file&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-k&quot;</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--kreps&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;kreps&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The number of replicates to use. Replicates &quot;</span> \
                            <span class="s">&quot;listed in --excludelist are subtracted first. &quot;</span> \
                            <span class="s">&quot;Then, if this is None (default) or the number &quot;</span> \
                            <span class="s">&quot;is greater than remaining number of replicates,&quot;</span>\
                            <span class="s">&quot; then all the replicates are used. If this &quot;</span> \
                            <span class="s">&quot;value is less than the remaining number of &quot;</span> \
                            <span class="s">&quot;replicates, then this number of replicates is &quot;</span> \
                            <span class="s">&quot;selected at random for each run.&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;selection&quot;</span>
                <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-b&quot;</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--nbootstrap&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;nbootstrap&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The number of bootstrap iterations to run. &quot;</span> \
                            <span class="s">&quot;Default is None&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;selection&quot;</span>
                <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--bootstrapmaster&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;bootmaster&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Is this a master script initiating a bootstrap? &quot;</span> \
                            <span class="s">&quot;Default is False. This parameter should never &quot;</span> \
                            <span class="s">&quot;be changed by the user, it is set internally.&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">True</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;selection&quot;</span>
                <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--bootstrapslave&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;bootslave&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;Is this a slave script for a cluster bootstrap? &quot;</span> \
                            <span class="s">&quot;Default is False. This parameter should never &quot;</span> \
                            <span class="s">&quot;be changed by the user, it is set internally.&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="bp">False</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;selection&quot;</span>
                <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">&quot;short&quot;</span><span class="p">:</span>    <span class="s">&quot;-j&quot;</span><span class="p">,</span>
                <span class="s">&quot;long&quot;</span><span class="p">:</span>     <span class="s">&quot;--njobs&quot;</span><span class="p">,</span>
                <span class="s">&quot;dest&quot;</span><span class="p">:</span>     <span class="s">&quot;njobs&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span><span class="p">:</span>   <span class="s">&quot;store&quot;</span><span class="p">,</span>
                <span class="s">&quot;help&quot;</span><span class="p">:</span>     <span class="s">&quot;The number of cluster jobs to spawn if not &quot;</span> \
                            <span class="s">&quot;--nocluster. Default is 400&quot;</span><span class="p">,</span>
                <span class="s">&quot;default&quot;</span><span class="p">:</span>  <span class="mi">400</span><span class="p">,</span>
                <span class="s">&quot;group&quot;</span><span class="p">:</span>    <span class="s">&quot;selection&quot;</span>
                <span class="p">})</span>

    <span class="c"># usage string</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">%prog -d|--datapath &lt;path&gt; -a|--annotation &lt;file&gt; -r|--scriptfile &lt;file&gt;</span>
<span class="s">-o|--outfile &lt;file&gt; -l|--logfile &lt;file&gt; [-s|species &lt;str&gt;] [--precounts]</span>
<span class="s">[--precount_fileext &lt;str&gt;] [--savecounts] [-f|--feature &lt;str&gt;]</span>
<span class="s">[-c|--count-method &lt;str&gt;] [-n|--norm &lt;str&gt;] [-k|--kreps &lt;int&gt;]</span>
<span class="s">[-b|--nbootstrap &lt;int&gt;] [--includelist &lt;file&gt;] [--excludelist &lt;file&gt;]</span>
<span class="s">[--gbgfile &lt;path&gt;&lt;filename&gt;] [--agncfile &lt;path&gt;&lt;filename&gt;][--Rpath &lt;path&gt;]</span>
<span class="s">[--perlpath &lt;path&gt;] [--tmpdir &lt;path&gt;] [--keep-tmpdir] [--samtoolspath &lt;path&gt;]</span>
<span class="s">[--njobs &lt;int&gt;] [--clustq &lt;str&gt;] [--nocluster] [--tmpdir &lt;path&gt;]</span>
<span class="s">[--keep-tempdir] [--restart] [--version] [-v|--verbose] [--help]</span>
<span class="s">&quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;%prog v&quot;</span><span class="o">+</span><span class="n">version_string</span><span class="p">)</span>

    <span class="c">#define option groups</span>
    <span class="n">reqgroup</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">&quot;Required Arguments&quot;</span><span class="p">)</span>
    <span class="n">csgroup</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span>
                          <span class="s">&quot;Feature Counting Options&quot;</span><span class="p">,</span>
                          <span class="s">&quot;This script uses htseq-count, implementd by the &quot;</span> \
                          <span class="s">&quot;script &#39;group_by_gene.pl&#39; to summarize RNA-Seq &quot;</span> \
                          <span class="s">&quot;read counts for the specified genomic features. &quot;</span> \
                          <span class="s">&quot;See group_by_gene.pl --man for more details on &quot;</span> \
                          <span class="s">&quot;this script. See http://tinyurl.com/cg88yso for &quot;</span> \
                          <span class="s">&quot;more on htseq-count. Note: group_by_gene.pl &quot;</span> \
                          <span class="s">&quot;doesn&#39;t currently support choosing different &quot;</span> \
                          <span class="s">&quot;feature types, or different counting methods, so &quot;</span> \
                          <span class="s">&quot;these options do nothing at the moment!&quot;</span><span class="p">)</span>
    <span class="n">normgroup</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">&quot;Normalization Options&quot;</span><span class="p">,</span>
                            <span class="s">&quot;Many Differential Expression tools are &quot;</span> \
                            <span class="s">&quot;designed to use a specific normalization. This &quot;</span> \
                            <span class="s">&quot;script keeps this option, but where possible &quot;</span> \
                            <span class="s">&quot;allows &#39;standard&#39; normalizations so that the &quot;</span> \
                            <span class="s">&quot;impact of changing the normalization can be &quot;</span> \
                            <span class="s">&quot;examind, and so that the results from different &quot;</span> \
                            <span class="s">&quot;DE tools can be compared on an even footing.&quot;</span><span class="p">)</span>
    <span class="n">selgroup</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">&quot;Selection and Bootstrap Options&quot;</span><span class="p">,</span>
                            <span class="s">&quot;These options concern subselecting the total &quot;</span> \
                            <span class="s">&quot;number of replicates and running bootstrap &quot;</span> \
                            <span class="s">&quot;iterations of tools. They allow you to specify &quot;</span> \
                            <span class="s">&quot;individual replicates you want to include, or &quot;</span> \
                            <span class="s">&quot;exclude, as well as how many random replicates &quot;</span> \
                            <span class="s">&quot;to select from the remaining set, and how many &quot;</span> \
                            <span class="s">&quot;bootstrap iterations to perform.&quot;</span><span class="p">)</span>

    <span class="c"># add options to the groups</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">optslist</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;group&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;required&quot;</span><span class="p">:</span>
                <span class="n">reqgroup</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                    <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span>
                                    <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;group&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;counting&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">csgroup</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                       <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span>
                                       <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span>
                                       <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">csgroup</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span>
                                       <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span>
                                       <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;group&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;normalization&quot;</span><span class="p">:</span>
                <span class="n">normgroup</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                     <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span>
                                     <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;group&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;selection&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">selgroup</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                        <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span>
                                        <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span>
                                        <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selgroup</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span>
                                        <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span>
                                        <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                      <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span>
                                      <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span>
                                      <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span>
                                      <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">val</span>
            <span class="k">raise</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c"># add groups to the parser</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">reqgroup</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">csgroup</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">normgroup</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">selgroup</span><span class="p">)</span>

    <span class="c"># parse arguments</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c"># ==========</span>
    <span class="c"># Start with housekeeping, option parsing</span>
    <span class="c"># ==========</span>
    <span class="n">restart_dic</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">bootslave</span><span class="p">:</span>

        <span class="c"># load generic data if running as a bootstrap slave</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/bootruns_restart.pkl&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># store run specfic options</span>
        <span class="n">thisjob_fileout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span>
        <span class="n">thisjob_b</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span>
        <span class="n">thisjob_log</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">log</span>

        <span class="c"># overwrite options</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;options&quot;</span><span class="p">]</span>

        <span class="n">options</span><span class="o">.</span><span class="n">masterworkingdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">masterfileout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">thisjob_fileout</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># overwrite tmpdir if there is an appropriate local env var</span>
            <span class="k">if</span> <span class="s">&quot;SGE_TEMP&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;SGE_TEMP&quot;</span><span class="p">],</span>
                                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s">&quot;TMPDIR&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;TMPDIR&quot;</span><span class="p">],</span>
                                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">))</span>

        <span class="c"># restore run-specific options</span>
        <span class="n">options</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">),</span>
                                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">thisjob_fileout</span><span class="p">))</span>

        <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span> <span class="o">=</span> <span class="n">thisjob_b</span>
        <span class="n">options</span><span class="o">.</span><span class="n">bootmaster</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">options</span><span class="o">.</span><span class="n">bootslave</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">options</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">thisjob_log</span><span class="p">)</span>

        <span class="c"># open the logfile and write the basic header information</span>
        <span class="n">write_log_header</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">,</span> <span class="n">version_string</span><span class="o">=</span><span class="n">version_string</span><span class="p">,</span>
                         <span class="n">imported_modules</span><span class="o">=</span><span class="n">imported_modules</span><span class="p">)</span>

        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Running as a cluster bootstrap iteration. &quot;</span> \
                  <span class="s">&quot;Loading pre-processed details...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

        <span class="n">createNewTempdir</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="c">#log.write(&quot;\t\tworking in: %s&quot; % os.environ[&quot;TMPDIR&quot;])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">tmpdir is: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">restart</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/restart.pkl&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;options&quot;</span><span class="p">]</span>

        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Restarting run from file at restart position &quot;</span> \
                  <span class="s">&quot;</span><span class="si">%i</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># check that all required options have been provided</span>
        <span class="n">parse_required_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">)</span>

        <span class="c"># check all values are allowed, or default to, well, the defaults!</span>
        <span class="n">parse_allowed_values</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">)</span>

        <span class="c"># check that all options are of the right type (if specified)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">parse_option_type</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">)</span>

        <span class="c"># open the logfile and write the basic header information</span>
        <span class="n">write_log_header</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">,</span> <span class="n">version_string</span><span class="o">=</span><span class="n">version_string</span><span class="p">)</span>

        <span class="c"># remove/create tmpdir</span>
        <span class="n">createNewTempdir</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># ==========</span>
    <span class="c"># Parse the experiment directory structure</span>
    <span class="c">#     - allow for restart</span>
    <span class="c"># ==========</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">all_replicates</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">includelist</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">restart_dic</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">experiment_data</span> <span class="o">=</span> <span class="n">parse_experiment_data</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                          <span class="s">&quot;options&quot;</span><span class="p">:</span><span class="n">options</span><span class="p">,</span>
                          <span class="s">&quot;experiment&quot;</span><span class="p">:</span><span class="n">experiment_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="s">&quot;all_replicates&quot;</span><span class="p">:</span><span class="n">experiment_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="s">&quot;includelist&quot;</span><span class="p">:</span><span class="n">experiment_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                          <span class="s">&quot;do_genecounts&quot;</span><span class="p">:</span><span class="n">experiment_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
        <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded experiment details&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">experiment</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;experiment&quot;</span><span class="p">]</span>
    <span class="n">all_replicates</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;all_replicates&quot;</span><span class="p">]</span>
    <span class="n">includelist</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;includelist&quot;</span><span class="p">]</span>
    <span class="n">do_genecounts</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;do_genecounts&quot;</span><span class="p">]</span>

    <span class="c"># ==========</span>
    <span class="c"># Map the reads in bam files to Genes using group_by_gene script</span>
    <span class="c">#     - allow for restart</span>
    <span class="c"># ==========</span>
    <span class="n">gene_count_files</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_genecounts</span><span class="p">:</span>
            <span class="n">gene_count_files</span> <span class="o">=</span> <span class="n">get_gene_counts</span><span class="p">(</span><span class="n">all_replicates</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gene_count_files</span> <span class="o">=</span> <span class="n">all_replicates</span>

        <span class="n">restart_update</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;gene_count_files&quot;</span><span class="p">:</span><span class="n">gene_count_files</span><span class="p">,</span>
                        <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>

        <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                      <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gene_count_files</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;gene_count_files&quot;</span><span class="p">]</span>

        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded gene_count file details&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># ==========</span>
    <span class="c"># Read the gene count files and aggregate them to a data structure</span>
    <span class="c">#     - allow for restart</span>
    <span class="c"># ==========</span>
    <span class="n">exprs_data</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
        <span class="c"># read datafiles</span>
        <span class="n">exprs_data</span> <span class="o">=</span> <span class="n">read_expression_data</span><span class="p">(</span><span class="n">gene_count_files</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;exprs_data&quot;</span><span class="p">:</span><span class="n">exprs_data</span><span class="p">,</span>
                          <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>

        <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                      <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exprs_data</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;exprs_data&quot;</span><span class="p">]</span>

        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded gene expression data&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># ==========</span>
    <span class="c"># Branch the code for performing a single calculation, or performing a</span>
    <span class="c"># replicate bootstrap.</span>
    <span class="c"># ==========</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">bootmaster</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">options</span><span class="o">.</span><span class="n">bootslave</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">nocluster</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">bootmaster</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">options</span><span class="o">.</span><span class="n">bootslave</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">nocluster</span><span class="p">:</span>

        <span class="c"># construct and launch the cluster bootstrap jobs...</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">:</span>
            <span class="n">outfiles</span> <span class="o">=</span> <span class="n">clusterBootstrap</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;outfiles&quot;</span><span class="p">:</span><span class="n">outfiles</span><span class="p">,</span>
                              <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">8</span><span class="p">}</span>

            <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                              <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfiles</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;outfiles&quot;</span><span class="p">]</span>

            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded intermediary databases&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># concatenate the job databases to a single sqlite database</span>
        <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">9</span><span class="p">:</span>
            <span class="n">masterout</span> <span class="o">=</span> <span class="n">concatSqliteFiles</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

            <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;masterout&quot;</span><span class="p">:</span><span class="n">masterout</span><span class="p">,</span>
                              <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">9</span><span class="p">}</span>

            <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                              <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">masterout</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;masterout&quot;</span><span class="p">]</span>

            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded results, you should never really be here &quot;</span> \
                      <span class="s">&quot;unless the cleanup failed!&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">bootmaster</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">nboot</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">nboot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span><span class="p">)</span>
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: running in inline bootstrap mode with </span><span class="si">%i</span><span class="s"> &quot;</span> \
                          <span class="s">&quot;iterations&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">nboot</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: running in single-run mode (no bootstrap)&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>

            <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;nbootstrap_i&quot;</span><span class="p">:</span><span class="n">i</span><span class="p">,</span>
                              <span class="s">&quot;nboot&quot;</span><span class="p">:</span><span class="n">nboot</span><span class="p">,</span>
                              <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">}</span>

            <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                              <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;nbootstrap_i&quot;</span><span class="p">]</span>
            <span class="n">nboot</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;nboot&quot;</span><span class="p">]</span>

            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded bootstrap details:&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">number of bootstrap runs: </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">nboot</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">restarting at bootstrap run: </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;i: </span><span class="si">%i</span><span class="s">, nboot: </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nboot</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;restart position: </span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">DEfiles</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">featureset</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nboot</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">nboot</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> ##############################</span><span class="se">\n</span><span class="s">&quot;</span> \
                          <span class="s">&quot; </span><span class="si">%s</span><span class="s">: Bootstrap iteration </span><span class="si">%05i</span><span class="se">\n</span><span class="s">&quot;</span> \
                          <span class="s">&quot; ##################################</span><span class="se">\n</span><span class="s">&quot;</span> \
                          <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">:</span>

                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">rep_subselect</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">includelist</span><span class="p">,</span>
                                              <span class="n">options</span><span class="p">,</span> <span class="n">exprs_data</span><span class="p">)</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">sub_experiment</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sub_all_replicates</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">sub_exprs_data</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub_experiment</span> <span class="o">=</span> <span class="n">experiment</span>
                    <span class="n">sub_all_replicates</span> <span class="o">=</span> <span class="n">all_replicates</span>
                    <span class="n">sub_exprs_data</span> <span class="o">=</span> <span class="n">exprs_data</span>

                <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;sub_experiment&quot;</span><span class="p">:</span><span class="n">sub_experiment</span><span class="p">,</span>
                                  <span class="s">&quot;sub_all_replicates&quot;</span><span class="p">:</span><span class="n">sub_all_replicates</span><span class="p">,</span>
                                  <span class="s">&quot;sub_exprs_data&quot;</span><span class="p">:</span><span class="n">sub_exprs_data</span><span class="p">,</span>
                                  <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span>

                <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                  <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_experiment</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;sub_experiment&quot;</span><span class="p">]</span>
                <span class="n">sub_all_replicates</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;sub_all_replicates&quot;</span><span class="p">]</span>
                <span class="n">sub_exprs_data</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;sub_exprs_data&quot;</span><span class="p">]</span>

                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded run sub-selection details.&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c"># define full set of DE features - this is needed for constructing</span>
            <span class="c"># the databases later.</span>
            <span class="k">if</span> <span class="n">featureset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">featureset</span> <span class="o">=</span> <span class="n">sub_exprs_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c"># ==========</span>
            <span class="c"># Normalize the readcount data in-script (as opposed to in algorithm)</span>
            <span class="c"># if required.</span>
            <span class="c">#     - allow for restart</span>
            <span class="c"># ==========</span>
            <span class="n">normdata</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">:</span>
                <span class="n">normdata</span><span class="p">,</span> <span class="n">normvals</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">((</span><span class="n">sub_exprs_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">sub_exprs_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">sub_exprs_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                                                    <span class="n">sub_experiment</span><span class="p">,</span>
                                                    <span class="n">sub_all_replicates</span><span class="p">,</span>
                                                    <span class="n">options</span>
                                                    <span class="p">)</span>

                <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;normdata&quot;</span><span class="p">:</span><span class="n">normdata</span><span class="p">,</span>
                                  <span class="s">&quot;normvals&quot;</span><span class="p">:</span><span class="n">normvals</span><span class="p">,</span>
                                  <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

                <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                  <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">normdata</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;normdata&quot;</span><span class="p">]</span>
                <span class="n">normvals</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;normvals&quot;</span><span class="p">]</span>

                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded normalizations&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c"># ==========</span>
            <span class="c"># Write the data and experiment structure to files R can use to make</span>
            <span class="c"># an expressionset</span>
            <span class="c">#     - allow for restart</span>
            <span class="c"># ==========</span>
            <span class="n">rexpfile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">rphefile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">:</span>
                <span class="n">rexpfile</span><span class="p">,</span><span class="n">rphefile</span> <span class="o">=</span> <span class="n">write_R_data_file</span><span class="p">((</span><span class="n">normdata</span><span class="p">,</span>
                                                       <span class="n">sub_exprs_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                       <span class="n">sub_exprs_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                                                       <span class="p">),</span>
                                                      <span class="n">sub_experiment</span><span class="p">,</span>
                                                      <span class="n">options</span>
                                                      <span class="p">)</span>

                <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;rexpfile&quot;</span><span class="p">:</span><span class="n">rexpfile</span><span class="p">,</span>
                                  <span class="s">&quot;rphefile&quot;</span><span class="p">:</span><span class="n">rphefile</span><span class="p">,</span>
                                  <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">7</span><span class="p">}</span>

                <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                  <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rexpfile</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;rexpfile&quot;</span><span class="p">]</span>
                <span class="n">rphefile</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;rphefile&quot;</span><span class="p">]</span>

                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded R data files&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c"># ==========</span>
            <span class="c"># Call the appropriate R script to perform Differential Expression</span>
            <span class="c"># Analysis. These scripts typically load the data and experiment</span>
            <span class="c"># data and construct an expressionset object, that they then operate,</span>
            <span class="c"># performing their own internal normalization if requested.</span>
            <span class="c">#     - allow for restart</span>
            <span class="c"># ==========</span>
            <span class="k">if</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;restarpos&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">nboot</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">fileout_details</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">)</span>
                    <span class="n">this_fileout</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%i%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileout_details</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">fileout_details</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">this_fileout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span>

                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: DE calls will be written to </span><span class="si">%s</span><span class="s">&quot;</span> \
                          <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">this_fileout</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c"># Enable running the AGNC for non-bootstrap mode if agncpath is specified</span>
                <span class="n">run_AGNC</span><span class="o">=</span><span class="bp">False</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">agncpath</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                  <span class="n">run_AGNC</span><span class="o">=</span><span class="bp">True</span>

                <span class="n">DE_results</span> <span class="o">=</span> <span class="n">runRDE</span><span class="p">(</span><span class="n">rexpfile</span><span class="p">,</span>
                                    <span class="n">rphefile</span><span class="p">,</span>
                                    <span class="n">options</span><span class="p">,</span>
                                    <span class="n">fileout</span><span class="o">=</span><span class="n">this_fileout</span><span class="p">,</span>
                                    <span class="n">runAGNC</span><span class="o">=</span><span class="n">run_AGNC</span>
                                    <span class="p">)</span>

                <span class="n">DEfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DE_results</span><span class="p">)</span>

                <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;bs_outfiles&quot;</span><span class="p">:</span><span class="n">DEfiles</span><span class="p">,</span>
                                  <span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">8</span><span class="p">}</span>

                <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                                  <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;outfile&quot;</span><span class="p">]</span>
                <span class="n">DEfiles</span> <span class="o">=</span> <span class="n">restart_dic</span><span class="p">[</span><span class="s">&quot;bs_outfiles&quot;</span><span class="p">]</span>
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: loaded output data&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">restart_update</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;restarpos&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;nbootstrap_i&quot;</span><span class="p">:</span><span class="n">i</span><span class="p">}</span>
            <span class="n">restart_dic</span> <span class="o">=</span> <span class="n">writeCheckpoint</span><span class="p">(</span><span class="n">restart_update</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                              <span class="n">checkpointdata</span><span class="o">=</span><span class="n">restart_dic</span><span class="p">)</span>

    <span class="c"># ==========</span>
    <span class="c"># Finish with housekeeping and cleanup</span>
    <span class="c"># ==========</span>

    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">bootslave</span><span class="p">:</span>
        <span class="n">dbfile</span> <span class="o">=</span> <span class="n">results2sqlite</span><span class="p">(</span><span class="n">featureset</span><span class="p">,</span> <span class="n">DEfiles</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="c"># get final fileout, munging for whether its been on the cluster or not</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">masterfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">masterfileout</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">masterfileout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span>
            <span class="n">options</span><span class="o">.</span><span class="n">masterworkingdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">masterfileout</span><span class="p">)</span>
            <span class="n">masterfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">masterfileout</span><span class="p">))</span>
                
        <span class="n">masteroutfile</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">.db&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">masterworkingdir</span><span class="p">,</span>
                                      <span class="n">masterfilename</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Copying database file (</span><span class="si">%s</span><span class="s">), to master working &quot;</span> \
                  <span class="s">&quot;dir as file (</span><span class="si">%s</span><span class="s">)...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                     <span class="n">dbfile</span><span class="p">,</span>
                                     <span class="n">masteroutfile</span>
                                     <span class="p">)</span>
                  <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">masteroutfile</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">removing pre-existing version of </span><span class="si">%s</span><span class="s">... </span><span class="se">\n</span><span class="s">&quot;</span> \
                      <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">masteroutfile</span>
                      <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">masteroutfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">masteroutfile</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">masteroutfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">: ERROR: Something went wrong copying the &quot;</span> \
                          <span class="s">&quot;database file to the master directory. Get help!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;help! I&#39;ve lost the </span><span class="si">%s</span><span class="s"> file...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dbfile</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">cwd: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dfilename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dfilename</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">tmpdir: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dfilename</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dfilename</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">nbootstrap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Moving DE call output (</span><span class="si">%s</span><span class="s">) to final output (</span><span class="si">%s</span><span class="s">)&quot;</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">DEfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">DEfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">keep_tmpdir</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: --keep_tmpdir option set. Temporary files can be &quot;</span> \
                  <span class="s">&quot;found here: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span><span class="n">options</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
                  <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> All finished. Enjoy... :)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">createNewTempdir</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Finished. Enjoy... :)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>

    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c">##</span>
<span class="c">## TODO - in concatSqlliteFiles() need a proper check that the correct number of</span>
<span class="c">##        db files were found. No checks are done at all ATM.</span>
<span class="c">##      - Other normalisations need to be coded up.</span>
<span class="c">##      - Calculate R-script runtime and store.</span>
<span class="c">##      - Restart does not work for once passed the the point the bootstrap is</span>
<span class="c">##        called if options.nbootstrap is None as the &quot;nbootstrap_i&quot; is the</span>
<span class="c">##        same as the &quot;nboot&quot; value.</span>
<span class="c">##</span>
<span class="c">## FIXED</span>
<span class="c">##       - fixed bug with final output file not being generated if run in </span>
<span class="c">##         non-bootstrap mode</span>
<span class="c">##       - updates species default. fixed bug with not excluding files correctly</span>
<span class="c">##         if using precounts</span>
<span class="c">##       - updated the way tempfiles and dirs work so that when -v is specified</span>
<span class="c">##         all the tmpfiles are in tmpdirs in the local tmpdir rather than on</span>
<span class="c">##         individual cluster nodes. Makes it much easier to debug shit.</span>
<span class="c">##       - updated documentation and usage strings for all functions and the</span>
<span class="c">##         script as a whole, including a description of the output structure.</span>
<span class="c">##       - low priority: more complex job status monitoring for cluster jobs.</span>
<span class="c">##       - seems like we can&#39;t depend on SGE exit codes for &#39;SUCCESS&#39; as some</span>
<span class="c">##           jobs core-dump and exit succesfully. Add checking for expected files.</span>
<span class="c">##       - add_gene_name_column.pl is unnecessarily run for every</span>
<span class="c">##           group_by_gene.pl output. Turn this off.</span>
<span class="c">##       - tmpdir option now automatically resolves relative paths.</span>
<span class="c">##       - the drmaa session now gets passed the current working directory and</span>
<span class="c">##           the -l local_disk=10G option to make sure there is free space on</span>
<span class="c">##           the node before it runs.</span>
<span class="c">##       - The default for clustq is now hard-coded to be 64bit-pri (this will</span>
<span class="c">##           need to be changed is running on a different cluster) and is</span>
<span class="c">##           submitted as a parameter for the drmaa runs every time.</span>
<span class="c">##       - Added PERLLIB, PERL5LIB, R_HOME, PATH, DRMAA_LIBRARY_PATH, and</span>
<span class="c">##           LD_LIBRARY_PATH to the environment variables logged by the code</span>
<span class="c">##       - Added R version info to log header</span>
<span class="c">##       - Pre-existing tmpdirs are not removed when a new run starts, if found.</span>
<span class="c">##       - Updated group_by_gene.pl to call htseq-count in quiet mode. Hoped for</span>
<span class="c">##           speed up of runtime. No real benefit. But her, no more 2.5GB of</span>
<span class="c">##           logs...</span>
<span class="c">##       - uses localtime() instead of gmtime()</span>
<span class="c">##       - capture version info from R script</span>
<span class="c">##       - added explicit perlpath specification option and version logging</span>
<span class="c">##           perl scripts are now run using this specific perl version</span>
<span class="c">##       - fixed a major bug that deleted root bam files --- oops!</span>
<span class="c">##       - reformated docstrings.</span>
<span class="c">##       - Added sanity checking to make sure the bootstrap selects unique</span>
<span class="c">##         replicates between conditions. This should be irrellavant unless the</span>
<span class="c">##         false discovery rate to tools is being tested by having two identical</span>
<span class="c">##         conditions (13/09/17)</span>
<span class="c">##</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Profiling DGE with 48 replicates 3.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, N Schurch.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b2.
    </div>
  </body>
</html>