

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>doseResponse &mdash; GRNASeq 1.9 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="GRNASeq 1.9 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GRNASeq 1.9 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for doseResponse</h1><div class="highlight"><pre>
<span class="c">#!/local/bin/python</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">----------------</span>
<span class="sd">doseResponse.py</span>

<span class="sd">Takes the spike-in data output from spikedata_cluster_comparison.py and makes </span>
<span class="sd">dose response curves for each replicate. The dose response plots relate the </span>
<span class="sd">spike-in RPKM expression to the known concentrations of the spike-ins. The code</span>
<span class="sd">fits 4 models to these datasets:</span>

<span class="sd">  1) Linear Regression (no error weighting, intercept==0)</span>
<span class="sd">  2) Linear Chi-squared minimization fitting (weighted by data standard </span>
<span class="sd">       deviation and including a systematic error fraction is specified,</span>
<span class="sd">       intercept==0).</span>
<span class="sd">  3) Power-law Regression (no error weighting, intercept==0).</span>
<span class="sd">  4) Power-lawChi-squared minimization fitting (weighted by data standard</span>
<span class="sd">       deviation and including a systematic error fraction is specified,</span>
<span class="sd">       intercept==0).</span>

<span class="sd">As it turns out, the fits are (at least for our experiment) almost perfectly </span>
<span class="sd">linear and the linear chi-squared fits are used to calculate sample </span>
<span class="sd">normalization coefficients for each sample. Note that some of these samples are </span>
<span class="sd">bad, but here these &#39;bad&#39; replicates have not yet been removed. Note running </span>
<span class="sd">this script for just the pre-defined &#39;good&#39; replicates can be called using </span>
<span class="sd">-c|--clean.  </span>

<span class="sd">.. moduleauthor:: Nick Schurch &lt;nschurch@dundee.ac.uk&gt;</span>

<span class="sd">Command-line Arguments</span>
<span class="sd">======================</span>

<span class="sd">**usage\:** </span>
<span class="sd">    doseResponse.py</span>
<span class="sd">    :option:`-s|--spikedata` *&lt;file&gt;*</span>
<span class="sd">    :option:`-o|--outfile` *&lt;file&gt;*      </span>
<span class="sd">    :option:`-l|--logfile` *&lt;file&gt;* </span>
<span class="sd">    [:option:`--sys_err` *&lt;float&gt;*]</span>
<span class="sd">    [:option:`-p|--plotdir` *&lt;path&gt;*]</span>
<span class="sd">    [:options:`--displayplots`]</span>
<span class="sd">    [:option:`-f|--suffix` *&lt;str&gt;*] </span>
<span class="sd">    [:option:`-v|--verbose`] </span>
<span class="sd">    [:option:`--version`] </span>
<span class="sd">    [:option:`--help`]</span>

<span class="sd">Required Parameters</span>
<span class="sd">-------------------</span>

<span class="sd">:option:`--spikedata|-s`          </span>

<span class="sd">  Path to the .pkl data file output from getSpikeCounts.py.</span>

<span class="sd">:option:`--outfile|-o`           </span>

<span class="sd">  The name (inc. path) of the output file from the wrapper.</span>

<span class="sd">:option:`--logfile|-l`        </span>

<span class="sd">  The name (inc. path) of the log file from the wrapper.</span>

<span class="sd">Other options</span>
<span class="sd">-------------</span>

<span class="sd">:option:`--sys_err`</span>

<span class="sd">  Include a systematic error to the fit calculations &amp; plot error-bars. Provided</span>
<span class="sd">  as a fraction of the data, so 0.2, for example, will increase the error by 20%</span>
<span class="sd">  of the data. Default is 0.0.</span>

<span class="sd">:option:`--plotdir|-o`</span>
<span class="sd">  </span>
<span class="sd">  Specify a location for the output plots to be saved (if --displayplots is</span>
<span class="sd">  False). Defaults to the current working directory.</span>

<span class="sd">:option:`--displayplots`</span>

<span class="sd">  Turn on interactive plotting instead of saving the figures.</span>

<span class="sd">:option:`--suffix|-s`           </span>

<span class="sd">  A prefix for the output plots. Defaults to None.</span>

<span class="sd">:option:`--help|-h`</span>

<span class="sd">  Print a basic description of the tool and its options to STDOUT.</span>

<span class="sd">:option:`--version`    </span>

<span class="sd">  Show program&#39;s version number and exit.</span>
<span class="sd">    </span>
<span class="sd">:option:`--verbose|-v`     </span>

<span class="sd">  Turn on verbose logging (recommended).</span>


<span class="sd">Output</span>
<span class="sd">======</span>


<span class="sd">A pkl (python data structure that uses the cPickle library to read python</span>
<span class="sd">objects directly) containing a tuple with the results from the dose response</span>
<span class="sd">curve normalization process. This tuple also includes the spike in information </span>
<span class="sd">from the file specified in --spikedata.</span>

<span class="sd">In addition to the information saved in the pkl, this script also write files </span>
<span class="sd">for each experimental condition (suffixed &#39;_scaling_factors.txt&#39;) that report </span>
<span class="sd">the normalization factors for each replicate of in the condition in </span>
<span class="sd">tab-seperated text format, with appropriate column headers and comments.</span>

<span class="sd">If --displayplots is used this script plots the graphs to the screen. If not </span>
<span class="sd">specified, it outputs a series of plots suffixed with the string specified by </span>
<span class="sd">--suffix in the location specified by --plotdir.</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="c"># IF YOU ADD AN IMPORT HERE, MAKE SURE YOU ADD IT TO THE &#39;imported_modules&#39;</span>
<span class="c">#LIST OR IT WON&#39;T GET INCLUDED IN VERBOSE LOGGING OUTPUT!</span>

<span class="n">imported_modules</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;os&quot;</span><span class="p">,</span> <span class="s">&quot;sys&quot;</span><span class="p">,</span> <span class="s">&quot;re&quot;</span><span class="p">,</span> <span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="s">&quot;warnings&quot;</span><span class="p">,</span> <span class="s">&quot;cPickle&quot;</span><span class="p">,</span> 
                    <span class="s">&quot;numpy&quot;</span><span class="p">,</span> <span class="s">&quot;optparse&quot;</span><span class="p">,</span> <span class="s">&quot;subprocess&quot;</span><span class="p">,</span> <span class="s">&quot;matplotlib&quot;</span><span class="p">,</span> 
                    <span class="s">&quot;scipy&quot;</span><span class="p">,</span> <span class="s">&quot;colorsys&quot;</span><span class="p">,</span> <span class="s">&quot;math&quot;</span><span class="p">,</span> <span class="s">&quot;lmfit&quot;</span><span class="p">,</span> <span class="s">&quot;copy&quot;</span><span class="p">]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">cPickle</span><span class="o">,</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">optparse</span>
    <span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">colorsys</span><span class="o">,</span> <span class="nn">scipy</span><span class="o">,</span> <span class="nn">matplotlib</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">lmfit</span><span class="o">,</span> <span class="nn">copy</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span><span class="p">,</span> <span class="n">OptionGroup</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Something went wrong when importing the required modules. Its &quot;</span> \
          <span class="s">&quot;probably something to do with you not having the right bits in &quot;</span> \
          <span class="s">&quot;your python path.</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">print</span> <span class="s">&quot;If you&#39;re in Dundee, make sure you have &quot;</span> \
          <span class="s">&quot;/sw/lib/python2.6/site-packages in your pythonpath. Otherwise, &quot;</span> \
          <span class="s">&quot;please make sure your pythonpath includes locations&quot;</span> \
          <span class="s">&quot;for the following modules:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imported_modules</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Your pythonpath is:&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    
    <span class="k">raise</span>              

<span class="n">version_string</span><span class="o">=</span><span class="s">&quot;2.3&quot;</span>

<span class="c"># force sequential output to the screen, rather than buffered output.</span>

<span class="k">def</span> <span class="nf">printf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c"># patch warnings module to print the warning message format I like</span>

<span class="k">def</span> <span class="nf">custom_formatwarning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="n">warn_type</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.+\.(.+)</span><span class="se">\&#39;</span><span class="s">\&gt;&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">category</span><span class="p">))</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">---</span><span class="se">\n</span><span class="si">%s</span><span class="s">, line </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">---</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">warn_type</span><span class="p">,</span> 
                                                 <span class="n">message</span>
                                                 <span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span> <span class="o">=</span> <span class="n">custom_formatwarning</span>

<div class="viewcode-block" id="parse_required_options"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.parse_required_options">[docs]</a><span class="k">def</span> <span class="nf">parse_required_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot; Checks that all required options have been specified </span>
<span class="sd">    </span>
<span class="sd">    options is an optparse options instance, optslist is a list of options, </span>
<span class="sd">    each of which is a dictionary with the &#39;group&#39; key. If &#39;group&#39;==&#39;required&#39; </span>
<span class="sd">    then its a required option. If the value of this option in the optparse</span>
<span class="sd">    instance is not specified, then exit the script and provide help.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">optslist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;group&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;required&quot;</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                     <span class="s">&quot;A required argument (</span><span class="si">%s</span><span class="s">) is missing.</span><span class="se">\n</span><span class="s">Please specify &quot;</span> \
                     <span class="s">&quot; a value using &#39;</span><span class="si">%s</span><span class="s"> arg&#39;|&#39;</span><span class="si">%s</span><span class="s">=arg&#39; or see -h|--help for &quot;</span> \
                     <span class="s">&quot; more details on how to run this script.&quot;</span> 
                     <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span> 
                        <span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span>
                        <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">])</span>
                    <span class="p">)</span>
</div>
<div class="viewcode-block" id="parse_allowed_values"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.parse_allowed_values">[docs]</a><span class="k">def</span> <span class="nf">parse_allowed_values</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot; Checks that all options conform to their allowed values </span>
<span class="sd">    </span>
<span class="sd">    options is an optparse options instance, optslist is a list of options, </span>
<span class="sd">    each of which is a dictionary with an optional &#39;allowed_vals&#39; key. </span>
<span class="sd">    &#39;allowed_vals&#39; should contain a list of the allowed values. If the </span>
<span class="sd">    value of this option in the optparse instance is not in this list</span>
<span class="sd">    then warn the user and use the default value.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">optslist</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&quot;allowed_vals&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;allowed_vals&quot;</span><span class="p">]:</span>
                <span class="n">warnstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not an allowed option for </span><span class="si">%s</span><span class="s">. &quot;</span> \
                             <span class="s">&quot;Defaulting to </span><span class="si">%s</span><span class="s">. See -h|--help for more &quot;</span> \
                             <span class="s">&quot;details on how to run this script.&quot;</span> \
                             <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]],</span>
                                   <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                   <span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
                <span class="n">warning</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnstring</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
                <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="parse_option_type"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.parse_option_type">[docs]</a><span class="k">def</span> <span class="nf">parse_option_type</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot; Checks that all options conform to their specified types </span>
<span class="sd">    </span>
<span class="sd">    options is an optparse options instance, optslist is a list of options, </span>
<span class="sd">    each of which is a dictionary with an optional &#39;opt_type&#39; key. </span>
<span class="sd">    &#39;opt_type&#39; should be a string specifying the type of the option; examples</span>
<span class="sd">    are input_path, output_path, output_file, string, int, float. all the </span>
<span class="sd">    &#39;opt_type&#39; values should be valid python types except the paths. If the </span>
<span class="sd">    value of this option in the optparse instance is not of this type then </span>
<span class="sd">    either warn the user and use the default value (if there is one) or exit </span>
<span class="sd">    the script and provide help.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">optslist</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&quot;opt_type&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            
            <span class="c"># check all paths to make sure they are valid paths</span>
            <span class="c"># paths are all essential so exit if they fail</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;opt_type&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;input_path&quot;</span><span class="p">,</span> <span class="s">&quot;output_path&quot;</span><span class="p">,</span> <span class="s">&quot;output_file&quot;</span><span class="p">]:</span>

                <span class="c">#resolve relative paths</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^$&quot;</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]):</span>
                    <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                
                <span class="n">dictpath</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span>
                <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dictpath</span><span class="p">)</span>
                
                <span class="c"># trim output file name from path</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;opt_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;output_file&quot;</span><span class="p">:</span>  
                    <span class="n">check_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">check_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span>
                
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^$&quot;</span><span class="p">,</span><span class="n">check_path</span><span class="p">):</span>
                    <span class="n">check_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">check_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot;tmpdir&quot;</span><span class="p">:</span>
                    <span class="c"># make any necessary paths. Deal with tmpdir seperately!</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;opt_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;output_path&quot;</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">check_path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                             <span class="s">&quot;The path specified for </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, is not valid.</span><span class="se">\n</span><span class="s">&quot;</span> \
                             <span class="s">&quot;Please specify a valid path. See -h|--help &quot;</span> \
                             <span class="s">&quot;for more details on how to run this script.&quot;</span> 
                             <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                <span class="n">check_path</span><span class="p">)</span>
                             <span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;opt_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;input_file&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c">#resolve relative paths</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^$&quot;</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]):</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                    
                    <span class="n">dictpath</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span>
                    <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dictpath</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]):</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                                 <span class="s">&quot;The path specified for </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, is not &quot;</span> \
                                 <span class="s">&quot;valid.</span><span class="se">\n</span><span class="s">Please specify a valid path. See &quot;</span> \
                                 <span class="s">&quot;-h|--help for more details on how to run &quot;</span> \
                                 <span class="s">&quot;this script.&quot;</span> 
                                 <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                    <span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">])</span>
                                 <span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">e</span>
                        <span class="k">raise</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;opt_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;string&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">warnstring</span> <span class="o">=</span> <span class="s">&quot;The value specified for </span><span class="si">%s</span><span class="s"> cannot &quot;</span> \
                                         <span class="s">&quot;be successfully cast as a string. &quot;</span> \
                                         <span class="s">&quot;Defaulting to </span><span class="si">%s</span><span class="s">. See -h|--help &quot;</span> \
                                         <span class="s">&quot;for more details on how to run &quot;</span> \
                                         <span class="s">&quot;this script.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                                           <span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span>
                                                           <span class="p">)</span>
                            <span class="n">warning</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnstring</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
                            <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;The value specified for </span><span class="si">%s</span><span class="s"> cannot be &quot;</span> \
                                     <span class="s">&quot;successfully cast as a string and has &quot;</span> \
                                     <span class="s">&quot;no default value. please specify a &quot;</span> \
                                     <span class="s">&quot;valid value. See -h|--help for more &quot;</span> \
                                     <span class="s">&quot;details on how to run this script.&quot;</span> \
                                     <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">]</span>
                                     <span class="p">)</span>
                <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;opt_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;int&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">warnstring</span> <span class="o">=</span> <span class="s">&quot;The value specified for </span><span class="si">%s</span><span class="s"> cannot &quot;</span> \
                                         <span class="s">&quot;be successfully cast as a int. &quot;</span> \
                                         <span class="s">&quot;Defaulting to </span><span class="si">%s</span><span class="s">. See -h|--help &quot;</span> \
                                         <span class="s">&quot;for more details on how to run &quot;</span> \
                                         <span class="s">&quot;this script.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                                           <span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
                            <span class="n">warning</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnstring</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
                            <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;The value specified for </span><span class="si">%s</span><span class="s"> cannot be &quot;</span> \
                                     <span class="s">&quot;successfully cast as a int and has &quot;</span> \
                                     <span class="s">&quot;no default value. please specify a &quot;</span> \
                                     <span class="s">&quot;valid value. See -h|--help for more &quot;</span> \
                                     <span class="s">&quot;details on how to run this script.&quot;</span> \
                                     <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">]</span>
                                     <span class="p">)</span>
                <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;opt_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;float&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">warnstring</span> <span class="o">=</span> <span class="s">&quot;The value specified for </span><span class="si">%s</span><span class="s"> cannot &quot;</span> \
                                         <span class="s">&quot;be successfully cast as a float. &quot;</span> \
                                         <span class="s">&quot;Defaulting to </span><span class="si">%s</span><span class="s">. See -h|--help &quot;</span> \
                                         <span class="s">&quot;for more details on how to run &quot;</span> \
                                         <span class="s">&quot;this script.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span>
                                                           <span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
                            <span class="n">warning</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnstring</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
                            <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]]</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;The value specified for </span><span class="si">%s</span><span class="s"> cannot be &quot;</span> \
                                     <span class="s">&quot;successfully cast as a float and has &quot;</span> \
                                     <span class="s">&quot;no default value. please specify a &quot;</span> \
                                     <span class="s">&quot;valid value. See -h|--help for more &quot;</span> \
                                     <span class="s">&quot;details on how to run this script.&quot;</span> \
                                     <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">]</span>
                                     <span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>    
</div>
<div class="viewcode-block" id="timeAndDateStr"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.timeAndDateStr">[docs]</a><span class="k">def</span> <span class="nf">timeAndDateStr</span><span class="p">(</span><span class="n">ttime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    pretty current time and date timestring</span>
<span class="sd">    </span>
<span class="sd">    Uses current time unless an epoch time is provided</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ttime</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">ttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">ttime</span><span class="p">)</span>
    <span class="n">timestring</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="si">%02.0d</span><span class="s">:</span><span class="si">%02.0d</span><span class="s"> </span><span class="si">%02.0d</span><span class="s">/</span><span class="si">%02.0d</span><span class="s">/</span><span class="si">%02.0d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ttime</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
                                                          <span class="n">ttime</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> 
                                                          <span class="n">ttime</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
                                                          <span class="n">ttime</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                                          <span class="n">ttime</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">timestring</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="timeStr"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.timeStr">[docs]</a><span class="k">def</span> <span class="nf">timeStr</span><span class="p">(</span><span class="n">ttime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    pretty current time timestring</span>

<span class="sd">    Uses current time unless an epoch time is provided</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ttime</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">ttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">ttime</span><span class="p">)</span>
    <span class="n">timestring</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="si">%02.0d</span><span class="s">:</span><span class="si">%02.0d</span><span class="s">:</span><span class="si">%02.0d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ttime</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">ttime</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">ttime</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">timestring</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="write_log_header"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.write_log_header">[docs]</a><span class="k">def</span> <span class="nf">write_log_header</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">,</span> 
                     <span class="n">env_path_list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s">&quot;LD_LIBRARY_PATH&quot;</span><span class="p">,</span> <span class="s">&quot;PATH&quot;</span><span class="p">]</span>
                     <span class="p">):</span>
    
    <span class="c"># open log</span>
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="c"># get script name</span>
    <span class="n">script_title</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> v</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;^.+\/&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">version_string</span><span class="p">)</span>
    <span class="n">title_lines</span> <span class="o">=</span> <span class="s">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">script_title</span><span class="p">)</span>
    
    <span class="c"># write the title and log time</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot; Logfile opened at </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title_lines</span><span class="p">,</span> <span class="n">script_title</span><span class="p">,</span> <span class="n">title_lines</span><span class="p">,</span> <span class="n">timeAndDateStr</span><span class="p">())</span>              
              <span class="p">)</span>
    
    <span class="c"># write the full command line</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; Command line:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; Full script options:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">optslist</span><span class="p">:</span>
        <span class="n">opt_printstr</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="n">option</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">]</span>
        <span class="n">optstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_printstr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">),</span> 
                                <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">option</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="ow">and</span> <span class="n">option</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="n">optstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> (default)&quot;</span> <span class="o">%</span> <span class="n">optstring</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">optstring</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                
        <span class="c"># list details of python and group_by_gene.pl</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Programs:</span><span class="se">\n</span><span class="s">&quot;</span>\
                  <span class="s">&quot;</span><span class="se">\t</span><span class="s">Python </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                  <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># get version info from &#39;group_by_gene.pl&#39;</span>
            <span class="n">gbg_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">gbgpath</span><span class="p">,</span> 
                                         <span class="s">&quot;--version&quot;</span><span class="p">],</span> 
                                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">gbg_version_info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">gbg_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">gbg_version</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">other_versions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">gbg_version_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.*group_by_gene.pl&quot;</span><span class="p">,</span><span class="n">info</span><span class="p">):</span>
                    <span class="n">gbg_version</span> <span class="o">=</span> <span class="n">info</span>
                <span class="k">elif</span> <span class="n">info</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">other_versions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            
            <span class="n">gbg_version_string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n\t\t</span><span class="s">(uses </span><span class="si">%s</span><span class="s">)&quot;</span> \
                                 <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gbg_version</span><span class="p">,</span><span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_versions</span><span class="p">))</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">gbg_version_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># get version info from &#39;add_gene_name_column.pl&#39;</span>
            <span class="n">agnc_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">,</span>
                                          <span class="n">options</span><span class="o">.</span><span class="n">agncpath</span><span class="p">,</span> <span class="s">&quot;--version&quot;</span><span class="p">],</span> 
                                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">agnc_version_info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">agnc_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">agnc_version</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ensembl_version</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">agnc_version_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.*add_gene_name_column.pl&quot;</span><span class="p">,</span><span class="n">info</span><span class="p">):</span>
                    <span class="n">agnc_version</span> <span class="o">=</span> <span class="n">info</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;ensembl API&quot;</span><span class="p">,</span><span class="n">info</span><span class="p">):</span>
                    <span class="n">ensembl_version</span> <span class="o">=</span> <span class="n">info</span>
            
            <span class="n">agnc_version_string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n\t\t</span><span class="s">(uses </span><span class="si">%s</span><span class="s">)&quot;</span> \
                                 <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">agnc_version</span><span class="p">,</span> <span class="n">ensembl_version</span><span class="p">)</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">agnc_version_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># get version info from &#39;samtools&#39;</span>
            <span class="n">samtools_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">options</span><span class="o">.</span><span class="n">samtoolspath</span><span class="p">],</span> 
                                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">samtool_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">samtools_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">samtools_version_info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.+Version: (.+?)Usage:.+&quot;</span><span class="p">,</span>
                                             <span class="n">samtool_string</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        
            <span class="n">samtools_version_string</span> <span class="o">=</span> <span class="s">&quot;samtools </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">samtools_version_info</span><span class="p">)</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">samtools_version_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># get version info from &#39;R&#39;</span>
            <span class="n">R_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">options</span><span class="o">.</span><span class="n">rpath</span><span class="p">,</span> <span class="s">&quot;--version&quot;</span><span class="p">],</span> 
                                      <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                      <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">R_response</span> <span class="o">=</span> <span class="n">R_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">R_response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="c"># if its the R binary it will use this</span>
                <span class="n">R_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">R_response</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">R_version_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; -- &quot;</span><span class="p">,</span> <span class="n">R_string</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># if its the RScript binary it will use this</span>
                <span class="n">R_version_string</span> <span class="o">=</span> <span class="n">R_response</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="n">R_version_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;^R&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">rpath</span><span class="p">,</span>
                                      <span class="n">R_version_string</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">R_version_string</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;***Cannot get R version! Something may be wrong.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># get version info from &#39;perl&#39;</span>
            <span class="n">perl_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">,</span> <span class="s">&quot;--version&quot;</span><span class="p">],</span> 
                                      <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                      <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">perl_response</span> <span class="o">=</span> <span class="n">perl_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="n">perl_version_info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">perl_response</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">perl_version_string</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">perl_version_info</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;This is perl.+\((.+?)\) built.+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">perl_version_string</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">perl_version_string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">perlpath</span><span class="p">,</span> 
                                             <span class="n">perl_version_string</span>
                                             <span class="p">)</span> 
            
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">perl_version_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;***Cannot get perl version! Something may be wrong.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">RScript_call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">options</span><span class="o">.</span><span class="n">rpath</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">script_file</span><span class="p">,</span> 
                                       <span class="s">&quot;--version&quot;</span><span class="p">],</span> 
                                      <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                      <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                                      <span class="p">)</span>
            
            <span class="n">RScript_response</span> <span class="o">=</span> <span class="n">RScript_call</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="c"># The info should be here</span>
            <span class="n">RScript_version_info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">RScript_response</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">skip</span><span class="o">=</span><span class="bp">True</span>
            <span class="n">script_version</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">otherinfo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">RScript_version_info</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">script_file</span><span class="p">),</span>
                                 <span class="n">info</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="n">skip</span><span class="o">=</span><span class="bp">False</span>
                    <span class="n">script_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot; v&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">skip</span> <span class="ow">and</span> <span class="n">info</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>                
                    <span class="n">otherinfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot; v&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
            
            <span class="n">script_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;^R&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">rpath</span><span class="p">,</span> <span class="n">script_version</span><span class="p">)</span>
            <span class="n">script_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">script_version</span><span class="p">)</span>
            
            <span class="n">R_version_string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n\t\t</span><span class="s">(uses </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">script_version</span><span class="p">,</span>
                                                      <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">otherinfo</span><span class="p">)</span>
                                                      <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">R_version_string</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># munge module information</span>
        <span class="n">standard_modules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">third_party_modules</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">imported_modules</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;module_version = </span><span class="si">%s</span><span class="s">.__version__&quot;</span> <span class="o">%</span> <span class="n">module</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">exec</span> <span class="n">code</span>
                <span class="n">third_party_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">module_version</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">standard_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        
        <span class="c"># describe standard imports</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Standard python modules:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">standard_modules</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">module</span><span class="p">)</span>
        
        <span class="c"># describe third party python modules</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Contributed python modules:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">third_party_modules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;pysam&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
                <span class="n">module</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> (uses samtools </span><span class="si">%s</span><span class="s">)&quot;</span> \
                         <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">pysam</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">__samtools_version__</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">module</span><span class="p">)</span>
        
        <span class="c"># print relevent environment variables</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">env_path_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">evar</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">val</span><span class="p">])</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s"> environment variable:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">evar</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s"> environment variable: not set!&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
    
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="get_colors"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.get_colors">[docs]</a><span class="k">def</span> <span class="nf">get_colors</span><span class="p">(</span><span class="n">num_colors</span><span class="p">,</span> <span class="n">lightbase</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">satbase</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; define #num_colors random colours for a given lightness &amp; saturation &#39;&#39;&#39;</span> 
    
    <span class="n">colors</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">360.</span><span class="p">,</span> <span class="mf">360.</span> <span class="o">/</span> <span class="n">num_colors</span><span class="p">):</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="mf">360.</span>
        <span class="n">lightness</span> <span class="o">=</span> <span class="p">(</span><span class="n">lightbase</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span>
        <span class="n">saturation</span> <span class="o">=</span> <span class="p">(</span><span class="n">satbase</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colorsys</span><span class="o">.</span><span class="n">hls_to_rgb</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">lightness</span><span class="p">,</span> <span class="n">saturation</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">colors</span>
</div>
<div class="viewcode-block" id="getConditions"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.getConditions">[docs]</a><span class="k">def</span> <span class="nf">getConditions</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">axis_label</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; returns a dictionary of conditions with a list of the data-cube </span>
<span class="sd">    indexes of samples for that condition&#39;&#39;&#39;</span>
    
    <span class="n">conditions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_label</span><span class="p">]):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^(.+)_([0-9]+)&quot;</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="n">axis_label</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conditions</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">conditions</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_conditionInfo"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.get_conditionInfo">[docs]</a><span class="k">def</span> <span class="nf">get_conditionInfo</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">batch_dic</span><span class="p">,</span> <span class="n">data_dic</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; get the condition info, including batch information and spike-in mix &#39;&#39;&#39;</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Defining condition information...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">getConditions</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    
    <span class="c"># here we will need more information that just the condition indecies</span>
    <span class="c"># we also need batch and spike-in concentration information</span>
        
    <span class="n">cond_mix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cond_mix</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_dic</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_01&quot;</span> <span class="o">%</span> <span class="n">condition</span><span class="p">][</span><span class="s">&quot;Spike-in&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cond_mix</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_dic</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">D_01&quot;</span> <span class="o">%</span> <span class="n">condition</span><span class="p">][</span><span class="s">&quot;Spike-in&quot;</span><span class="p">]</span>
        
    <span class="n">m1_spike_concs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">m2_spike_concs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">spike</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="s">&quot;z&quot;</span><span class="p">]:</span>
        <span class="n">m1data</span> <span class="o">=</span> <span class="n">data_dic</span><span class="p">[</span><span class="n">spike</span><span class="p">][</span><span class="s">&#39;concentration in Mix 1 (attomoles/ul)&#39;</span><span class="p">]</span>
        <span class="n">m2data</span> <span class="o">=</span> <span class="n">data_dic</span><span class="p">[</span><span class="n">spike</span><span class="p">][</span><span class="s">&#39;concentration in Mix 2 (attomoles/ul)&#39;</span><span class="p">]</span>
        <span class="n">m1_spike_concs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m1data</span><span class="p">))</span>
        <span class="n">m2_spike_concs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m2data</span><span class="p">))</span>
        
    <span class="n">m1_spike_concs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m1_spike_concs</span><span class="p">)</span>
    <span class="n">m2_spike_concs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m2_spike_concs</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">cond_mix</span><span class="p">,</span> <span class="n">m1_spike_concs</span><span class="p">,</span> <span class="n">m2_spike_concs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="linear_chisq"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.linear_chisq">[docs]</a><span class="k">def</span> <span class="nf">linear_chisq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">errs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; returns the chi-squared residuals for a given set of parameters</span>
<span class="sd">    given data weighted by errors if given (standard deviations preferably)&#39;&#39;&#39;</span>
    
    <span class="n">m</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&quot;c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">c</span>
        
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">residuals</span><span class="o">/</span><span class="n">errs</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="power_chisq"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.power_chisq">[docs]</a><span class="k">def</span> <span class="nf">power_chisq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">errs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; returns the chi-squared residuals for a given set of parameters</span>
<span class="sd">    given data weighted by errors if given (standard deviations preferably)&#39;&#39;&#39;</span>
    
    <span class="n">m</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&quot;k&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="n">k</span>
    
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">model</span>
    <span class="k">if</span> <span class="n">errs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">residuals</span><span class="o">/</span><span class="n">errs</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="fitDataLinear"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.fitDataLinear">[docs]</a><span class="k">def</span> <span class="nf">fitDataLinear</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">y_sd</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">i_m</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">i_c</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">fixed_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">system_lim</span><span class="o">=</span><span class="mf">1E-5</span><span class="p">,</span> <span class="n">gran</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Adjust the systematic errors until a linear model is a good fit </span>
<span class="sd">        </span>
<span class="sd">        Basically, we fit to the data using the errors provided, then steadily </span>
<span class="sd">        increase the scale of the systematic error until a linear model results </span>
<span class="sd">        in a good fit (reduced chi^2&lt;=1).</span>
<span class="sd">        </span>
<span class="sd">        This, this is well-dodgy, but it should estimate the systematics that</span>
<span class="sd">        apply to each sample and this the errors on the fit-slope will actually</span>
<span class="sd">        tell us something about the quality of the data.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    
    <span class="n">sys_err</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">current_redchi</span> <span class="o">=</span> <span class="mf">1E6</span>
    <span class="n">fit_dic</span><span class="o">=</span><span class="p">{}</span>
    
    <span class="k">while</span> <span class="n">current_redchi</span><span class="o">&gt;=</span><span class="mf">1.0</span><span class="p">:</span>
                
        <span class="c"># add a systematic error to the standard deviations, if specified,</span>
        <span class="c"># and calculate the standard error on the mean values</span>
        
        <span class="n">y_errs</span> <span class="o">=</span> <span class="n">y_sd</span><span class="o">+</span><span class="p">(</span><span class="n">y_in</span><span class="o">*</span><span class="n">sys_err</span><span class="p">)</span>
        <span class="n">y_std_err</span> <span class="o">=</span> <span class="n">y_errs</span><span class="o">/</span><span class="n">dof</span>
        
        <span class="c"># make sure we&#39;re only fitting to detected datapoints </span>
        <span class="c"># (i.e., non-zero y_sd and y)</span>
            
        <span class="n">non_zero_errs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_errs</span><span class="o">&gt;</span><span class="n">system_lim</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_in</span><span class="p">[</span><span class="n">non_zero_errs</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_in</span><span class="p">[</span><span class="n">non_zero_errs</span><span class="p">]</span>
        <span class="n">y_errs</span> <span class="o">=</span> <span class="n">y_errs</span><span class="p">[</span><span class="n">non_zero_errs</span><span class="p">]</span>
        
        <span class="n">non_zero_vals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">non_zero_vals</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">non_zero_vals</span><span class="p">]</span>
        <span class="n">y_errs</span> <span class="o">=</span> <span class="n">y_errs</span><span class="p">[</span><span class="n">non_zero_vals</span><span class="p">]</span>
            
        <span class="n">sort_x_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                
        <span class="c">######################</span>
        <span class="c"># linear chi-squared #</span>
        <span class="c">######################</span>
    
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Fitting (chi-sq) a straight line to the data &quot;</span> \
                      <span class="s">&quot;with </span><span class="si">%.2f</span><span class="s"> systematic error...&quot;</span> <span class="o">%</span> <span class="n">sys_err</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
        <span class="c"># reset the model parameters </span>
        
        <span class="n">params</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;m&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_m</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed_intercept</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_c</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_c</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
        <span class="c"># do the first fit including errors!</span>
        
        <span class="n">lin_fit</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">linear_chisq</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_errs</span><span class="p">))</span>
        <span class="n">fit_dic</span><span class="p">[</span><span class="n">sys_err</span><span class="p">]</span> <span class="o">=</span> <span class="n">lin_fit</span>
        
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">lin_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">lin_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
            
            <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\t\t\t</span><span class="s">m=</span><span class="si">%s</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\n</span><span class="s">&quot;</span> \
                        <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">niceFormattedErrstr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
                                                  <span class="n">latex</span><span class="o">=</span><span class="bp">False</span>
                                                  <span class="p">),</span>
                              <span class="n">err</span><span class="o">/</span><span class="n">val</span>
                              <span class="p">)</span>
            
            <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t\t\t</span><span class="s">chi_sq/d.o.f = </span><span class="si">%.2f</span><span class="s">/</span><span class="si">%i</span><span class="s"> = </span><span class="si">%.2f</span><span class="s">&quot;</span> \
                        <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span> <span class="n">lin_fit</span><span class="o">.</span><span class="n">chisqr</span><span class="p">,</span>
                              <span class="n">lin_fit</span><span class="o">.</span><span class="n">nfree</span><span class="p">,</span> <span class="n">lin_fit</span><span class="o">.</span><span class="n">redchi</span>
                              <span class="p">)</span>
            
            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fitstring</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">sys_err</span><span class="o">+=</span><span class="n">gran</span>
        <span class="n">current_redchi</span> <span class="o">=</span> <span class="n">lin_fit</span><span class="o">.</span><span class="n">redchi</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">fit_dic</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="fitModels"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.fitModels">[docs]</a><span class="k">def</span> <span class="nf">fitModels</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_sd</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">i_m</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">i_c</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">i_k</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">fixed_intercept</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">system_lim</span><span class="o">=</span><span class="mf">1E-5</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; Performs fits to the data. The fits performed are:</span>
<span class="sd">    </span>
<span class="sd">        1) Linear chi^2 with errors</span>
<span class="sd">        2) Linear chi^2 no errors (linear regression)</span>
<span class="sd">        3) power-law with errors</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c"># add a systematic error tot he standard deviations, if specified,</span>
    <span class="c"># and calculate the standard error on the mean values</span>
    
    <span class="n">y_errs</span> <span class="o">=</span> <span class="n">y_sd</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">sys_err</span><span class="p">))</span>
    <span class="n">y_std_err</span> <span class="o">=</span> <span class="n">y_errs</span><span class="o">/</span><span class="n">dof</span>
    
    <span class="c"># make sure we&#39;re only fitting to detected datapoints </span>
    <span class="c"># (i.e., non-zero y_sd and y)</span>
        
    <span class="n">non_zero_errs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_errs</span><span class="o">&gt;</span><span class="n">system_lim</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">non_zero_errs</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">non_zero_errs</span><span class="p">]</span>
    <span class="n">y_errs</span> <span class="o">=</span> <span class="n">y_errs</span><span class="p">[</span><span class="n">non_zero_errs</span><span class="p">]</span>
    
    <span class="n">non_zero_vals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">non_zero_vals</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">non_zero_vals</span><span class="p">]</span>
    <span class="n">y_errs</span> <span class="o">=</span> <span class="n">y_errs</span><span class="p">[</span><span class="n">non_zero_vals</span><span class="p">]</span>
        
    <span class="n">sort_x_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c">#####################</span>
    <span class="c"># linear regression #</span>
    <span class="c">#####################</span>
    
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Fitting (linear regression) a straight line to the &quot;</span> \
                  <span class="s">&quot;data...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c"># define the parameters of the linear fit</span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;m&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_m</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed_intercept</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_c</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_c</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
    <span class="c"># do simple linear regression with no errors</span>
    
    <span class="n">lin_reg</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">linear_chisq</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">lin_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">lin_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">lin_reg_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">],</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">]</span><span class="o">+</span><span class="n">c</span><span class="p">)</span>
    
    <span class="c">######################</span>
    <span class="c"># linear chi-squared #</span>
    <span class="c">######################</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Fitting (chi-sq) a straight line to the data...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># reset the model parameters </span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;m&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_m</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed_intercept</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_c</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_c</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># do the first fit including errors!</span>
    
    <span class="n">lin_fit</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">linear_chisq</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_errs</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">lin_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">lin_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">lin_fit_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">],</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">]</span><span class="o">+</span><span class="n">c</span><span class="p">)</span>
    
    <span class="c">########################</span>
    <span class="c"># power-law regression #</span>
    <span class="c">########################</span>
    
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Fitting (regression) power-law to the data...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># reset the model parameters </span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;m&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_m</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;k&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_k</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">pow_reg</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">power_chisq</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pow_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">pow_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;k&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">pow_reg_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">],</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">]</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    
    <span class="c">#########################</span>
    <span class="c"># power-law chi-squared #</span>
    <span class="c">#########################</span>
    
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Fitting (chi-sq) power-law to the data...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># reset the model parameters </span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;m&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_m</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;k&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">i_k</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    <span class="n">pow_fit</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">power_chisq</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_errs</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pow_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">pow_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;k&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">pow_fit_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">],</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">sort_x_index</span><span class="p">]</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">({</span><span class="mi">1</span><span class="p">:{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;linear chi-sq fit&quot;</span><span class="p">,</span>
               <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;y=mx+c&quot;</span><span class="p">,</span>
               <span class="s">&quot;fit&quot;</span><span class="p">:</span> <span class="n">lin_fit</span><span class="p">,</span>
               <span class="s">&quot;line&quot;</span><span class="p">:</span> <span class="n">lin_fit_line</span><span class="p">},</span>
            <span class="mi">2</span><span class="p">:{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;linear regression&quot;</span><span class="p">,</span>
               <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;y=mx+c&quot;</span><span class="p">,</span>
               <span class="s">&quot;fit&quot;</span><span class="p">:</span> <span class="n">lin_reg</span><span class="p">,</span>
               <span class="s">&quot;line&quot;</span><span class="p">:</span> <span class="n">lin_reg_line</span><span class="p">},</span>
            <span class="mi">3</span><span class="p">:{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;power-law chi-sq fit&quot;</span><span class="p">,</span>
               <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;y=mx**k&quot;</span><span class="p">,</span>
               <span class="s">&quot;fit&quot;</span><span class="p">:</span> <span class="n">pow_fit</span><span class="p">,</span>
               <span class="s">&quot;line&quot;</span><span class="p">:</span> <span class="n">pow_fit_line</span><span class="p">},</span>
            <span class="mi">4</span><span class="p">:{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;power-law regression&quot;</span><span class="p">,</span>
               <span class="s">&quot;model&quot;</span><span class="p">:</span> <span class="s">&quot;y=mx**k&quot;</span><span class="p">,</span>
               <span class="s">&quot;fit&quot;</span><span class="p">:</span> <span class="n">pow_reg</span><span class="p">,</span>
               <span class="s">&quot;line&quot;</span><span class="p">:</span> <span class="n">pow_reg_line</span><span class="p">}</span>
            <span class="p">})</span>
</div>
<div class="viewcode-block" id="niceFormattedErrstr"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.niceFormattedErrstr">[docs]</a><span class="k">def</span> <span class="nf">niceFormattedErrstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_err</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; turns a value into a nicely formated string for display &#39;&#39;&#39;</span>
    
    <span class="n">str_out</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">inc_e_str</span> <span class="o">=</span><span class="s">&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">:</span>
        <span class="n">sci_str</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span>
        <span class="n">x_val</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">sci_str</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">x_err</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">x_rel_err</span> <span class="o">=</span> <span class="n">x_err</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="nb">int</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="n">x_rel_err_str</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x_rel_err</span>
            <span class="n">err_str_val</span><span class="p">,</span> <span class="n">err_exp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">x_rel_err_str</span><span class="p">)</span>
            <span class="n">e_str</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">err_exp</span><span class="p">)</span><span class="o">&lt;-</span><span class="mi">2</span><span class="p">:</span> 
                <span class="n">e_str</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%i</span><span class="s">f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;%.&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">err_exp</span><span class="p">))))</span>
            
            <span class="n">e_str_out</span> <span class="o">=</span> <span class="n">e_str</span> <span class="o">%</span> <span class="n">x_rel_err</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">latex</span><span class="p">:</span>
                <span class="n">inc_e_str</span> <span class="o">=</span> <span class="s">&quot;(+/-</span><span class="si">%s</span><span class="s">) &quot;</span> <span class="o">%</span> <span class="n">e_str_out</span>            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inc_e_str</span> <span class="o">=</span> <span class="s">&quot;^{+</span><span class="si">%s</span><span class="s">}_{-</span><span class="si">%s</span><span class="s">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e_str_out</span><span class="p">,</span> <span class="n">e_str_out</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">latex</span><span class="p">:</span>
            <span class="n">str_out</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">E</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">inc_e_str</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_out</span> <span class="o">=</span> <span class="s">r&quot;</span><span class="si">%s%s</span><span class="se">\\</span><span class="s">times10^{</span><span class="si">%i</span><span class="s">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">inc_e_str</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x_err</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">latex</span><span class="p">:</span>
                <span class="n">inc_e_str</span> <span class="o">=</span> <span class="s">&quot;(+/-</span><span class="si">%.3f</span><span class="s">) &quot;</span> <span class="o">%</span> <span class="n">x_err</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inc_e_str</span> <span class="o">=</span> <span class="s">r&quot;^{+</span><span class="si">%.3f</span><span class="s">}_{-</span><span class="si">%.3f</span><span class="s">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_err</span><span class="p">,</span> <span class="n">x_err</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="ow">not</span> <span class="n">latex</span><span class="p">:</span>
                <span class="n">str_out</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%.2f%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">inc_e_str</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_out</span> <span class="o">=</span> <span class="s">r&quot;</span><span class="si">%.2f%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">inc_e_str</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_out</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x_err</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">latex</span><span class="p">:</span>
                <span class="n">inc_e_str</span> <span class="o">=</span> <span class="s">&quot;(+/-</span><span class="si">%.3f</span><span class="s">) &quot;</span> <span class="o">%</span> <span class="n">x_err</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inc_e_str</span> <span class="o">=</span> <span class="s">r&quot;^{+</span><span class="si">%.3f</span><span class="s">}_{-</span><span class="si">%.3f</span><span class="s">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_err</span><span class="p">,</span> <span class="n">x_err</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">latex</span><span class="p">:</span>
            <span class="n">str_out</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%.2f%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">inc_e_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_out</span> <span class="o">=</span> <span class="s">r&quot;</span><span class="si">%.2f%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">inc_e_str</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">str_out</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="makeDosePlot"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.makeDosePlot">[docs]</a><span class="k">def</span> <span class="nf">makeDosePlot</span><span class="p">(</span><span class="n">i_axis</span><span class="p">,</span> <span class="n">data_cube</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">data_dic</span><span class="p">,</span> <span class="n">batch_dic</span><span class="p">,</span>
                 <span class="n">options</span><span class="p">,</span> <span class="n">pegval</span><span class="o">=</span><span class="mf">1E-3</span><span class="p">,</span> <span class="n">esuffix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39; plot expression vs concentration for spike-ins </span>
<span class="sd">    </span>
<span class="sd">    These profiles are 92-point curves (if there are 92 spike ins!) averaged</span>
<span class="sd">    across all samples.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">i_axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">]:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;Selected axis is not present in the data.&quot;</span><span class="p">)</span>
            
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Plotting lane dose-response...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c"># get information about the spikeins, conditions and batches</span>
    
    <span class="n">info</span> <span class="o">=</span> <span class="n">get_conditionInfo</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">batch_dic</span><span class="p">,</span> <span class="n">data_dic</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="n">conditions</span><span class="p">,</span> <span class="n">cond_mix</span><span class="p">,</span> <span class="n">m1_spike_concs</span><span class="p">,</span> <span class="n">m2_spike_concs</span> <span class="o">=</span> <span class="n">info</span> 
    
    <span class="c"># define output objects</span>
    
    <span class="n">figs</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">fitsout</span><span class="o">=</span><span class="p">{}</span>
    
    <span class="c"># process the conditions separately    </span>
    
    <span class="n">pause</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Processing condition: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">condition</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># slice the datacube and axes by condition</span>
        
        <span class="n">sub_cube</span> <span class="o">=</span> <span class="n">data_cube</span><span class="p">[</span><span class="n">conditions</span><span class="p">[</span><span class="n">condition</span><span class="p">],:,:]</span>
        <span class="n">sub_axes</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;x&quot;</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">])[</span><span class="n">conditions</span><span class="p">[</span><span class="n">condition</span><span class="p">]],</span>
                    <span class="s">&quot;y&quot;</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">]),</span>
                    <span class="s">&quot;z&quot;</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="s">&quot;z&quot;</span><span class="p">])</span>
                    <span class="p">}</span>
        
        <span class="c"># The conditions should have different mixes of the spike ins, so they </span>
        <span class="c"># require different concentration axes</span>
        
        <span class="n">concs</span> <span class="o">=</span> <span class="n">m2_spike_concs</span> 
        <span class="k">if</span> <span class="n">cond_mix</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;mix1&quot;</span><span class="p">:</span>
            <span class="n">concs</span> <span class="o">=</span> <span class="n">m1_spike_concs</span>
        
        <span class="c"># Process each entry along the axis specified.</span>
        <span class="c"># Use while and a counter rather than for so that I can be used as an</span>
        <span class="c"># index for different objects</span>
        
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">])</span>
        
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                        
            <span class="c"># Calculate the mean across the first non-singular axis of the data</span>
            <span class="c"># cube. If i_axis=&quot;y&quot; this corresponds to looking at the data by </span>
            <span class="c"># lanes and calculating the mean over all biological replicates in </span>
            <span class="c"># the condition. If i_axis=&quot;x&quot; this corresponds to looking at the</span>
            <span class="c"># data by biological replicate and calculating the mean over all</span>
            <span class="c"># lanes. If i_axis=&quot;z&quot; this corresponds to looking at the data by</span>
            <span class="c"># spike-in and calculating the mean over all lanes.</span>
            
            <span class="n">entry_label</span> <span class="o">=</span> <span class="n">sub_axes</span><span class="p">[</span><span class="n">i_axis</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        
            <span class="n">slice_data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">i_axis</span><span class="o">==</span><span class="s">&quot;x&quot;</span><span class="p">:</span>
                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">sub_cube</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>
                <span class="n">xlabel</span> <span class="o">=</span> <span class="s">&quot;lane&quot;</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;sample replicate&quot;</span>
            <span class="k">elif</span> <span class="n">i_axis</span><span class="o">==</span><span class="s">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">sub_cube</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">xlabel</span> <span class="o">=</span> <span class="s">&quot;sample&quot;</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;lane replicate&quot;</span>
            <span class="k">elif</span> <span class="n">i_axis</span><span class="o">==</span><span class="s">&quot;z&quot;</span><span class="p">:</span>
                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">sub_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">xlabel</span> <span class="o">=</span> <span class="s">&quot;lane&quot;</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;spike-in&quot;</span>
            
            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: </span><span class="se">\t</span><span class="s">Processing </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span>
                                                        <span class="n">title</span><span class="p">,</span>
                                                        <span class="n">entry_label</span><span class="p">)</span>
                      <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                        
            <span class="n">mean_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slice_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">std_devs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slice_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="c"># correct the standard deviations to an unbiased estimator for the </span>
            <span class="c"># standard deviation. Important when the number of points is small. </span>
            <span class="c"># see Gurland &amp; Tripathi 1971).</span>
            
            <span class="n">dof</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">std_devs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">4.0</span><span class="o">*</span><span class="p">(</span><span class="n">dof</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span><span class="o">*</span><span class="n">std_devs</span>            
            
            <span class="c"># fit the data with a straight line. Here we care less about how </span>
            <span class="c"># well we can measure spike-in expression, and more about how large</span>
            <span class="c"># the intrinsic scatter in the underlying data is, so we fit using </span>
            <span class="c"># the standard deviation as our weighting, rather than with the</span>
            <span class="c"># standard error on the mean as the weighting. Also perform a</span>
            <span class="c"># simple linear regression just so I can compare the results.</span>
            <span class="c"># I concluded that the linear regression wasn&#39;t such a great plan</span>
                                    
            <span class="n">fits</span> <span class="o">=</span> <span class="n">fitModels</span><span class="p">(</span><span class="n">concs</span><span class="p">,</span> <span class="n">mean_data</span><span class="p">,</span> <span class="n">std_devs</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                             <span class="n">fixed_intercept</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
            <span class="c"># calculate proper confidence intervals for the parameters - THIS </span>
            <span class="c"># DOESN&#39;T WORK YET</span>
            
<span class="c">#            conf_intervals = lmfit.conf_interval(fit)</span>
<span class="c">#            lmfit.printfuncs.report_ci(conf_intervals)</span>
            
            <span class="c"># report the fit parameters to the log. Unfortunately I can&#39;t use </span>
            <span class="c"># the built-in lmfit.printfuncs for this; they print only to the</span>
            <span class="c"># screen</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                
                <span class="n">fit</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                
                <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Best-fit </span><span class="si">%s</span><span class="s"> found:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> 
                <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t\t\t</span><span class="s">model: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;model&quot;</span><span class="p">])</span>
                
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
                    
                    <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t\t\t</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                                <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> 
                                      <span class="n">niceFormattedErrstr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
                                                          <span class="n">latex</span><span class="o">=</span><span class="bp">False</span>
                                                          <span class="p">)</span>
                                      <span class="p">)</span>
                
                <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t\t\t</span><span class="s">chi_sq/d.o.f = </span><span class="si">%.2f</span><span class="s">/</span><span class="si">%i</span><span class="s"> = </span><span class="si">%.2f</span><span class="s">&quot;</span> \
                            <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">chisqr</span><span class="p">,</span>
                                  <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nfree</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">redchi</span>
                                  <span class="p">)</span>
                
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fitstring</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
                <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitstring</span>
                <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry_label</span>
            
            <span class="c"># fit the errors on the data to a straight line model. Here we</span>
            <span class="c"># adjust the systematic errors on the sata to make the best-fit</span>
            <span class="c"># straight line formally a &#39;good&#39; fit. Its a bit dodgy, but hey!</span>
            
            <span class="n">syserr_fits_dic</span> <span class="o">=</span> <span class="n">fitDataLinear</span><span class="p">(</span><span class="n">concs</span><span class="p">,</span> <span class="n">mean_data</span><span class="p">,</span> <span class="n">std_devs</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> 
                                            <span class="n">options</span><span class="p">,</span> <span class="n">fixed_intercept</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="n">smax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">syserr_fits_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">fitstring</span>  <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">Best-fit systematic error found: </span><span class="si">%i%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                         <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">smax</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span><span class="s">&quot;%&quot;</span><span class="p">)</span>
            
            <span class="n">best_fit</span> <span class="o">=</span> <span class="n">syserr_fits_dic</span><span class="p">[</span><span class="n">smax</span><span class="p">]</span>
            
            <span class="n">val</span> <span class="o">=</span> <span class="n">best_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">best_fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
            
            <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t\t\t</span><span class="s">m=</span><span class="si">%s</span><span class="s">; fractional error: </span><span class="si">%.1f%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                        <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span>
                              <span class="n">niceFormattedErrstr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
                                                  <span class="n">latex</span><span class="o">=</span><span class="bp">False</span>
                                                  <span class="p">),</span>
                              <span class="p">(</span><span class="n">err</span><span class="o">/</span><span class="n">val</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                              <span class="s">&quot;%&quot;</span>
                              <span class="p">)</span>
            
            <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t\t\t</span><span class="s">chi_sq/d.o.f = </span><span class="si">%.2f</span><span class="s">/</span><span class="si">%i</span><span class="s"> = </span><span class="si">%.2f</span><span class="s">&quot;</span> \
                        <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span> <span class="n">best_fit</span><span class="o">.</span><span class="n">chisqr</span><span class="p">,</span>
                              <span class="n">best_fit</span><span class="o">.</span><span class="n">nfree</span><span class="p">,</span> <span class="n">best_fit</span><span class="o">.</span><span class="n">redchi</span>
                              <span class="p">)</span>
            
            <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fitstring</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                      
            <span class="c"># plot the data and the fits</span>
            
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
            
            <span class="c"># plot data</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">concs</span><span class="p">,</span> <span class="n">mean_data</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std_devs</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> 
                         <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;1 standard deviation errors&quot;</span><span class="p">)</span>
            
            <span class="c"># plot fit lines</span>

            <span class="n">cols</span> <span class="o">=</span> <span class="n">get_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                
                <span class="n">fit</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                
                <span class="c"># fit line label (including uncertainties)</span>
            
                <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: &quot;</span> <span class="o">%</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
                
                <span class="n">eq_str</span> <span class="o">=</span> <span class="s">r&quot;$</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;model&quot;</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
                    
                    <span class="n">eq_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;\*\*</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">,</span>
                                    <span class="s">&quot;^{</span><span class="si">%s</span><span class="s">}&quot;</span> <span class="o">%</span> <span class="n">niceFormattedErrstr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span>
                                    <span class="n">eq_str</span>
                                    <span class="p">)</span>
                    <span class="n">eq_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">niceFormattedErrstr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span> 
                                    <span class="n">eq_str</span>
                                    <span class="p">)</span>
                
                <span class="n">fitstring</span> <span class="o">=</span> <span class="s">r&quot;</span><span class="si">%s%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span> <span class="n">eq_str</span><span class="p">)</span>
                                
                <span class="n">fitstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">  $\chi^{2}_{red} = </span><span class="si">%.2f</span><span class="s">$&quot;</span> \
                            <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitstring</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">redchi</span><span class="p">)</span>
                
                <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;latexlabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitstring</span>
                
                <span class="n">fit_line</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;line&quot;</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fit_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">fitstring</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                         <span class="p">)</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
                        
            <span class="c"># plot parrameters, log-scaling, labels, etc</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span> <span class="p">(</span><span class="s">r&quot;$spike-in\ concentration\ (attomoles/\mu L)$&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span> <span class="p">(</span><span class="s">r&quot;$\overline{spike-in\ </span><span class="si">%s</span><span class="s">\ RPKM}$&quot;</span> <span class="o">%</span> <span class="n">xlabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> dose response&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> 
                                                  <span class="n">entry_label</span>
                                                  <span class="p">)</span>
                      <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">})</span>
            
            <span class="n">isuffix</span> <span class="o">=</span> <span class="n">esuffix</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">onlycleandata</span><span class="p">:</span>
                <span class="n">isuffix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_clean&quot;</span> <span class="o">%</span> <span class="n">esuffix</span>
            
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">displayplots</span><span class="p">:</span>
                <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s%s</span><span class="s">.png&quot;</span> \
                            <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">plotdir</span><span class="p">,</span>
                                  <span class="n">condition</span><span class="p">,</span>
                                  <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">),</span>
                                  <span class="n">entry_label</span><span class="p">,</span>
                                  <span class="n">isuffix</span><span class="p">,</span>
                                  <span class="n">options</span><span class="o">.</span><span class="n">suffix</span>
                                  <span class="p">)</span>
                                
                <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="s">writing file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
                <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">saved</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                    <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                                    <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span>
                                    <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span>
                                    <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;portrait&#39;</span><span class="p">,</span>
                                    <span class="n">format</span><span class="o">=</span><span class="s">&quot;png&quot;</span><span class="p">,</span>
                                    <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="c"># Write out the fit information</span>
            
            <span class="c"># This is a bit pissing annoying, but cPickle won&#39;t pickle </span>
            <span class="c"># functions so I have to remove them from the lmfit objects </span>
            <span class="c"># before passing them for saving. This took ages to get them </span>
            <span class="c"># all by hand!</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>    
                <span class="n">fit</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">fit_dict</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s">&quot;fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span>
                <span class="k">del</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;asteval&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;namefinder&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;userfcn&#39;</span><span class="p">]</span>
                <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]:</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span>
                    <span class="k">del</span> <span class="n">params_dict</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s">&#39;from_internal&#39;</span><span class="p">]</span>
                <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">params_dict</span>
                <span class="n">fits</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_dict</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">syserr_fits_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">syserr_fits_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">fit_dict</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">__dict__</span>
                <span class="k">del</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;asteval&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;namefinder&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;userfcn&#39;</span><span class="p">]</span>
                <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]:</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span>
                    <span class="k">del</span> <span class="n">params_dict</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s">&#39;from_internal&#39;</span><span class="p">]</span>
                <span class="n">fit_dict</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">params_dict</span>
                <span class="n">syserr_fits_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_dict</span>
            
            <span class="n">fits</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;sysrrfits&quot;</span><span class="p">:</span><span class="n">syserr_fits_dic</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;linear erropt&quot;</span><span class="p">}</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fitsout</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">fits</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">fitsout</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
                <span class="n">fitsout</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">fits</span>
            
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">figs</span><span class="p">,</span> <span class="n">fitsout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="calcLinearFitNorms"><a class="viewcode-back" href="../doseResponse_autodocs.html#doseResponse.calcLinearFitNorms">[docs]</a><span class="k">def</span> <span class="nf">calcLinearFitNorms</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot; calculate the normalization factors for the linear fits </span>
<span class="sd">    </span>
<span class="sd">    Assumes a linear fit/regression in RPKM to concentration space. Calculates</span>
<span class="sd">    the constant and multiplication factors needed to transform each fit into </span>
<span class="sd">    the mean of the fits supplied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">prefix</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&quot; &quot;</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: calculating the </span><span class="si">%s</span><span class="s">normalizations for </span><span class="si">%s</span><span class="s">...&quot;</span> \
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">normmodel</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c"># calculate the mean of all the matching fits provided (use the &#39;best&#39; </span>
    <span class="c"># fit from systematic errror optomization runs if </span>
    <span class="c"># options.normmodel=&#39;linear erropt&#39;.</span>
        
    <span class="n">ms</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">cs</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">nlines</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">replicate</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">thisID</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">replicate</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">fit</span> <span class="ow">in</span> <span class="n">thisID</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>               
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">normmodel</span><span class="p">,</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;name&quot;</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;m&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">])</span>
                        <span class="n">cs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;c&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">smax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                            <span class="n">best_fit</span> <span class="o">=</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="n">smax</span><span class="p">]</span>
                            <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_fit</span><span class="p">[</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;m&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">])</span>
                            <span class="n">cs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_fit</span><span class="p">[</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;c&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="n">nlines</span><span class="o">+=</span><span class="mi">1</span>
    
    <span class="n">ms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
    
    <span class="n">m_av</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">m_err</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
    <span class="n">m_err_sqfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_err</span><span class="o">/</span><span class="n">m_av</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="n">c_av</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">c_err</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c_err_sqfr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">c_av</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">c_err</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">c_err_sqfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_err</span><span class="o">/</span><span class="n">c_av</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c"># for each fit calculate the normalization offset and scaling factor</span>
    <span class="c"># make sure the errors are propagated correctly (assuming they are </span>
    <span class="c"># uncorrelated)</span>
        
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        
        <span class="c"># make an output file, sererate from the -o output file, for the </span>
        <span class="c"># normalization factors </span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_scaling_factors.txt&quot;</span> \
                   <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">condition</span><span class="p">,</span>
                         <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">normmodel</span><span class="p">)</span>
                         <span class="p">)</span>
        
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: writing normalizations to file </span><span class="si">%s</span><span class="s">&quot;</span> \
                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">qfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">headerwritten</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">headstring</span><span class="o">=</span><span class="s">&quot;# Made with </span><span class="si">%s</span><span class="s"> v</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                   <span class="s">&quot;# For all options and details see the logfile: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> \
                   <span class="s">&quot;Replicate</span><span class="se">\t</span><span class="s">Scaling_factor</span><span class="se">\t</span><span class="s">Scaling_fac&quot;</span> \
                   <span class="s">&quot;tor_1sigma_err&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">version_string</span><span class="p">),</span>
                                       <span class="n">options</span><span class="o">.</span><span class="n">log</span>
                                       <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">replicate</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">thisID</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">replicate</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">fit</span> <span class="ow">in</span> <span class="n">thisID</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                
                <span class="c"># make sure we match the fit type requested</span>
                
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">normmodel</span><span class="p">,</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;name&quot;</span><span class="p">]):</span>
                            
                    <span class="n">m</span> <span class="o">=</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;m&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]</span>
                    <span class="n">merr</span> <span class="o">=</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;m&quot;</span><span class="p">][</span><span class="s">&quot;stderr&quot;</span><span class="p">]</span>
                    <span class="n">merr_sqfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">merr</span><span class="o">/</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                    
                    <span class="n">scaling</span> <span class="o">=</span> <span class="n">m_av</span><span class="o">/</span><span class="n">m</span>
                    <span class="n">scal_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">merr_sqfr</span><span class="o">+</span><span class="n">m_err_sqfr</span><span class="p">)</span><span class="o">*</span><span class="n">scaling</span>
                    <span class="n">scal_frac_err</span> <span class="o">=</span> <span class="n">scal_err</span><span class="o">/</span><span class="n">scaling</span>
                    
                    <span class="n">c</span> <span class="o">=</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;c&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]</span>
                    <span class="n">cerr</span> <span class="o">=</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;c&quot;</span><span class="p">][</span><span class="s">&quot;stderr&quot;</span><span class="p">]</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">m_av</span><span class="o">/</span><span class="n">m</span> <span class="o">-</span> <span class="n">c_av</span><span class="p">)</span>
                    
                    <span class="c"># only bother reporting c if it has constrained errors</span>
                    
                    <span class="n">os_err</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">cerr</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">cerr</span> <span class="o">=</span> <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;params&quot;</span><span class="p">][</span><span class="s">&quot;c&quot;</span><span class="p">][</span><span class="s">&quot;stderr&quot;</span><span class="p">]</span>
                        <span class="n">cerr_sqfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cerr</span><span class="o">/</span><span class="n">c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                        <span class="n">os_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">cerr_sqfr</span><span class="o">+</span><span class="n">m_err_sqfr</span><span class="o">+</span><span class="n">merr_sqfr</span><span class="p">)</span><span class="o">*</span>
                                            <span class="p">((</span><span class="n">c</span><span class="o">*</span><span class="n">m_av</span><span class="o">/</span><span class="n">m</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">c_err</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">os_frac_err</span> <span class="o">=</span> <span class="n">os_err</span><span class="o">/</span><span class="n">offset</span>
                        
                        <span class="c"># add columns to the output file</span>
                        <span class="c"># write header only if its not been written before</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">headerwritten</span><span class="p">:</span>
                            <span class="n">headstring</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="s">offset</span><span class="se">\t</span><span class="s">offset_1sigma_error</span><span class="se">\n</span><span class="s">&quot;</span> \
                                         <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="n">headstring</span>
                            <span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">headstring</span><span class="p">)</span>
                            <span class="n">headerwritten</span><span class="o">=</span><span class="bp">True</span>
                        <span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.4f</span><span class="se">\n</span><span class="s">&quot;</span> \
                                    <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">replicate</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">scaling</span><span class="p">,</span> <span class="n">scal_err</span><span class="p">,</span>
                                          <span class="n">offset</span><span class="p">,</span> <span class="n">os_err</span>
                                          <span class="p">)</span>
                                    <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">headerwritten</span><span class="p">:</span>
                            <span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">headstring</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="n">headerwritten</span><span class="o">=</span><span class="bp">True</span>
                        <span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.4f</span><span class="se">\n</span><span class="s">&quot;</span> \
                                    <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">replicate</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">scaling</span><span class="p">,</span> <span class="n">scal_err</span><span class="p">)</span>
                                    <span class="p">)</span>
                                        
                    <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;scaling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">scal_err</span><span class="p">)</span>
                    <span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;fit&quot;</span><span class="p">][</span><span class="s">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">os_err</span><span class="p">)</span>
                    <span class="n">thisID</span><span class="p">[</span><span class="s">&quot;scaling_factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">scal_err</span><span class="p">,</span>
                                                <span class="n">options</span><span class="o">.</span><span class="n">normmodel</span>
                                                <span class="p">)</span>
                    <span class="n">thisID</span><span class="p">[</span><span class="s">&quot;offset_factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">os_err</span><span class="p">,</span>
                                               <span class="n">options</span><span class="o">.</span><span class="n">normmodel</span>
                                               <span class="p">)</span>
                    <span class="n">fits</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">replicate</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisID</span>
                          
                    <span class="c"># pipe the results to the logfile too...</span>
                    
                    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
                    <span class="n">star</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                    <span class="k">if</span> <span class="n">scaling</span><span class="o">&lt;</span><span class="mf">0.5</span> <span class="ow">or</span> <span class="n">scaling</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">star</span> <span class="o">=</span> <span class="s">&quot;****&quot;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s">:</span><span class="se">\t</span><span class="s">scaling:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> \
                              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;replicate&quot;</span><span class="p">],</span>
                                    <span class="n">scaling</span><span class="p">,</span>
                                    <span class="n">scal_err</span><span class="p">,</span>
                                    <span class="n">scal_frac_err</span><span class="p">,</span>
                                    <span class="n">star</span><span class="p">)</span>
                              <span class="p">)</span>
                    <span class="k">if</span> <span class="n">cerr</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s">:</span><span class="se">\t</span><span class="s">offset:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> \
                                  <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thisID</span><span class="p">[</span><span class="n">fit</span><span class="p">][</span><span class="s">&quot;replicate&quot;</span><span class="p">],</span>
                                        <span class="n">offset</span><span class="p">,</span>
                                        <span class="n">os_err</span><span class="p">,</span>
                                        <span class="n">os_frac_err</span><span class="p">,</span>
                                        <span class="n">star</span><span class="p">)</span>
                                  <span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">qfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">fits</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">convertRPKM</span><span class="p">(</span><span class="n">spike_cube</span><span class="p">,</span> <span class="n">spike_dic</span><span class="p">,</span> <span class="n">spike_cube_axes</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Converting raw counts to RPKM...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_cube_axes</span><span class="p">[</span><span class="s">&quot;z&quot;</span><span class="p">]):</span>
        <span class="n">spike</span> <span class="o">=</span> <span class="n">spike_cube_axes</span><span class="p">[</span><span class="s">&quot;z&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">spikekb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_dic</span><span class="p">[</span><span class="n">spike</span><span class="p">][</span><span class="s">&quot;Sequence&quot;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">spike_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spike_cube</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">spikekb</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">spike_cube</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c"># parse command line options - note that because we&#39;re using python 2.6.4,</span>
    <span class="c"># and hence optparse rather than argparse, I&#39;m forcing everything to be an</span>
    <span class="c"># &#39;option&#39; even if it is required.</span>
    
    <span class="c"># define options</span>
    <span class="n">optslist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-s&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--spikedata&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;spikedata&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;Path to the data pkl with the spike-in count &quot;</span> \
                             <span class="s">&quot;data.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;input_file&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-o&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--outfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;outfile&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;The name (inc. path if different from the &quot;</span> \
                             <span class="s">&quot;current working directory) of the output file &quot;</span> \
                             <span class="s">&quot;containing the results.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;output_file&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-l&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--logfile&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;log&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;The name (inc. path if different from the &quot;</span> \
                             <span class="s">&quot;current working directory) of the log file &quot;</span> \
                             <span class="s">&quot;from running this script.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="s">&quot;required&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;output_file&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-v&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--verbose&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;Turn on verbose logging.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">False</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-p&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--displayplots&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;displayplots&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;Turn on interactive plotting instead of saving &quot;</span> \
                             <span class="s">&quot;the figures.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">False</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--sys_err&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;sys_err&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;Include a systematic error to the fit &quot;</span> \
                             <span class="s">&quot;calculations &amp; plt error-bars. Provided as a &quot;</span> \
                             <span class="s">&quot;fraction of the data, so 0.2, for example, &quot;</span> \
                             <span class="s">&quot;will increase the error by 20</span><span class="si">% o</span><span class="s">f the data. &quot;</span> \
                             <span class="s">&quot;Default is 0.0&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;float&quot;</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-d&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--plotdir&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;plotdir&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;Specify a location for the output plots (if &quot;</span> \
                             <span class="s">&quot;--displayplots is False). Defaults to the &quot;</span> \
                             <span class="s">&quot;current working directory.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;output_path&quot;</span>                     
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-f&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--suffix&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;suffix&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;A suffix for the output plots.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                     <span class="s">&quot;opt_type&quot;</span><span class="p">:</span> <span class="s">&quot;string&quot;</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--clean&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;onlycleandata&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;Use only defined &#39;clean&#39; replicates for the &quot;</span> \
                             <span class="s">&quot;fits. This information comes from running &quot;</span> \
                             <span class="s">&quot;the spikedata_cluster_comparison.py script. &quot;</span> \
                             <span class="s">&quot;Default is False.&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="bp">False</span>
                    <span class="p">})</span>
    <span class="n">optslist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                     <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="s">&quot;-m&quot;</span><span class="p">,</span>
                     <span class="s">&quot;long&quot;</span><span class="p">:</span> <span class="s">&quot;--norm_model&quot;</span><span class="p">,</span>
                     <span class="s">&quot;dest&quot;</span><span class="p">:</span> <span class="s">&quot;normmodel&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;store&quot;</span><span class="p">,</span>
                     <span class="s">&quot;help&quot;</span><span class="p">:</span> <span class="s">&quot;Choose the model to use for calculating the &quot;</span> \
                             <span class="s">&quot;spike-in normalization factors. Options are: &quot;</span> \
                             <span class="s">&quot;&#39;linear chi-sq fit&#39; &amp; &#39;linear regression&#39;. &quot;</span> \
                             <span class="s">&quot;Default is &#39;linear chi-sq fit&#39;&quot;</span><span class="p">,</span>
                     <span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&quot;default&quot;</span><span class="p">:</span> <span class="s">&#39;linear chi-sq fit&#39;</span><span class="p">,</span>
                     <span class="s">&quot;allowed_vals&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;linear chi-sq fit&quot;</span><span class="p">,</span><span class="s">&quot;linear regression&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;linear erropt&quot;</span><span class="p">]</span>
                     <span class="p">})</span>
    
    <span class="c"># build options from commandline</span>

    <span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">%prog -s|--spikedata &lt;path&gt; -o|--outfile &lt;file&gt;&quot;</span> \
            <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">-l|--logfile &lt;file&gt; [--sys_err &lt;float&gt;] [--displayplots]&quot;</span> \
            <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">[-p|--plotdir &lt;path&gt;] [-f|--suffix &lt;str&gt;] [--version] &quot;</span> \
            <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">[-v|--verbose] [--help]&quot;</span>
            
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;%prog v&quot;</span><span class="o">+</span><span class="n">version_string</span><span class="p">)</span>
        
    <span class="c">#define option groups</span>
    
    <span class="n">reqgroup</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">&quot;Required Arguments&quot;</span><span class="p">)</span>
    
    <span class="c"># add options to the groups</span>
    
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">optslist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;group&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;required&quot;</span><span class="p">:</span>
            <span class="n">reqgroup</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span> 
                                <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span>
                                <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;short&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span> 
                                  <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span> 
                                  <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;long&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;action&quot;</span><span class="p">],</span> 
                                  <span class="n">dest</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;dest&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;help&quot;</span><span class="p">],</span> 
                                  <span class="n">default</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">])</span>
    
    <span class="c"># add groups to the parser</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">reqgroup</span><span class="p">)</span>
    
    <span class="c"># parse arguments</span>
    
    <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="c"># check that all required options have been provided</span>
    
    <span class="n">parse_required_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">)</span>
    
    <span class="c"># check all values are allowed, or default to, well, the defaults!</span>
    
    <span class="n">parse_allowed_values</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">)</span>
    
    <span class="c"># check that all options are of the right type (if specified)</span>
    
    <span class="n">parse_option_type</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">)</span>
    
    <span class="c"># open the logfile and write the basic header information</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="n">write_log_header</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">optslist</span><span class="p">)</span>

    <span class="c"># read spike-in data and make RPKMs</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Reading data from </span><span class="si">%s</span><span class="s">...&quot;</span> 
              <span class="s">&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">spikedata</span><span class="p">)</span>
              <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
    
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">spikedata</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c"># hardcoded assumed data structure! Yummy!</span>
    
    <span class="n">spike_dic</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spike_data_dic</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">spike_raw_cube</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">spike_cube</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">spike_cube_axes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">spike_batch_dic</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    
    <span class="n">corr_results</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">corr_results</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
                    
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">onlycleandata</span> <span class="ow">and</span> <span class="n">corr_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: Using only &#39;good&#39; replicates...&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">excludes</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">cond_indexes</span><span class="o">=</span><span class="n">getConditions</span><span class="p">(</span><span class="n">spike_cube_axes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">corr_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">replicate</span> <span class="ow">in</span> <span class="n">corr_results</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="s">&quot;rejected&quot;</span><span class="p">]:</span>
                <span class="n">excludes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond_indexes</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">replicate</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">spike_cube</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">spike_cube</span><span class="p">,</span> <span class="n">excludes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spike_cube_axes</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">]),</span> <span class="n">excludes</span><span class="p">)</span>
        <span class="n">spike_cube_axes</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    
    <span class="n">spike_cube</span> <span class="o">=</span> <span class="n">convertRPKM</span><span class="p">(</span><span class="n">spike_cube</span><span class="p">,</span> <span class="n">spike_dic</span><span class="p">,</span> <span class="n">spike_cube_axes</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    
    <span class="c"># make the dose response plots, and calculate the normalization between </span>
    <span class="c"># lanes...</span>
    
    <span class="n">bylane</span><span class="p">,</span> <span class="n">lanefits</span> <span class="o">=</span> <span class="n">makeDosePlot</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
                                    <span class="n">spike_cube</span><span class="p">,</span>
                                    <span class="n">spike_cube_axes</span><span class="p">,</span>
                                    <span class="n">spike_dic</span><span class="p">,</span>
                                    <span class="n">spike_batch_dic</span><span class="p">,</span>
                                    <span class="n">options</span><span class="p">,</span>
                                    <span class="n">esuffix</span><span class="o">=</span><span class="s">&quot;DoseResponseFits&quot;</span>
                                    <span class="p">)</span>
        
    <span class="c"># make the dose response plots, and calculate the normalization between </span>
    <span class="c"># samples...</span>

    <span class="n">bysample</span><span class="p">,</span> <span class="n">samplefits</span> <span class="o">=</span> <span class="n">makeDosePlot</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span>
                                        <span class="n">spike_cube</span><span class="p">,</span>
                                        <span class="n">spike_cube_axes</span><span class="p">,</span>
                                        <span class="n">spike_dic</span><span class="p">,</span>
                                        <span class="n">spike_batch_dic</span><span class="p">,</span>
                                        <span class="n">options</span><span class="p">,</span>
                                        <span class="n">esuffix</span><span class="o">=</span><span class="s">&quot;DoseResponseFits&quot;</span>
                                        <span class="p">)</span>
    
    <span class="c"># calculate normalization factors based on teh linear best-fits.</span>
    
    <span class="n">lane_norms</span> <span class="o">=</span> <span class="n">calcLinearFitNorms</span><span class="p">(</span><span class="n">lanefits</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;lane&quot;</span><span class="p">)</span>
    <span class="n">sample_norms</span> <span class="o">=</span> <span class="n">calcLinearFitNorms</span><span class="p">(</span><span class="n">samplefits</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sample&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">displayplots</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c"># build the output data structures</span>
    
    <span class="n">data_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;dic&quot;</span><span class="p">:</span><span class="n">spike_data_dic</span><span class="p">,</span> <span class="s">&quot;raw_cube&quot;</span><span class="p">:</span> <span class="n">spike_raw_cube</span><span class="p">,</span>
                <span class="s">&quot;rpkm_cube&quot;</span><span class="p">:</span><span class="n">spike_cube</span><span class="p">,</span> <span class="s">&quot;axes&quot;</span><span class="p">:</span><span class="n">spike_cube_axes</span><span class="p">}</span>
        
    <span class="n">datatup</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;details&quot;</span><span class="p">:</span><span class="n">spike_dic</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">:</span><span class="n">data_dic</span><span class="p">,</span> <span class="s">&quot;batch&quot;</span><span class="p">:</span><span class="n">spike_batch_dic</span><span class="p">,</span>
               <span class="s">&quot;corr&quot;</span><span class="p">:</span> <span class="n">corr_results</span><span class="p">,</span> <span class="s">&quot;lane_dosefits&quot;</span><span class="p">:</span><span class="n">lanefits</span><span class="p">,</span>
               <span class="s">&quot;sample_dosefits&quot;</span><span class="p">:</span><span class="n">samplefits</span><span class="p">}</span>
    
    <span class="c"># write the output file.</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: writting output file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeStr</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">datatup</span><span class="p">,</span><span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">: finished.&quot;</span> <span class="o">%</span> <span class="n">timeStr</span><span class="p">())</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GRNASeq 1.9 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Nick Schurch.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>